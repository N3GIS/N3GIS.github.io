/*!
 * LMV v7.105.0
 *
 * Copyright 2025 Autodesk, Inc.
 * All rights reserved.
 *
 * This computer source code and related instructions and comments are the
 * unpublished confidential and proprietary information of Autodesk, Inc.
 * and are protected under Federal copyright and state trade secret law.
 * They may not be disclosed to, copied or used by any third party without
 * the prior written consent of Autodesk, Inc.
 *
 * Autodesk Viewer SDK Usage Limitations:
 *
 * The Autodesk Viewer SDK JavaScript must be delivered from an
 * Autodesk-hosted URL.
 */(()=>{var t={4461:(t,e,i)=>{"use strict";i.d(e,{A:()=>a});var s=i(1354),o=i.n(s),n=i(6314),r=i.n(n)()(o());r.push([t.id,'.adsk-viewing-viewer .autodesk-markups-extension-core-make-me-bigger:after{content:"";position:absolute;top:-15px;bottom:-15px;left:-15px;right:-15px}.adsk-viewing-viewer .autodesk-markups-extension-core-make-me-bigger.rotation-bridge:after{top:0;bottom:0px}.adsk-viewing-viewer .selector-box{position:absolute;border:1px dashed #0696d7;background:rgba(6,150,215,.05);z-index:1;cursor:move;box-sizing:border-box}.adsk-viewing-viewer .selector-drag-point,.adsk-viewing-viewer .selector-rotate-point{position:absolute;height:8px;width:8px;border-radius:8px;background:#fff;border-color:rgba(107,120,127,.7);border-width:1px;border-style:solid}.adsk-viewing-viewer .selector-rotate-point{top:calc(100% + 22px);left:calc(50% + 1px);transform:translate3d(-50%, 0px, 0px)}.adsk-viewing-viewer .selector-drag-point.selected,.adsk-viewing-viewer .selector-rotate-point.selected:not(.rotation-bridge){background:#0696d7;border-color:#0696d7}.adsk-viewing-viewer .rotation-bridge{position:absolute;background-color:rgba(0,0,0,0);height:30px;width:0px;top:100%;left:calc(50% + 1px);border:unset;border-left:1px dashed #0696d7}.adsk-viewing-viewer .selector-drag-point.sdp-handle-n{top:-6px;left:calc(50% - 4px);position:relative}.adsk-viewing-viewer .selector-drag-point.sdp-handle-s{top:calc(100% - 14px);left:calc(50% - 4px);position:relative}.adsk-viewing-viewer .selector-drag-point.sdp-handle-w{left:-6px;top:50%;transform:translate3d(0, -50%, 0)}.adsk-viewing-viewer .selector-drag-point.sdp-handle-e{right:-6px;top:50%;transform:translate3d(0, -50%, 0)}.adsk-viewing-viewer .selector-drag-point.sdp-handle-nw{top:-6px;left:-6px}.adsk-viewing-viewer .selector-drag-point.sdp-handle-ne{top:-6px;right:-6px}.adsk-viewing-viewer .selector-drag-point.sdp-handle-sw{bottom:-6px;left:-6px}.adsk-viewing-viewer .selector-drag-point.sdp-handle-se{bottom:-6px;right:-6px}',"",{version:3,sources:["webpack://./extensions/Markup/core/Markups.css"],names:[],mappings:"AAAA,2EAA2E,UAAU,CAAC,iBAAiB,CAAC,SAAS,CAAC,YAAY,CAAC,UAAU,CAAC,WAAW,CAAC,2FAA2F,KAAK,CAAC,UAAU,CAAC,mCAAmC,iBAAiB,CAAC,yBAAyB,CAAC,8BAA8B,CAAC,SAAS,CAAC,WAAW,CAAC,qBAAqB,CAAC,sFAAsF,iBAAiB,CAAC,UAAU,CAAC,SAAS,CAAC,iBAAiB,CAAC,eAAe,CAAC,iCAAiC,CAAC,gBAAgB,CAAC,kBAAkB,CAAC,4CAA4C,qBAAqB,CAAC,oBAAoB,CAAC,qCAAqC,CAAC,8HAA8H,kBAAkB,CAAC,oBAAoB,CAAC,sCAAsC,iBAAiB,CAAC,8BAA8B,CAAC,WAAW,CAAC,SAAS,CAAC,QAAQ,CAAC,oBAAoB,CAAC,YAAY,CAAC,8BAA8B,CAAC,uDAAuD,QAAQ,CAAC,oBAAoB,CAAC,iBAAiB,CAAC,uDAAuD,qBAAqB,CAAC,oBAAoB,CAAC,iBAAiB,CAAC,uDAAuD,SAAS,CAAC,OAAO,CAAC,iCAAiC,CAAC,uDAAuD,UAAU,CAAC,OAAO,CAAC,iCAAiC,CAAC,wDAAwD,QAAQ,CAAC,SAAS,CAAC,wDAAwD,QAAQ,CAAC,UAAU,CAAC,wDAAwD,WAAW,CAAC,SAAS,CAAC,wDAAwD,WAAW,CAAC,UAAU",sourcesContent:['.adsk-viewing-viewer .autodesk-markups-extension-core-make-me-bigger:after{content:"";position:absolute;top:-15px;bottom:-15px;left:-15px;right:-15px}.adsk-viewing-viewer .autodesk-markups-extension-core-make-me-bigger.rotation-bridge:after{top:0;bottom:0px}.adsk-viewing-viewer .selector-box{position:absolute;border:1px dashed #0696d7;background:rgba(6,150,215,.05);z-index:1;cursor:move;box-sizing:border-box}.adsk-viewing-viewer .selector-drag-point,.adsk-viewing-viewer .selector-rotate-point{position:absolute;height:8px;width:8px;border-radius:8px;background:#fff;border-color:rgba(107,120,127,.7);border-width:1px;border-style:solid}.adsk-viewing-viewer .selector-rotate-point{top:calc(100% + 22px);left:calc(50% + 1px);transform:translate3d(-50%, 0px, 0px)}.adsk-viewing-viewer .selector-drag-point.selected,.adsk-viewing-viewer .selector-rotate-point.selected:not(.rotation-bridge){background:#0696d7;border-color:#0696d7}.adsk-viewing-viewer .rotation-bridge{position:absolute;background-color:rgba(0,0,0,0);height:30px;width:0px;top:100%;left:calc(50% + 1px);border:unset;border-left:1px dashed #0696d7}.adsk-viewing-viewer .selector-drag-point.sdp-handle-n{top:-6px;left:calc(50% - 4px);position:relative}.adsk-viewing-viewer .selector-drag-point.sdp-handle-s{top:calc(100% - 14px);left:calc(50% - 4px);position:relative}.adsk-viewing-viewer .selector-drag-point.sdp-handle-w{left:-6px;top:50%;transform:translate3d(0, -50%, 0)}.adsk-viewing-viewer .selector-drag-point.sdp-handle-e{right:-6px;top:50%;transform:translate3d(0, -50%, 0)}.adsk-viewing-viewer .selector-drag-point.sdp-handle-nw{top:-6px;left:-6px}.adsk-viewing-viewer .selector-drag-point.sdp-handle-ne{top:-6px;right:-6px}.adsk-viewing-viewer .selector-drag-point.sdp-handle-sw{bottom:-6px;left:-6px}.adsk-viewing-viewer .selector-drag-point.sdp-handle-se{bottom:-6px;right:-6px}'],sourceRoot:""}]);const a=r},4674:(t,e,i)=>{"use strict";i.d(e,{A:()=>a});var s=i(1354),o=i.n(s),n=i(6314),r=i.n(n)()(o());r.push([t.id,'.adsk-icon-markup:before{content:"a"}.lmv-markup-gui-toolbar{position:absolute;top:0;margin:5px 5px;color:#000}.lmv-markup-gui-toolbar-content>*{margin:0 2px}.lmv-markup-gui-style-options{display:inline-block}',"",{version:3,sources:["webpack://./extensions/Markup/gui/MarkupsGui.css"],names:[],mappings:"AAAA,yBAAyB,WAAW,CAAC,wBAAwB,iBAAiB,CAAC,KAAK,CAAC,cAAc,CAAC,UAAU,CAAC,kCAAkC,YAAY,CAAC,8BAA8B,oBAAoB",sourcesContent:['.adsk-icon-markup:before{content:"a"}.lmv-markup-gui-toolbar{position:absolute;top:0;margin:5px 5px;color:#000}.lmv-markup-gui-toolbar-content>*{margin:0 2px}.lmv-markup-gui-style-options{display:inline-block}'],sourceRoot:""}]);const a=r},6314:t=>{"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var i="",s=void 0!==e[5];return e[4]&&(i+="@supports (".concat(e[4],") {")),e[2]&&(i+="@media ".concat(e[2]," {")),s&&(i+="@layer".concat(e[5].length>0?" ".concat(e[5]):""," {")),i+=t(e),s&&(i+="}"),e[2]&&(i+="}"),e[4]&&(i+="}"),i})).join("")},e.i=function(t,i,s,o,n){"string"==typeof t&&(t=[[null,t,void 0]]);var r={};if(s)for(var a=0;a<this.length;a++){var h=this[a][0];null!=h&&(r[h]=!0)}for(var l=0;l<t.length;l++){var u=[].concat(t[l]);s&&r[u[0]]||(void 0!==n&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=n),i&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=i):u[2]=i),o&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=o):u[4]="".concat(o)),e.push(u))}},e}},1354:t=>{"use strict";t.exports=function(t){var e=t[1],i=t[3];if(!i)return e;if("function"==typeof btoa){var s=btoa(unescape(encodeURIComponent(JSON.stringify(i)))),o="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),n="/*# ".concat(o," */");return[e].concat([n]).join("\n")}return[e].join("\n")}},5072:t=>{"use strict";var e=[];function i(t){for(var i=-1,s=0;s<e.length;s++)if(e[s].identifier===t){i=s;break}return i}function s(t,s){for(var n={},r=[],a=0;a<t.length;a++){var h=t[a],l=s.base?h[0]+s.base:h[0],u=n[l]||0,d="".concat(l," ").concat(u);n[l]=u+1;var c=i(d),p={css:h[1],media:h[2],sourceMap:h[3],supports:h[4],layer:h[5]};if(-1!==c)e[c].references++,e[c].updater(p);else{var y=o(p,s);s.byIndex=a,e.splice(a,0,{identifier:d,updater:y,references:1})}r.push(d)}return r}function o(t,e){var i=e.domAPI(e);i.update(t);return function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap&&e.supports===t.supports&&e.layer===t.layer)return;i.update(t=e)}else i.remove()}}t.exports=function(t,o){var n=s(t=t||[],o=o||{});return function(t){t=t||[];for(var r=0;r<n.length;r++){var a=i(n[r]);e[a].references--}for(var h=s(t,o),l=0;l<n.length;l++){var u=i(n[l]);0===e[u].references&&(e[u].updater(),e.splice(u,1))}n=h}}},7659:t=>{"use strict";var e={};t.exports=function(t,i){var s=function(t){if(void 0===e[t]){var i=document.querySelector(t);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(t){i=null}e[t]=i}return e[t]}(t);if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(i)}},540:t=>{"use strict";t.exports=function(t){var e=document.createElement("style");return t.setAttributes(e,t.attributes),t.insert(e,t.options),e}},5056:(t,e,i)=>{"use strict";t.exports=function(t){var e=i.nc;e&&t.setAttribute("nonce",e)}},7825:t=>{"use strict";t.exports=function(t){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var e=t.insertStyleElement(t);return{update:function(i){!function(t,e,i){var s="";i.supports&&(s+="@supports (".concat(i.supports,") {")),i.media&&(s+="@media ".concat(i.media," {"));var o=void 0!==i.layer;o&&(s+="@layer".concat(i.layer.length>0?" ".concat(i.layer):""," {")),s+=i.css,o&&(s+="}"),i.media&&(s+="}"),i.supports&&(s+="}");var n=i.sourceMap;n&&"undefined"!=typeof btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(n))))," */")),e.styleTagTransform(s,t,e.options)}(e,t,i)},remove:function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(e)}}}},1113:t=>{"use strict";t.exports=function(t,e){if(e.styleSheet)e.styleSheet.cssText=t;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(t))}}}},e={};function i(s){var o=e[s];if(void 0!==o)return o.exports;var n=e[s]={id:s,exports:{}};return t[s](n,n.exports,i),n.exports}i.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return i.d(e,{a:e}),e},i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.nc=void 0;var s={};(()=>{"use strict";i.r(s),i.d(s,{Core:()=>Qo,Gui:()=>sn});var t={};i.r(t),i.d(t,{MARKUP_TYPE_ARROW:()=>r,MARKUP_TYPE_CALLOUT:()=>g,MARKUP_TYPE_CIRCLE:()=>l,MARKUP_TYPE_CLOUD:()=>u,MARKUP_TYPE_DIMENSION:()=>v,MARKUP_TYPE_FREEHAND:()=>d,MARKUP_TYPE_HIGHLIGHT:()=>c,MARKUP_TYPE_POLYCLOUD:()=>y,MARKUP_TYPE_POLYLINE:()=>p,MARKUP_TYPE_RECTANGLE:()=>h,MARKUP_TYPE_STAMP:()=>f,MARKUP_TYPE_TEXT:()=>a});var e={};i.r(e),i.d(e,{cloneStyle:()=>w,copyStyle:()=>M,createStyle:()=>m,getStyleDefaultValues:()=>E,isStyleEqual:()=>k});var o={};i.r(o),i.d(o,{EVENT_EDITFRAME_EDITION_END:()=>B,EVENT_EDITFRAME_EDITION_START:()=>R,EVENT_EDITMODE_CHANGED:()=>A,EVENT_EDITMODE_CREATION_BEGIN:()=>H,EVENT_EDITMODE_CREATION_END:()=>L,EVENT_EDITMODE_ENTER:()=>b,EVENT_EDITMODE_LEAVE:()=>T,EVENT_HISTORY_CHANGED:()=>D,EVENT_MARKUP_CANCEL_EDITION:()=>z,EVENT_MARKUP_DELETE_EDITION:()=>P,EVENT_MARKUP_DESELECT:()=>N,EVENT_MARKUP_DRAGGING:()=>S,EVENT_MARKUP_ENTER_EDITION:()=>I,EVENT_MARKUP_SELECTED:()=>C});var n={};i.r(n),i.d(n,{EDIT_FRAME_DEFAULT_MARGIN:()=>Di,MARKUP_DEFAULT_FONT_WIDTH_IN_PIXELS:()=>zi,MARKUP_DEFAULT_HITAREAS_MARGIN_IN_PIXELS:()=>Pi,MARKUP_DEFAULT_STROKE_WIDTH_IN_PIXELS:()=>Ii,addMarkupMetadata:()=>Ki,addRuleToStyleSheet:()=>ws,addSvgMetadata:()=>Wi,addTraitEventDispatcher:()=>Qi,areMarkupsPointsInClientRange:()=>ls,checkLineSegment:()=>ms,checkPolygon:()=>Ms,clientToViewport:()=>is,clientToWorld:()=>es,composeRGBAString:()=>xs,createArcTo:()=>As,createEllipsePath:()=>bs,createMarkupFromSVG:()=>fs,createMarkupGroupSvg:()=>Ri,createMarkupPathSvg:()=>Bi,createMarkupTextSvg:()=>_i,createRectanglePath:()=>Ts,createStyleSheet:()=>ks,createSvgElement:()=>Li,degreesToRadians:()=>as,dismissLmvHudMessage:()=>gs,getStrokeWidth:()=>vs,getUniqueID:()=>qi,hideLmvPanels:()=>cs,hideLmvToolsAndPanels:()=>ys,hideLmvUi:()=>us,isTouchDevice:()=>Hi,measureTextLines:()=>Es,metersToModel:()=>ns,radiansToDegrees:()=>rs,removeAllMetadata:()=>Yi,removeTraitEventDispatcher:()=>Ji,renderToCanvas:()=>Cs,restoreLmvUi:()=>ds,setAttributeToMarkupSvg:()=>Vi,setMarkupTextSvgTransform:()=>Fi,setSvgParentAttributes:()=>Ni,showLmvToolsAndPanels:()=>ps,sign:()=>hs,simplify:()=>Ss,stringToSvgNode:()=>Zi,svgNodeToString:()=>$i,transferChildNodes:()=>Xi,updateMarkupPathSvgHitarea:()=>Oi,updateMarkupTextSvgBackground:()=>ji,updateMarkupTextSvgClipper:()=>Gi,updateMarkupTextSvgHitarea:()=>Ui,viewportToClient:()=>ss,worldToClient:()=>ts,worldToViewport:()=>os});const r="arrow",a="label",h="rectangle",l="ellipse",u="cloud",d="freehand",c="highlight",p="polyline",y="polycloud",g="callout",v="dimension",f="stamp";function x(t,e,i){this.type=e,this.editor=t,this.targetId=i,this.addToHistory=!0,this.selectOnExecution=!0}x.prototype.execute=function(){this.editor.actionManager.execute(this)},x.prototype.redo=function(){},x.prototype.undo=function(){},x.prototype.merge=function(t){return!1},x.prototype.isIdentity=function(){return!1};var m=function(t,e){for(var i={},s=0;s<t.length;++s)i[t[s]]=null;var o=E(i,e);for(let e=0;e<t.length;++e){var n=t[e];i[n]=o[n].values[o[n].default].value}return i},M=function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},k=function(t,e){for(var i in e)if(Object.prototype.hasOwnProperty.call(t,i)&&t[i]!==e[i])return!1;return!0},w=function(t){var e={};for(var i in t)e[i]=t[i];return e},E=function(t,e){function i(t){return{values:[{name:"Thin",value:t/2},{name:"Normal",value:t},{name:"Thick",value:4*t}],default:1}}function s(t){return{values:[{name:"100%",value:1},{name:"75%",value:.75},{name:"50%",value:.5},{name:"25%",value:.25},{name:"0%",value:0}],default:t?4:0}}var o,n=w(t),r=e.getStrokeWidth(),a=e.getFontWidth();for(var h in n)switch(h){case"stroke-width":n[h]={values:[{name:"Thin",value:(o=r)/3},{name:"Normal",value:o},{name:"Thick",value:3*o},{name:"Very Thick",value:9*o}],default:1};break;case"stroke-linejoin":n[h]={values:[{name:"Miter",value:"miter"},{name:"Round",value:"round"},{name:"Bevel",value:"bevel"}],default:0};break;case"font-size":n[h]=i(a);break;case"font-family":n[h]={values:[{name:"Arial",value:"Arial"},{name:"Arial Black",value:"Arial Black"},{name:"Arial Narrow",value:"Arial Narrow"},{name:"Century Gothic",value:"Century Gothic"},{name:"Courier New",value:"Courier New"},{name:"Georgia",value:"Georgia"},{name:"Impact",value:"Impact"},{name:"Lucida Console",value:"Lucida Console"},{name:"Tahoma",value:"Tahoma"},{name:"Verdana",value:"Verdana"}],default:0};break;case"font-style":n[h]={values:[{name:"Normal",value:"normal"},{name:"Italic",value:"italic"}],default:0};break;case"font-weight":n[h]={values:[{name:"Normal",value:"normal"},{name:"Bold",value:"bold"}],default:0};break;case"stroke-color":case"fill-color":n[h]={values:[{name:"red",value:"#ff0000"},{name:"green",value:"#00ff00"},{name:"blue",value:"#0000ff"},{name:"white",value:"#ffffff"},{name:"black",value:"#000000"},{name:"yellow",value:"#ffff00"}],default:0};break;case"stroke-opacity":{let t=!1;n[h]=s(t);break}case"fill-opacity":{let t=!0;n[h]=s(t);break}case"text-data":n[h]={values:[{name:"DefaultValue",value:'<svg height="100" width="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" stroke="black" stroke-width="3" fill="red" /></svg>'}],default:0}}return n};const A="EVENT_EDITMODE_CHANGED",b="EVENT_EDITMODE_ENTER",T="EVENT_EDITMODE_LEAVE",C="EVENT_MARKUP_SELECTED",S="EVENT_MARKUP_DRAGGING",I="EVENT_MARKUP_ENTER_EDITION",z="EVENT_MARKUP_CANCEL_EDITION",P="EVENT_MARKUP_DELETE_EDITION",D="EVENT_HISTORY_CHANGED",H="EVENT_EDITMODE_CREATION_BEGIN",L="EVENT_EDITMODE_CREATION_END",N="EVENT_MARKUP_DESELECT",R="EVENT_EDITFRAME_EDITION_START",B="EVENT_EDITFRAME_EDITION_END";var V=Autodesk.Viewing;function O(t,e,i){this.id=t,this.type="",this.editor=e,this.viewer=e.viewer,this.setGlobalManager(this.viewer.globalManager),this.position={x:0,y:0},this.size={x:0,y:0},this.rotation=0,this.style=m(i,this.editor),this.style=M(e.getDefaultStyle(),this.style),this.highlightColor="#0696D7",this.constraintWidth=!1,this.constraintHeight=!1,this.constraintRotation=!1,this.minWidth=-1e4,this.minHeight=-1e4,this.highlighted=!1,this.selected=!1,this.checkLineSegment=ms.bind(this),this.checkPolygon=Ms.bind(this),this.renderToCanvasX=Cs.bind(this),Qi(this)}V.GlobalManagerMixin.call(O.prototype);var _=O.prototype;function F(t,e,i){x.call(this,t,"SET-STYLE",e.id),this.newStyle=w(i),this.oldStyle=e.getStyle()}_.destroy=function(){this.unselect(),this.setParent(null)},_.setParent=function(t){var e=this.shape;e.parentNode&&e.parentNode.removeChild(e),t&&t.appendChild(e)},_.clone=function(){var t=Object.create(this.__proto__),e=this.getCloneOverrides();for(var i in this)if(Object.prototype.hasOwnProperty.call(this,i)){var s=this[i];Object.prototype.hasOwnProperty.call(e,i)?t[i]=e[i]:null!=s?s.clone instanceof Function?t[i]=s.clone():s instanceof Function?t[i]=s.bind(t):s.nodeType?t[i]=s.cloneNode(!0):s instanceof V.GlobalManager?(V.GlobalManagerMixin.call(t),t.setGlobalManager(s)):t[i]=s instanceof Object?JSON.parse(JSON.stringify(s)):s:t[i]=s}return this.cloneShape(t),t},_.cloneShape=function(t){t.shape.markup=t.shape.childNodes.item(0),t.shape.hitarea=t.shape.childNodes.item(1),t.bindDomEvents()},_.getCloneOverrides=function(){return{viewer:this.viewer,editor:this.editor,hammer:null,listeners:{}}},_.select=function(){this.selected||(this.selected=!0,this.highlighted=!1,this.updateStyle(),this.dispatchEvent({type:C,markup:this}))},_.unselect=function(){this.selected=!1},_.highlight=function(t){this.interactionsDisabled||(this.highlighted=t,this.updateStyle())},_.getStyle=function(){return w(this.style)},_.setStyle=function(t){M(t,this.style),this.updateStyle()},_.updateStyle=function(){},_.edit=function(){this.dispatchEvent({type:I,markup:this})},_.cancel=function(){this.dispatchEvent({type:z,markup:this})},_.deleteMarkup=function(){this.dispatchEvent({type:P,markup:this})},_.getEditMode=function(){return console.warn("EditMode of markup type"+this.type+" not defined."),null},_.getClientPosition=function(){var t=this.position;return this.editor.positionFromMarkupsToClient(t.x,t.y)},_.getClientSize=function(){var t=this.size;return this.editor.sizeFromMarkupsToClient(t.x,t.y)},_.getBoundingRect=function(){var t=this.rotation;0!==t&&this.setRotation(0);var e=this.viewer.impl.getCanvasBoundingClientRect(),i=this.shape.markup.getBoundingClientRect(),s=i.top-e.top,o=this.style["stroke-width"]||0,n=this.editor.sizeFromMarkupsToClient(o,0).x;return 0!==t&&this.setRotation(t),{x:i.left-e.left-n,y:s-n,width:i.width+2*n,height:i.height+2*n}},_.setRotation=function(t){this.rotation=t,this.updateStyle()},_.getRotation=function(){return this.rotation},_.setPosition=function(t,e){this.position.x=t,this.position.y=e,this.updateStyle()},_.setSize=function(t,e,i){this.position.x=t.x,this.position.y=t.y,this.size.x=e,this.size.y=i,this.updateStyle()},_.isWidthConstrained=function(){return this.constraintWidth},_.isHeightConstrained=function(){return this.constraintHeight},_.isRotationConstrained=function(){return this.constraintRotation},_.setMinWidth=function(t){this.minWidth=t},_.setMinHeight=function(t){this.minHeight=t},_.getMinWidth=function(){return this.minWidth},_.getMinHeight=function(){return this.minHeight},_.disableInteractions=function(t){this.interactionsDisabled=t},_.setStrokeWidth=function(t){},_.constrainsToBounds=function(t){},_.onMouseDown=function(t){this.interactionsDisabled||(this.select(),this.editor.editFrame.startDrag(t))},_.generatePoint3d=function(t){var e=this.viewer,i=this.generateBoundingPolygon(),s=this;function o(i,o){var n=s.checkLineSegment(i.x,i.y,o.x,o.y,t),r=n&&e.clientToWorld(n.x,n.y);return r&&r.point}var n=i.xVertices,r=i.yVertices,a=new THREE.Vector2(n[0]+n[1],r[0]+r[1]).multiplyScalar(.5),h=new THREE.Vector2(n[0]+n[3],r[0]+r[3]).multiplyScalar(.5),l=new THREE.Vector2(n[2]+n[1],r[2]+r[1]).multiplyScalar(.5),u=new THREE.Vector2(n[2]+n[3],r[2]+r[3]).multiplyScalar(.5),d=h.clone().add(l).multiplyScalar(.5);return o(d,l)||o(d,h)||o(d,a)||o(d,u)||function(i){var o=s.checkPolygon(i,t),n=o&&e.clientToWorld(o.x,o.y);return n&&n.point}(i)},_.generateBoundingBox=function(){for(var t={min:{x:0,y:0},max:{x:0,y:0}},e=this.generateBoundingPolygon(),i=e.vertexCount,s=e.xVertices,o=e.yVertices,n=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,l=0;l<i;++l){var u=s[l],d=o[l];n=Math.min(n,u),r=Math.min(r,d),a=Math.max(a,u),h=Math.max(h,d)}return t.min.x=n,t.min.y=r,t.max.x=a,t.max.y=h,t},_.generateBoundingPolygon=function(){var t=this.getClientPosition(),e=this.getClientSize();e.x*=.5,e.y*=.5;var i=new THREE.Vector3(-e.x,-e.y).add(t),s=new THREE.Vector3(e.x,-e.y).add(t),o=new THREE.Vector3(e.x,e.y).add(t),n=new THREE.Vector3(-e.x,e.y).add(t);if(0!==this.rotation){var r=(new THREE.Matrix4).makeTranslation(-t.x,-t.y,0),a=(new THREE.Matrix4).makeRotationZ(this.rotation),h=(new THREE.Matrix4).makeTranslation(t.x,t.y,0).multiply(a).multiply(r);i.applyMatrix4(h),s.applyMatrix4(h),o.applyMatrix4(h),n.applyMatrix4(h)}return{vertexCount:4,xVertices:new Float32Array([i.x,s.x,o.x,n.x]),yVertices:new Float32Array([i.y,s.y,o.y,n.y])}},_.setMetadata=function(){return null},_.setMouseDisabledWhenTouching=function(t){if(t.isFirst)this.shape.removeEventListener("mousedown",this.onMouseDownBinded);else if(t.isFinal){var e=this;setTimeout((function(){e.shape.addEventListener("mousedown",e.onMouseDownBinded)}),10)}},_.bindDomEvents=function(){Hi()&&(this.hammer=new V.Hammer.Manager(this.shape,{recognizers:[V.GestureRecognizers.singletap],handlePointerEventMouse:!1,inputClass:V.Hammer.TouchInput}),this.onSingleTapBinded=function(t){this.onMouseDown(t)}.bind(this),this.onHammerInputBinded=function(t){this.setMouseDisabledWhenTouching(t)}.bind(this),this.hammer.on("singletap",this.onSingleTapBinded),this.hammer.on("hammer.input",this.onHammerInputBinded)),this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseOutBinded=function(){this.highlight(!1)}.bind(this),this.onMouseOverBinded=function(){this.highlight(!0)}.bind(this),this.shape.addEventListener("mousedown",this.onMouseDownBinded),this.shape.addEventListener("mouseout",this.onMouseOutBinded),this.shape.addEventListener("mouseover",this.onMouseOverBinded)},_.renderToCanvas=function(t,e,i,s,o){this.renderToCanvasX(this.shape,e,i,s,t,o)},_.getPath=function(){},_.getTransform=function(){return["translate(",this.position.x,",",this.position.y,")","rotate(",rs(-this.rotation),")"].join(" ")},F.prototype=Object.create(x.prototype),F.prototype.constructor=F;var U=F.prototype;U.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.setStyle(this.newStyle)},U.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.setStyle(this.oldStyle)};function j(t,e,i){this.editor=t,this.viewer=t.viewer,this.setGlobalManager(this.viewer.globalManager),this.type=e,this.selectedMarkup=null,this.dragging=!1,this.draggingAnnotationIniPosition=null,this.draggingMouseIniPosition=new THREE.Vector2,this.initialX=0,this.initialY=0,this.minSize=9,this.creating=!1,this.size={x:0,y:0},this.style=m(i,this.editor),this.style=M(t.getDefaultStyle(),this.style),this.CREATION_METHOD_DRAG="CREATION_METHOD_DRAG",this.CREATION_METHOD_CLICK="CREATION_METHOD_CLICK",this.CREATION_METHOD_CLICKS="CREATION_METHOD_CLICKS",this.creationMethod=this.CREATION_METHOD_DRAG,Qi(this)}Autodesk.Viewing.GlobalManagerMixin.call(j.prototype);var G=j.prototype;function W(t,e){x.call(this,t,"DELETE-ARROW",e.id),this.createArrow=new tt(t,e.id,e.tail,e.head,e.getStyle())}G.destroy=function(){this.unselect(),Ji(this)},G.unselect=function(){var t=!1,e=this.selectedMarkup,i=null;e&&(i=e.id,e.unselect(),this.selectedMarkup=null,t=!0),this.editor.editFrame.setMarkup(null),t&&this.dispatchEvent({type:N,markupId:i})},G.creationBegin=function(){this.creating||(this.creating=!0,this.dispatchEvent({type:H}))},G.creationEnd=function(t){return!!this.creating&&(this.creationMethod!==this.CREATION_METHOD_CLICK&&(this.selectedMarkup&&!this.isMinSizeValid()?(this.creationCancel(),t=!0):(this.creationMethod===this.CREATION_METHOD_DRAG&&this.finishDragging(),this.selectedMarkup&&(this.editor.closeActionGroup(),this.selectedMarkup=null))),this.creating=!1,this.dispatchEvent({type:L,creationCancelled:!!t}),!0)},G.creationCancel=function(){this.editor.cancelActionGroup(),this.creationEnd(!0),this.selectedMarkup=null},G.setStyle=function(t){this.style=t;var e=this.selectedMarkup;e&&new F(this.editor,e,t).execute()},G.getStyle=function(){return this.style},G.setSelection=function(t){this.selectedMarkup!==t&&(this.unselect(),t&&t.select()),this.selectedMarkup=t;var e=this.editor;t&&e.bringToFront(t),this.isTextInputHelperActive()&&e.editFrame.markup?this.textInputHelper.setEditFrame():this.creating||e.editFrame.setMarkup(t)},G.getSelection=function(){return this.selectedMarkup},G.deleteMarkup=function(t,e){return!1},G.isMinSizeValid=function(){if(0!==this.minSize){var t=this.editor.sizeFromMarkupsToClient(this.size.x,this.size.y);return t.x*t.x+t.y*t.y>=this.minSize*this.minSize}return!0},G.startDragging=function(){var t=this.selectedMarkup,e=this.editor.getMousePosition();t&&(this.dragging=!0,this.draggingAnnotationIniPosition=t.getClientPosition(),this.draggingMouseIniPosition.set(e.x,e.y))},G.finishDragging=function(){var t=this.dragging,e=this.selectedMarkup;this.dragging=!1,e&&t&&e.finishDragging()},G.getFinalMouseDraggingPosition=function(){var t=this.editor,e=t.getBounds(),i=t.getMousePosition(),s=this.initialX,o=this.initialY,n=Math.min(Math.max(e.x,i.x),e.x+e.width),r=Math.min(Math.max(e.y,i.y),e.y+e.height);if(n==s&&r==o&&(n++,r++),t.input.makeSameXY){var a=Math.abs(n-s),h=Math.abs(r-o),l=Math.max(a,h);n=s+l*hs(n-s),r=o+l*hs(r-o)}return{x:n,y:r}},G.notifyAllowNavigation=function(t){},G.onMouseMove=function(t){return!(!this.selectedMarkup||!this.creating)},G.onMouseDown=function(){},G.onMouseUp=function(t){return this.creationMethod===this.CREATION_METHOD_DRAG&&this.creationEnd()},G.onMouseDoubleClick=function(t){this.creationMethod===this.CREATION_METHOD_CLICKS&&this.creationEnd()},G.onSave=function(){this.creating&&this.creationCancel()},G.getDraggingPosition=function(){var t=this.editor.getMousePosition(),e=t.x-this.draggingMouseIniPosition.x,i=t.y-this.draggingMouseIniPosition.y;return{x:this.draggingAnnotationIniPosition.x+e,y:this.draggingAnnotationIniPosition.y+i}},G.isInsideBounds=function(t,e,i){return t>=i.x&&t<=i.x+i.width&&e>=i.y&&e<=i.y+i.height},G.useWithSnapping=function(){return this.viewer.model.is2d()},G.isTextInputHelperActive=function(){return this.textInputHelper&&this.textInputHelper.isActive()},W.prototype=Object.create(x.prototype),W.prototype.constructor=W;var K=W.prototype;function Y(t,e,i,s){x.call(this,t,"SET-ARROW",e.id),this.newHead={x:i.x,y:i.y},this.newTail={x:s.x,y:s.y},this.oldHead={x:e.head.x,y:e.head.y},this.oldTail={x:e.tail.x,y:e.tail.y}}K.redo=function(){this.createArrow.undo()},K.undo=function(){this.createArrow.redo()},Y.prototype=Object.create(x.prototype),Y.prototype.constructor=Y;var X=Y.prototype;X.redo=function(){this.applyState(this.targetId,this.newHead,this.newTail)},X.undo=function(){this.applyState(this.targetId,this.oldHead,this.oldTail)},X.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.newHead=t.newHead,this.newTail=t.newTail,!0)},X.applyState=function(t,e,i){var s=this.editor.getMarkup(t);if(s){var o=1e-4;(Math.abs(s.head.x-e.x)>=o||Math.abs(s.head.y-e.y)>=o||Math.abs(s.tail.x-i.x)>=o||Math.abs(s.tail.y-i.y)>=o)&&s.set(e.x,e.y,i.x,i.y)}},X.isIdentity=function(){return this.newHead.x===this.oldHead.x&&this.newHead.y===this.oldHead.y&&this.newTail.x===this.oldTail.x&&this.newTail.y===this.oldTail.y};var q=Autodesk.Viewing.MeasureCommon;function $(t){j.call(this,t,r,["stroke-width","stroke-color","stroke-opacity"])}$.prototype=Object.create(j.prototype),$.prototype.constructor=$;var Z=$.prototype;function Q(t,e){O.call(this,t,e,["stroke-width","stroke-color","stroke-opacity"]),this.addMarkupMetadata=Ki.bind(this),this.checkLineSegment=ms.bind(this),this.type=r,this.constraintHeight=!0,this.head=new THREE.Vector3,this.tail=new THREE.Vector3,this.size.y=3*this.style["stroke-width"],this.shape=Bi(),this.bindDomEvents()}Z.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type==this.type){var i=new W(this.editor,t);return i.addToHistory=!e,i.execute(),!0}return!1},Z.onMouseDown=function(){if(j.prototype.onMouseDown.call(this),!this.selectedMarkup){var t=this.editor,e=t.getMousePosition();if(this.initialX=e.x,this.initialY=e.y,this.size.x=0,this.size.y=0,this.lineSnapped=null,t.snapper){var i=t.snapper.getGeometryType();i!==q.SnapType.SNAP_VERTEX&&i!==q.SnapType.SNAP_EDGE&&i!==q.SnapType.SNAP_MIDPOINT&&i!==q.SnapType.SNAP_CIRCLE_CENTER||(this.lineSnapped=t.snapper.getEdge())}var s=3.5*this.style["stroke-width"],o=this.head=t.positionFromClientToMarkups(this.initialX,this.initialY),n={x:o.x+Math.cos(.25*Math.PI)*s,y:o.y+Math.sin(.25*-Math.PI)*s},r=function(t,e,i,s){this.isInsideBounds(e.x,e.y,s)||(e.y=t.y+Math.sin(.25*Math.PI)*i,this.isInsideBounds(e.x,e.y,s)||(e.x=t.x+Math.cos(.25*-Math.PI)*i,this.isInsideBounds(e.x,e.y,s)||(e.y=t.y+Math.sin(.25*-Math.PI)*i)))}.bind(this);r(o,n,s,t.getBounds()),t.beginActionGroup();var a=new THREE.Vector2(n.x-o.x,n.y-o.y);a.lengthSq()<s*s&&(a=a.normalize().multiplyScalar(s),n.x=o.x+a.x,n.y=o.y+a.y);var h=t.getId();new tt(t,h,o,n,this.style).execute(),this.selectedMarkup=t.getMarkup(h),this.creationBegin()}},Z.onMouseMove=function(t){if(!j.prototype.onMouseMove.call(this,t))return!1;var e=this.selectedMarkup,i=this.editor,s=this.getFinalMouseDraggingPosition(),o=this.initialX,n=this.initialY;if(i.snapper&&!i.snapper.isSnapped()&&this.lineSnapped){var r=i.project(this.lineSnapped.vertices[0]),a=i.project(this.lineSnapped.vertices[1]),h=new THREE.Vector3(s.x,s.y,r.z),l=q.nearestPointInPointToLine(h,r,a),u=-(r.x-a.x)/(r.y-a.y),d=o+1,c=u*d+(n-u*o),p=new THREE.Vector3(d,c,r.z),y=new THREE.Vector3(o,n,r.z),g=q.nearestPointInPointToLine(h,y,p);l.distanceTo(h)<=20?(s.x=l.x,s.y=l.y):g.distanceTo(h)<=20&&(s.x=g.x,s.y=g.y)}var v=this.head,f=i.positionFromClientToMarkups(s.x,s.y),x=new THREE.Vector2(f.x-v.x,f.y-v.y),m=3.5*e.style["stroke-width"];return x.lengthSq()<m*m&&(x=x.normalize().multiplyScalar(m),f.x=v.x+x.x,f.y=v.y+x.y),this.size=i.sizeFromClientToMarkups(s.x-o,s.y-n),new Y(i,e,v,f).execute(),!0},Q.prototype=Object.create(O.prototype),Q.prototype.constructor=Q;var J=Q.prototype;function tt(t,e,i,s,o){x.call(this,t,"CREATE-ARROW",e),this.selectOnExecution=!1,this.tail=s,this.head=i,this.style=w(o)}J.getEditMode=function(){return new $(this.editor)},J.set=function(t,e,i,s){var o=new THREE.Vector2(t,e),n=new THREE.Vector2(i,s),r=n.clone().sub(o).normalize();this.size.x=o.distanceTo(n),this.rotation=Math.acos(r.dot(new THREE.Vector2(1,0))),this.rotation=s>e?2*Math.PI-this.rotation:this.rotation;var a=this.head,h=this.tail;a.set(i,s,0),h.set(t,e,0),this.position.x=h.x+.5*(a.x-h.x),this.position.y=h.y+.5*(a.y-h.y),this.updateStyle()},J.setRotation=function(t){this.rotation=t;var e=Math.cos(-t),i=Math.sin(-t),s=new THREE.Vector2(e,i);s.multiplyScalar(.5*this.size.x);var o=new THREE.Vector2(this.position.x,this.position.y),n=o.clone().sub(s),r=o.clone().add(s);this.head.set(r.x,r.y,0),this.tail.set(n.x,n.y,0),this.updateStyle()},J.setSize=function(t,e,i){var s=Math.cos(-this.rotation),o=Math.sin(-this.rotation),n=new THREE.Vector2(s,o);n.multiplyScalar(.5*e);var r=new THREE.Vector2(t.x,t.y),a=r.clone().sub(n),h=r.clone().add(n);this.head.set(h.x,h.y,0),this.tail.set(a.x,a.y,0),this.position.x=t.x,this.position.y=t.y,this.size.x=e,this.updateStyle()},J.updateStyle=function(){var t=this.style,e=this.shape,i=t["stroke-width"],s=this.highlighted?this.highlightColor:xs(t["stroke-color"],t["stroke-opacity"]),o=this.getTransform();this.size.y=3*i,this.style["fill-color"]=t["stroke-color"],this.style["fill-opacity"]=t["stroke-opacity"],Vi(e,"d",this.getPath().join(" ")),Vi(e,"stroke-width",i),Vi(e,"stroke",s),Vi(e,"fill",s),Vi(e,"transform",o),Oi(e,this.editor)},J.setPosition=function(t,e){var i=this.head,s=this.tail,o=i.x-s.x,n=i.y-s.y,r=t+.5*o,a=e+.5*n;i.x=r,i.y=a,s.x=r-o,s.y=a-n,this.position.x=s.x+.5*(i.x-s.x),this.position.y=s.y+.5*(i.y-s.y),this.updateStyle()},J.generatePoint3d=function(t){var e=this.editor.positionFromMarkupsToClient(this.head.x,this.head.y),i=this.editor.positionFromMarkupsToClient(this.tail.x,this.tail.y),s=e.clone().sub(i).normalize(),o=this.checkLineSegment(e.x,e.y,e.x+200*s.x,e.y+200*s.y,t),n=o&&this.viewer.clientToWorld(o.x,o.y);return n&&n.point},J.setMetadata=function(){var t=w(this.style);return t.type=this.type,t.head=[this.head.x,this.head.y].join(" "),t.tail=[this.tail.x,this.tail.y].join(" "),t.rotation=String(this.rotation),this.addMarkupMetadata(this.shape,t)},J.getPath=function(){var t=this.size.x,e=this.size.y,i=e/3,s=this.style["stroke-width"],o=t-3*s,n=t-o,r=.3*s;return["M",.5*-t,.5*-e+i,"l",o,0,"l",-r,-i,"l",n+r,1.5*i,"l",-n-r,1.5*i,"l",r,-i,"l",-o,0,"z"]},tt.prototype=Object.create(x.prototype),tt.prototype.constructor=tt;var et=tt.prototype;et.redo=function(){var t=this.editor,e=new Q(this.targetId,t);t.addMarkup(e),e.set(this.head.x,this.head.y,this.tail.x,this.tail.y),e.setStyle(this.style)},et.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)};var it=function(t,e){x.call(this,t,"DELETE-RECTANGLE",e.id),this.createRectangle=new dt(t,e.id,e.position,e.size,e.rotation,e.getStyle())};(it.prototype=Object.create(x.prototype)).constructor=it;var st=it.prototype;function ot(t,e,i,s){x.call(this,t,"SET-RECTANGLE",e.id),this.newPosition={x:i.x,y:i.y},this.newSize={x:s.x,y:s.y},this.oldPosition={x:e.position.x,y:e.position.y},this.oldSize={x:e.size.x,y:e.size.y}}st.redo=function(){this.createRectangle.undo()},st.undo=function(){this.createRectangle.redo()},ot.prototype=Object.create(x.prototype),ot.prototype.constructor=ot;var nt=ot.prototype;nt.redo=function(){this.applyState(this.targetId,this.newPosition,this.newSize)},nt.undo=function(){this.applyState(this.targetId,this.oldPosition,this.oldSize)},nt.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.newPosition=t.newPosition,this.newSize=t.newSize,!0)},nt.applyState=function(t,e,i){var s=this.editor.getMarkup(t);if(s){var o=1e-4;(Math.abs(s.position.x-e.x)>o||Math.abs(s.size.y-i.y)>o||Math.abs(s.position.y-e.y)>o||Math.abs(s.size.y-i.y)>o)&&s.set(e,i)}},nt.isIdentity=function(){return this.newPosition.x===this.oldPosition.x&&this.newPosition.y===this.oldPosition.y&&this.newSize.x===this.oldSize.x&&this.newSize.y===this.oldSize.y};var rt=Autodesk.Viewing.MeasureCommon;function at(t){j.call(this,t,h,["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity"])}at.prototype=Object.create(j.prototype),at.prototype.constructor=at;var ht=at.prototype;function lt(t,e){O.call(this,t,e,["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity"]),this.addMarkupMetadata=Ki.bind(this),this.type=h,this.shape=Bi(),this.bindDomEvents()}ht.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type==this.type){var i=new it(this.editor,t);return i.addToHistory=!e,i.execute(),!0}return!1},ht.onMouseMove=function(t){if(!j.prototype.onMouseMove.call(this,t))return!1;var e,i,s=this.selectedMarkup,o=this.editor,n=this.getFinalMouseDraggingPosition(),r=o.clientToMarkups(n.x,n.y),a={x:(this.firstCorner.x+r.x)/2,y:(this.firstCorner.y+r.y)/2};if(o.snapper&&this.lineSnapped){var h=o.project(this.lineSnapped.vertices[0]),l=o.project(this.lineSnapped.vertices[1]),u=h.z;h=o.clientToMarkups(h.x,h.y),l=o.clientToMarkups(l.x,l.y),h=new THREE.Vector3(h.x,h.y,u),l=new THREE.Vector3(l.x,l.y,u);var d=new THREE.Vector3(r.x,r.y,u),c=rt.nearestPointInPointToLine(d,h,l);i=d.distanceTo(c);var p=-(h.x-l.x)/(h.y-l.y),y=this.firstCorner.y-p*this.firstCorner.x,g=this.firstCorner.x+1,v=p*g+y,f=new THREE.Vector3(g,v,u),x=new THREE.Vector3(this.firstCorner.x,this.firstCorner.y,u),m=rt.nearestPointInPointToLine(d,x,f);e=d.distanceTo(m)}else e=r.x-this.firstCorner.x,i=r.y-this.firstCorner.y;return new ot(o,s,a,this.size={x:Math.abs(e),y:Math.abs(i)}).execute(),!0},ht.onMouseDown=function(){if(j.prototype.onMouseDown.call(this),!this.selectedMarkup){var t=this.editor,e=t.getMousePosition();this.initialX=e.x,this.initialY=e.y;var i=this.firstCorner=t.clientToMarkups(this.initialX,this.initialY),s=this.size=t.sizeFromClientToMarkups(1,1),o=0;if(this.lineSnapped=null,t.snapper)if(t.snapper.getGeometryType()===rt.SnapType.SNAP_EDGE){this.lineSnapped=t.snapper.getEdge();var n=t.project(this.lineSnapped.vertices[0]),r=t.project(this.lineSnapped.vertices[1]),a=r.x-n.x,h=r.y-n.y;o=this.rotation=Math.atan2(h,a)}t.beginActionGroup();var l=t.getId();new dt(t,l,i,s,o,this.style).execute(),this.selectedMarkup=t.getMarkup(l),this.creationBegin()}},lt.prototype=Object.create(O.prototype),lt.prototype.constructor=lt;var ut=lt.prototype;function dt(t,e,i,s,o,n){x.call(this,t,"CREATE-RECTANGLE",e),this.selectOnExecution=!1,this.position={x:i.x,y:i.y},this.size={x:s.x,y:s.y},this.rotation=o,this.style=w(n)}ut.getEditMode=function(){return new at(this.editor)},ut.set=function(t,e){this.position.x=t.x,this.position.y=t.y,this.size.x=e.x,this.size.y=e.y,this.updateStyle()},ut.updateStyle=function(){var t=this.style,e=this.shape,i=this.getPath().join(" "),s=this.style["stroke-width"],o=this.highlighted?this.highlightColor:xs(t["stroke-color"],t["stroke-opacity"]),n=xs(t["fill-color"],t["fill-opacity"]),r=this.getTransform();Vi(e,"d",i),Vi(e,"stroke-width",s),Vi(e,"stroke",o),Vi(e,"fill",n),Vi(e,"transform",r),Oi(e,this.editor)},ut.setMetadata=function(){var t=w(this.style);return t.type=this.type,t.position=[this.position.x,this.position.y].join(" "),t.size=[this.size.x,this.size.y].join(" "),t.rotation=String(this.rotation),this.addMarkupMetadata(this.shape,t)},ut.getPath=function(){var t=this.style["stroke-width"],e=this.size.x-t,i=this.size.y-t,s=[];return Ts(.5*-e,.5*-i,e,i,!1,s),s},dt.prototype=Object.create(x.prototype),dt.prototype.constructor=dt;var ct=dt.prototype;function pt(t,e){x.call(this,t,"DELETE-TEXT",e.id);var i={x:e.position.x,y:e.position.y},s={x:e.size.x,y:e.size.y};this.createText=new $t(t,e.id,i,s,e.getText(),e.getStyle())}ct.redo=function(){var t=this.editor,e=new lt(this.targetId,t);t.addMarkup(e),e.set(this.position,this.size),e.setRotation(this.rotation),e.setStyle(this.style)},ct.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)},pt.prototype=Object.create(x.prototype),pt.prototype.constructor=pt;var yt=pt.prototype;function gt(t,e,i,s,o,n){x.call(this,t,"SET-CALLOUT",e.id),this.newPosition={x:i.x,y:i.y},this.oldPosition={x:e.position.x,y:e.position.y},this.newSize={x:s.x,y:s.y},this.oldSize={x:e.size.x,y:e.size.y},this.newText=o,this.oldText=e.getText(),this.newIsFrameUsed=n,this.oldIsFrameUsed=e.isFrameUsed}yt.redo=function(){this.createText.undo()},yt.undo=function(){this.createText.redo()},gt.prototype=Object.create(x.prototype),gt.prototype.constructor=gt;var vt=gt.prototype;function ft(t,e,i,s,o){x.call(this,t,"SET-SIZE",e.id),this.newPosition={x:i.x,y:i.y},this.oldPosition={x:e.position.x,y:e.position.y},this.newWidth=s,this.oldWidth=e.size.x,this.newHeight=o,this.oldHeight=e.size.y}vt.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.set(this.newPosition,this.newSize,this.newText,this.newIsFrameUsed)},vt.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.set(this.oldPosition,this.oldSize,this.oldText,this.oldIsFrameUsed)},ft.prototype=Object.create(x.prototype),ft.prototype.constructor=ft;var xt=ft.prototype;xt.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.setSize(this.newPosition,this.newWidth,this.newHeight)},xt.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.setSize(this.oldPosition,this.oldWidth,this.oldHeight)},xt.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.newPosition=t.newPosition,this.newWidth=t.newWidth,this.newHeight=t.newHeight,!0)},xt.isIdentity=function(){return this.newPosition.x===this.oldPosition.x&&this.newPosition.y===this.oldPosition.y&&this.newWidth===this.oldWidth&&this.newHeight===this.oldHeight};
/*!
    Based on Autosize 4.0.0
    license: MIT
    http://www.jacklmoore.com/autosize
*/
var mt,Mt,kt="function"==typeof Map?new Map:(mt=[],Mt=[],{has:function(t){return mt.indexOf(t)>-1},get:function(t){return Mt[mt.indexOf(t)]},set:function(t,e){-1===mt.indexOf(t)&&(mt.push(t),Mt.push(e))},delete:function(t){var e=mt.indexOf(t);e>-1&&(mt.splice(e,1),Mt.splice(e,1))}});function wt(t){if(!t||!t.nodeName||"TEXTAREA"!==t.nodeName||kt.has(t))return;var e=null,i=t.clientWidth,s=null;const o=this;function n(e){var i=t.style.width;t.style.width="0px",t.offsetWidth,t.style.width=i,t.style.overflow=e}function r(){var s=t.style.height,n=function(t){for(var e=[];t&&t.parentNode&&t.parentNode instanceof Element;)t.parentNode.scrollTop&&e.push({node:t.parentNode,scrollTop:t.parentNode.scrollTop}),t=t.parentNode;return e}(t);const r=o.getDocument();var a=r.documentElement&&r.documentElement.scrollTop;t.style.height="";var h=t.scrollHeight+e;0!==t.scrollHeight?(t.style.height=h+"px",i=t.clientWidth,n.forEach((function(t){t.node.scrollTop!==t.scrollTop&&(t.node.scrollTop=t.scrollTop)})),a&&(r.documentElement.scrollTop=a)):t.style.height=s}function a(){r();const e=o.getWindow();var i=Math.round(parseFloat(t.style.height)),a=e.getComputedStyle(t,null),h="content-box"===a.boxSizing?Math.round(parseFloat(a.height)):t.offsetHeight;if(h!==i?"hidden"===a.overflow&&(n("scroll"),r(),h="content-box"===a.boxSizing?Math.round(parseFloat(window.getComputedStyle(t,null).height)):t.offsetHeight):"hidden"!==a.overflow&&(n("hidden"),r(),h="content-box"===a.boxSizing?Math.round(parseFloat(window.getComputedStyle(t,null).height)):t.offsetHeight),s!==h){s=h;var l=new Event("autosize:resized",{bubbles:!0});try{t.dispatchEvent(l)}catch(t){}}}var h,l=function(){t.clientWidth!==i&&a()},u=function(e){o.removeWindowEventListener("resize",l,!1),t.removeEventListener("input",a,!1),t.removeEventListener("keyup",a,!1),t.removeEventListener("autosize:destroy",u,!1),t.removeEventListener("autosize:update",a,!1),Object.keys(e).forEach((function(i){t.style[i]=e[i]})),kt.delete(t)}.bind(t,{height:t.style.height,resize:t.style.resize,overflow:t.style.overflow,overflowX:t.style.overflowX,wordWrap:t.style.wordWrap});t.addEventListener("autosize:destroy",u,!1),"onpropertychange"in t&&"oninput"in t&&t.addEventListener("keyup",a,!1),o.addWindowEventListener("resize",l,!1),t.addEventListener("input",a,!1),t.addEventListener("autosize:update",a,!1),t.style.overflowX="hidden",t.style.wordWrap="break-word",kt.set(t,{destroy:u,update:a}),"vertical"===(h=o.getWindow().getComputedStyle(t,null)).resize?t.style.resize="none":"both"===h.resize&&(t.style.resize="horizontal"),e="content-box"===h.boxSizing?-(parseFloat(h.paddingTop)+parseFloat(h.paddingBottom)):parseFloat(h.borderTopWidth)+parseFloat(h.borderBottomWidth),isNaN(e)&&(e=0),a()}function Et(t){var e=kt.get(t);e&&e.destroy()}function At(t){var e=kt.get(t);e&&e.update()}const bt="undefined"!=typeof window&&"function"==typeof window.getComputedStyle;var Tt=function(t,e){const i=this;return bt&&t&&Array.prototype.forEach.call(t.length?t:[t],(function(t){return wt.bind(i)(t,e)})),t};function Ct(){this.reset()}Tt.destroy=function(t){return bt&&t&&Array.prototype.forEach.call(t.length?t:[t],Et),t},Tt.update=function(t){return bt&&t&&Array.prototype.forEach.call(t.length?t:[t],At),t};var St=["-ms-","-webkit-","-moz-","-o-"],It=Ct.prototype;It.reset=function(){return this.attributes={},this.dirty=!1,this.styleString="",this},It.setAttribute=function(t,e,i){if(this.attributes[t]=e,i&&i.allBrowsers){var s=this;St.forEach((function(i){s.attributes[i+t]=e}))}return this.dirty=!0,this},It.removeAttribute=function(t){Array.isArray(t)||(t=[t]);var e=this;return t.forEach((function(t){t in e.attributes&&(delete e.attributes[t],e.dirty=!0)})),this},It.getStyleString=function(){return this.dirty&&(this.styleString=function(t){var e=[];for(var i in t){var s=t[i];e.push(i),e.push(":"),e.push(s),e.push("; ")}return e.join("")}(this.attributes),this.dirty=!1),this.styleString},It.clone=function(){var t=new Ct,e=this.attributes;for(var i in e)t.setAttribute(i,e[i]);return t};function zt(t,e,i,s,o){this.parentDiv=t,this.editor=e,this.setGlobalManager(e.viewer.globalManager),this.EVENT_TEXT_CHANGE="EVENT_CO2_TEXT_CHANGE",this.EVENT_TEXT_SET_ACTIVE="EVENT_CO2_TEXT_SET_ACTIVE",this.EVENT_TEXT_SET_INACTIVE="EVENT_CO2_TEXT_SET_INACTIVE";const n=this.getDocument();i?(this.textArea=n.createElement("input"),this.textArea.setAttribute("type","text")):(this.textArea=n.createElement("textarea"),this.textArea.rows="1",this.textArea.dir="auto"),this.firstEdit=!0,this.defaultText=s,this.textArea.setAttribute("maxlength",o),this.textArea.setAttribute("data-i18n",s),this.startingHeight=0,Tt.bind(this)(this.textArea),new ResizeObserver(function(t,e){this.setEditFrame()}.bind(this)).observe(this.textArea),this.styleTextArea=new Ct,this.styleTextArea.setAttribute("position","absolute").setAttribute("resize","none").setAttribute("box-sizing","border-box").setAttribute("-moz-box-sizing","border-box").setAttribute("-webkit-box-sizing","border-box").setAttribute("overflow","hidden").setAttribute("outline","none").setAttribute("border","none").setAttribute("z-index","1").setAttribute("padding","10px"),this.measureDiv=n.createElement("div"),Qi(this)}Autodesk.Viewing.GlobalManagerMixin.call(zt.prototype);var Pt=zt.prototype;function Dt(t){if(0===t.length)return"";for(var e=t.length-1,i=e;i>=0;--i)if(" "!==t.charAt(i)){e=i;break}return t.substr(0,e+1)}function Ht(t){if(0===t.length)return"";for(var e=0,i=0;i<t.length;++i)if(" "!==t.charAt(i)){e=i;break}return t.substr(e)}Pt.destroy=function(){this.setInactive()},Pt.setActive=function(t,e){if(this.textMarkup!==t){var i=Autodesk.Viewing.i18n.translate(this.defaultText);if(this.textArea.setAttribute("placeholder",i),this.setInactive(),this.parentDiv.appendChild(this.textArea),this.textMarkup=t,this.firstEdit=e||!1,this.constrainToCanvas=e,this.initFromMarkup(),this.constrainToCanvas=!1,!Autodesk.Viewing.isIOSDevice()){var s=this.textArea;this.getWindow().requestAnimationFrame((function(){s.focus()}))}var o={markup:this.textMarkup,firstEdit:this.firstEdit,isActive:!0};this.dispatchEvent({type:this.EVENT_TEXT_SET_ACTIVE,data:o})}},Pt.setInactive=function(){var t={markup:this.textMarkup,isActive:!1};Autodesk.Viewing.isIOSDevice()&&this.textArea.blur(),this.removeWindowEventListener("resize",this.onResizeBinded),this.textMarkup&&(this.textMarkup=null,this.parentDiv.removeChild(this.textArea)),this.style=null,this.dispatchEvent({type:this.EVENT_TEXT_SET_INACTIVE,data:t})},Pt.isActive=function(){return!!this.textMarkup},Pt.setEditFrame=function(){if(this.editor.editFrame.markup&&this.textMarkup&&this.editor.editFrame.markup===this.textMarkup){var t=parseFloat(this.textArea.style.width),e=parseFloat(this.textArea.style.height),i=this.textMarkup.getClientPosition(),s=this.textMarkup.getRotation(),o=i.x-t/2,n=i.y-this.startingHeight/2;this.editor.editFrame.setSelection(o,n,t,e,s)}},Pt.initFromMarkup=function(t){var e=this.textMarkup,i=e.getClientPosition(),s=e.getClientSize(),o=e.getClientFontSize()/2;this.startingHeight=s.y;var n=i.x-.5*s.x,r=i.y-.5*s.y,a=e.lineHeight+"%";this.styleTextArea.setAttribute("line-height",a),this.styleTextArea.setAttribute("padding",o+"px"),this.setPosAndSize(n,r,s.x,s.y),t?(this.setStyle(e.getStyle()),this.textArea.value=e.getText()):(this.textArea.value=e.getText(),this.setStyle(e.getStyle()))},Pt.setPosAndSize=function(t,e,i,s){this.constrainToCanvas&&(t+i>=this.editor.viewer.container.clientWidth&&(t=this.editor.viewer.container.clientWidth-(i+10)),e+s>=this.editor.viewer.container.clientHeight&&(e=this.editor.viewer.container.clientHeight-(s+10)),t<5&&(t=5,i=this.editor.viewer.container.clientWidth-10)),this.styleTextArea.setAttribute("left",t+"px").setAttribute("top",e+"px").setAttribute("width",i+"px").setAttribute("height",s+"px")},Pt.setStyle=function(t){if(this.style){var e={};this.injectSizeValues(e),this.setPosAndSize(e.newPos.x-.5*e.width,e.newPos.y-.5*e.height,e.width,e.height)}var i=this.editor.sizeFromMarkupsToClient(0,t["font-size"]).y,s=this.editor.sizeFromMarkupsToClient(0,t["stroke-width"]).y,o=this.styleTextArea.setAttribute("color",t["stroke-color"]).setAttribute("outline",s+"px solid "+t["stroke-color"]).setAttribute("font-family",t["font-family"]).setAttribute("font-size",i+"px").setAttribute("font-weight",t["font-weight"]).setAttribute("font-style",t["font-style"]).getStyleString();this.textArea.setAttribute("style",o),this.style=w(t),Tt.update(this.textArea)},Pt.getTextValuesForMarkup=function(t,e){var i=this.isActive(),s=this.textMarkup,o=this.firstEdit;this.setActive(t,!1);var n={markup:t,textValues:this.getTextValues()};return i?this.setActive(s,o):(e&&this.injectSizeValues(n),this.setInactive()),n},Pt.getTextValues=function(){var t=this.textArea.value;return t===this.defaultText&&(t=""),{text:t,lines:this.generateLines()}},Pt.acceptAndExit=function(){var t=this.getTextValues(),e=this.textMarkup,i={markup:this.textMarkup,style:this.style,firstEdit:this.firstEdit,newText:t.text,newLines:t.lines};this.injectSizeValues(i),this.dispatchEvent({type:this.EVENT_TEXT_CHANGE,data:i}),this.setInactive(),e.updateStyle(!0)},Pt.injectSizeValues=function(t){var e=parseFloat(this.textArea.style.width),i=parseFloat(this.textArea.style.height),s=parseFloat(this.textArea.style.left),o=parseFloat(this.textArea.style.top);t.width=e,t.height=i,t.newPos={x:s+.5*e,y:o+.5*i}},Pt.onCameraChanged=function(t){var e=this.textArea.value;this.textMarkup.style=w(this.style),this.style=null,this.initFromMarkup(!0),this.textArea.value=e,this.setEditFrame()},Pt.generateLines=function(){var t=this.textArea.value.split(/\r*\n/),e=this.styleTextArea.clone().removeAttribute(["top","left","width","height"]).setAttribute("position","absolute").setAttribute("white-space","nowrap").setAttribute("float","left").setAttribute("visibility","hidden").getStyleString();this.measureDiv.setAttribute("style",e),this.parentDiv.appendChild(this.measureDiv);for(var i=this.textArea.clientWidth-2*parseFloat(this.textArea.style.padding),s=[],o=0,n=t.length;o<n;++o){var r=Dt(t[o]);r=""===r?" ":r,this.splitLine(r,i,s)}return this.parentDiv.removeChild(this.measureDiv),s},Pt.splitLine=function(t,e,i){if(""!==t)for(var s="",o=!1;!o;){if(this.measureDiv.innerText=t,this.measureDiv.clientWidth-2*parseFloat(this.measureDiv.style.padding)<=e)i.push(t),this.splitLine(Ht(s),e,i),o=!0;else{var n=this.getShorterLine(t);1===n.length?(this.splitWord(t,s,e,i),o=!0):(t=n[0],s=n[1]+s)}}},Pt.getShorterLine=function(t){var e=t.lastIndexOf(" ");if(-1===e)return[t];for(;" "===t.charAt(e-1);)e--;var i=t.substr(e);return[t.substr(0,e),i]},Pt.splitWord=function(t,e,i,s){for(var o=1;;){var n=t.substr(0,o);if(this.measureDiv.innerText=n,this.measureDiv.clientWidth-2*parseFloat(this.measureDiv.style.padding)>i){if(1===o)return s.push(n),void this.splitWord(t.substr(1),e,i,s);var r=t.substr(0,o-1);s.push(r);var a=t.substr(o-1);return void this.splitLine(a+e,i,s)}if(++o>t.length)return void s.push(t)}};function Lt(t){j.call(this,t,g,["font-size","stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity","font-family","font-style","font-weight"]),this.style["fill-opacity"]=1,this.style["fill-color"]="#ffffff";var e=new zt(this.viewer.container,this.editor,!1,"Text",360);e.addEventListener(e.EVENT_TEXT_CHANGE,this.onHelperTextChange.bind(this),!1),e.addEventListener(e.EVENT_TEXT_SET_ACTIVE,this.onHelperSetActive.bind(this),!1),e.addEventListener(e.EVENT_TEXT_SET_INACTIVE,this.onHelperSetActive.bind(this),!1),this.textInputHelper=e,this.onHistoryChangeBinded=this.onHistoryChange.bind(this),this.minSize=0,this.creationMethod=this.CREATION_METHOD_CLICK}Lt.prototype=Object.create(j.prototype),Lt.prototype.constructor=Lt;var Nt=Lt.prototype;Nt.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type===this.type){var i=new Ft(this.editor,t);return i.addToHistory=!e,i.execute(),!0}return!1},Nt.setStyle=function(t){this.textInputHelper&&this.textInputHelper.isActive()?this.textInputHelper.setStyle(t):j.prototype.setStyle.call(this,t)},Nt.notifyAllowNavigation=function(t){t&&this.textInputHelper&&this.textInputHelper.isActive()&&this.textInputHelper.acceptAndExit()},Nt.destroy=function(){this.textInputHelper&&(this.textInputHelper.isActive()&&this.textInputHelper.acceptAndExit(),this.textInputHelper.destroy(),this.textInputHelper=null),j.prototype.destroy.call(this)},Nt.onMouseDown=function(){if(this.textInputHelper&&this.textInputHelper.isActive())this.textInputHelper.acceptAndExit();else if(!this.selectedMarkup){var t=this.editor,e=t.getMousePosition(),i=t.sizeFromMarkupsToClient(0,this.style["font-size"]).y,s=6*i,o=1*i,n=this.size=t.sizeFromClientToMarkups(s,o),r=t.positionFromClientToMarkups(e.x+.5*s,e.y+.5*o);this.creationBegin(),t.beginActionGroup();var a=new Ot(t,t.getId(),r,n,"",this.style,!0);a.execute(),this.creationEnd(),this.selectedMarkup=t.getMarkup(a.targetId),this.textInputHelper&&this.textInputHelper.setActive(this.selectedMarkup,!0),this.editor.actionManager.addEventListener(D,this.onHistoryChangeBinded)}},Nt.onMouseUp=function(t){},Nt.onMouseDoubleClick=function(t){t===this.selectedMarkup&&(this.editor.selectMarkup(t),this.editor.editFrame.setMarkup(t),this.textInputHelper&&this.textInputHelper.setActive(t,!1))},Nt.onHelperSetActive=function(t){var e=t.data,i=e.markup;i&&(i.setIsHelperTextActive(e.isActive),i.setIsShapeVisible(!e.isActive))},Nt.onHelperTextChange=function(t){var e=t.data,i=e.markup,s=e.style,o=this.selectedMarkup;if(this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded),""===e.newText)return this.editor.cancelActionGroup(),new Ft(this.editor,i).execute(),void(i!==o&&this.editor.selectMarkup(o));e.firstEdit||this.editor.beginActionGroup();var n=this.editor.positionFromClientToMarkups(e.newPos.x,e.newPos.y),r=this.editor.sizeFromClientToMarkups(e.width,e.height);new ft(this.editor,i,n,r.x,r.y).execute(),new gt(this.editor,i,i.position,i.size,e.newText,i.isFrameUsed).execute(),new F(this.editor,i,s).execute(),this.editor.closeActionGroup(),this.editor.selectMarkup(o)},Nt.onHistoryChange=function(t){this.textInputHelper&&this.textInputHelper.isActive()&&(this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded),this.textInputHelper.setInactive())},Nt.onSave=function(){if(j.prototype.onSave.call(this),this.textInputHelper&&this.textInputHelper.isActive()){var t=this.textInputHelper.firstEdit;this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded),this.textInputHelper.setInactive(),t&&this.editor.cancelActionGroup(),this.editor.selectMarkup(null),this.selectedMarkup=null}},Nt.updateTextBoxStyle=function(){this.isTextInputHelperActive()&&this.textInputHelper.onCameraChanged()};var Rt=100;function Bt(t,e,i){O.call(this,t,e,["font-size","stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity","font-family","font-style","font-weight"]),this.addMarkupMetadata=Ki.bind(this),this.createSvgElement=Li.bind(this),this.type=g,this.textShape=_i(),this.rectShape=Bi(),this.shape=Ri([this.rectShape,this.textShape]),this.isFrameUsed=!0,this.constraintRotation=!0,this.constraintHeight=!0,this.constraintWidth=!1,this.size.x=i.x,this.size.y=i.y,this.currentText="",this.currentTextLines=[""],this.prevHighlight=!1,this.isHelperTextActive=!1,this.lineHeight=130,this.minWidth=6*this.getClientFontSize(),this.bindDomEvents()}Bt.prototype=Object.create(O.prototype),Bt.prototype.constructor=Bt;var Vt=Bt.prototype;function Ot(t,e,i,s,o,n,r){x.call(this,t,"CREATE-CALLOUT",e),this.text=o,this.position={x:i.x,y:i.y},this.size={x:s.x,y:s.y},this.style=w(n),this.isFrameUsed=r}Vt.getEditMode=function(){return new Lt(this.editor)},Vt.set=function(t,e,i,s){this.position.x=t.x,this.position.y=t.y,this.size.x=e.x,this.size.y=e.y,this.setIsFilledFrameUsed(s),this.setText(i)},Vt.setSize=function(t,e,i){this.position.x=t.x,this.position.y=t.y,this.size.x=e,this.size.y=i;this.isHelperTextActive?this.updateTextBoxStyle():this.updateStyle(!0)},Vt.setPosition=function(t,e){this.position.x=t,this.position.y=e,this.isHelperTextActive?this.updateTextBoxStyle():this.updateStyle()},Vt.setStyle=function(t){var e=k(t,this.style);e||M(t,this.style),this.updateStyle(!e)},Vt.setText=function(t){this.currentText=t},Vt.getText=function(){return this.currentText},Vt.getTextLines=function(){return this.currentTextLines.concat()},Vt.highlightChanged=function(){if(this.highlighted&&this.highlighted!==this.prevHighlight){var t=this.rectShape,e=this.textShape,i=this.highlightColor;return Vi(e,"fill",i),this.isFrameUsed&&Vi(t,"stroke",i),this.prevHighlight=!0,!1}return!0},Vt.updateTextBoxStyle=function(){var t=this.editor.duringEditMode&&this.editor.editMode;t&&t.type===this.type||(t=this.getEditMode()),t.updateTextBoxStyle()},Vt.setIsHelperTextActive=function(t){this.isHelperTextActive=t},Vt.updateStyle=function(t){if(this.highlightChanged()){this.prevHighlight=!1;var e=this.style,i=this.rectShape,s=this.textShape,o=this.style["font-size"],n=this.style["font-family"],r=this.style["font-weight"],a=this.style["font-style"],h=this.highlighted?this.highlightColor:xs(e["stroke-color"],e["stroke-opacity"]),l=this.style["stroke-width"];Rt=o>1?1:100,this.rebuildTextSvg(t);var u=this.editor,d=this.getTextContainerTransform(),c=this.getTextTransform();Vi(s,"font-family",n),Vi(s,"font-size",o*Rt),Vi(s,"fill",h),Vi(s,"font-weight",r),Vi(s,"font-style",a),Fi(s,d,c),Gi(s,this.size.x,this.size.y),Ui(s,this.size.x,this.size.y,u);var p=this.getPath().join(" "),y=this.getTransform(),g=xs(e["fill-color"],e["fill-opacity"]);Vi(i,"d",p),Vi(i,"stroke-width",l),Vi(i,"stroke",h),Vi(i,"transform",y),Vi(i,"fill",g),Oi(i,u)}},Vt.rebuildTextSvg=function(t){var e=this.editor.duringEditMode&&this.editor.editMode;if(e&&e.type===this.type||((e=this.getEditMode()).textInputHelper.textArea.value=this.currentText,e.textInputHelper.setStyle(this.style)),!e.textInputHelper.textMarkup||e.textInputHelper.textMarkup===this){var i=w(e.textInputHelper.style),s=e.textInputHelper.textArea.value,o=e.textInputHelper.getTextValuesForMarkup(this,t);if(this.currentTextLines=o.textValues.lines,o.newPos){var n=this.editor.positionFromClientToMarkups(o.newPos.x,o.newPos.y),r=this.editor.sizeFromClientToMarkups(o.width,o.height);this.position.x=n.x,this.position.y=n.y,this.size.x=r.x,this.size.y=r.y}e.selectedMarkup===this||e.textInputHelper.firstEdit||(e.textInputHelper.textArea.value=s,e.textInputHelper.setStyle(i));var a=this.createSvgElement("text");a.setAttribute("id","markup"),a.setAttribute("alignment-baseline","middle"),this.textShape.childNodes[0].removeChild(this.textShape.markup),this.textShape.childNodes[0].appendChild(a),this.textShape.markup=a;var h=this.getLineHeight()*Rt*(this.lineHeight/100),l=this.getLineHeight()*Rt/2,u=l,d=l;this.currentTextLines.forEach(function(t){var e=this.createSvgElement("tspan");e.setAttribute("x",u),e.setAttribute("y",d),e.textContent=t,a.appendChild(e),d+=h}.bind(this))}},Vt.setIsFilledFrameUsed=function(t){this.isFrameUsed=t;var e=this.rectShape.parentNode===this.shape;t&&!e?this.shape.insertBefore(this.rectShape,this.shape.firstChild):!t&&e&&this.shape.removeChild(this.rectShape)},Vt.setIsFilledFrameVisible=function(t){this.rectShape.markup.style.display=t&&this.isFrameUsed?"block":"none"},Vt.setIsShapeVisible=function(t){this.shape.style.display=t?"block":"none"},Vt.setMetadata=function(){var t=w(this.style);return t.type=this.type,t.position=[this.position.x,this.position.y].join(" "),t.size=[this.size.x,this.size.y].join(" "),t.text=String(this.currentText),t.isframeused=this.isFrameUsed?1:0,this.addMarkupMetadata(this.shape,t)},Vt.getClientFontSize=function(){return this.editor.sizeFromMarkupsToClient(0,this.style["font-size"]).y},Vt.getLineHeight=function(){return this.style["font-size"]},Vt.getTextContainerTransform=function(){return["translate(",this.position.x-.5*this.size.x,",",this.position.y+.5*this.size.y,")","rotate(",rs(-this.rotation),")","scale(1,-1)"].join(" ")},Vt.getTextTransform=function(){var t=this.getLineHeight();return["translate(",this.position.x-.5*this.size.x,",",this.position.y+.5*this.size.y-t,")","rotate(",rs(-this.rotation),")","scale("+1/Rt+","+-1/Rt+")"].join(" ")},Vt.cloneShape=function(t){t.textShape=_i(),t.rectShape=Bi(),t.shape=Ri([t.rectShape,t.textShape]),t.bindDomEvents()},Vt.getPath=function(){var t=this.style["stroke-width"],e=this.size.x+t,i=this.size.y+t,s=[];return Ts(.5*-e,.5*-i,e,i,!1,s),s},Vt.getBoundingRect=function(){var t=this.getClientPosition(),e=this.getClientSize(),i=this.style["stroke-width"],s=this.editor.sizeFromMarkupsToClient(i,0).x+Di;return{x:t.x-e.x/2,y:t.y-e.y/2,width:e.x,height:e.y,margin:s}},Ot.prototype=Object.create(x.prototype),Ot.prototype.constructor=Ot;var _t=Ot.prototype;function Ft(t,e){x.call(this,t,"DELETE-CALLOUT",e.id);var i={x:e.position.x,y:e.position.y},s={x:e.size.x,y:e.size.y};this.createCallout=new Ot(t,e.id,i,s,e.getText(),e.getStyle(),e.isFrameUsed)}_t.redo=function(){var t=this.editor,e=this.position,i=this.size,s=new Bt(this.targetId,t,i);t.addMarkup(s),s.setIsFilledFrameUsed(this.isFrameUsed),s.setText(this.text),s.setSize(e,i.x,i.y),s.setStyle(this.style)},_t.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&(this.editor.removeMarkup(t),t.destroy())},Ft.prototype=Object.create(x.prototype),Ft.prototype.constructor=Ft;var Ut=Ft.prototype;function jt(t,e,i,s,o){x.call(this,t,"SET-TEXT",e.id),this.newPosition={x:i.x,y:i.y},this.oldPosition={x:e.position.x,y:e.position.y},this.newSize={x:s.x,y:s.y},this.oldSize={x:e.size.x,y:e.size.y},this.newText=o,this.oldText=e.getText()}Ut.redo=function(){this.createCallout.undo()},Ut.undo=function(){this.createCallout.redo()},jt.prototype=Object.create(x.prototype),jt.prototype.constructor=jt;var Gt=jt.prototype;function Wt(t){j.call(this,t,a,["font-size","stroke-color","stroke-opacity","fill-color","fill-opacity","font-family","font-style","font-weight"]);var e=new zt(this.viewer.container,this.editor,!1,"Text",260);e.addEventListener(e.EVENT_TEXT_CHANGE,this.onHelperTextChange.bind(this),!1),e.addEventListener(e.EVENT_TEXT_SET_ACTIVE,this.onHelperSetActive.bind(this),!1),e.addEventListener(e.EVENT_TEXT_SET_INACTIVE,this.onHelperSetActive.bind(this),!1),this.textInputHelper=e,this.onHistoryChangeBinded=this.onHistoryChange.bind(this),this.minSize=0,this.creationMethod=this.CREATION_METHOD_CLICK}Gt.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.set(this.newPosition,this.newSize,this.newText)},Gt.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.set(this.oldPosition,this.oldSize,this.oldText)},Wt.prototype=Object.create(j.prototype),Wt.prototype.constructor=Wt;var Kt=Wt.prototype;Kt.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type==this.type){var i=new pt(this.editor,t);return i.addToHistory=!e,i.execute(),!0}return!1},Kt.setStyle=function(t){this.textInputHelper&&this.textInputHelper.isActive()?this.textInputHelper.setStyle(t):j.prototype.setStyle.call(this,t)},Kt.notifyAllowNavigation=function(t){t&&this.textInputHelper&&this.textInputHelper.isActive()&&this.textInputHelper.acceptAndExit()},Kt.destroy=function(){this.textInputHelper&&(this.textInputHelper.isActive()&&this.textInputHelper.acceptAndExit(),this.textInputHelper.destroy(),this.textInputHelper=null),j.prototype.destroy.call(this)},Kt.onMouseDown=function(){if(this.textInputHelper&&this.textInputHelper.isActive())this.textInputHelper.acceptAndExit();else if(!this.selectedMarkup){var t=this.editor,e=t.getMousePosition(),i=t.sizeFromMarkupsToClient(0,this.style["font-size"]).y,s=15*i,o=1*i,n=this.size=t.sizeFromClientToMarkups(s,o),r=t.positionFromClientToMarkups(e.x+.5*s,e.y+.5*o);this.creationBegin(),t.beginActionGroup();var a=new $t(t,t.getId(),r,n,"",this.style);a.execute(),this.creationEnd(),this.selectedMarkup=t.getMarkup(a.targetId),this.textInputHelper&&this.textInputHelper.setActive(this.selectedMarkup,!0),this.editor.actionManager.addEventListener(D,this.onHistoryChangeBinded)}},Kt.updateTextBoxStyle=function(){this.isTextInputHelperActive()&&this.textInputHelper.onCameraChanged()},Kt.onMouseUp=function(t){},Kt.onMouseDoubleClick=function(t){t===this.selectedMarkup&&(this.editor.selectMarkup(t),this.editor.editFrame.setMarkup(t),this.textInputHelper&&this.textInputHelper.setActive(t,!1))},Kt.onHelperSetActive=function(t){var e=t.data,i=e.markup;i&&(i.setIsHelperTextActive(e.isActive),i.setIsShapeVisible(!e.isActive))},Kt.onHelperTextChange=function(t){var e=t.data,i=e.markup,s=e.style,o=this.selectedMarkup;if(this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded),""===e.newText)return this.editor.cancelActionGroup(),new Ft(this.editor,i).execute(),void(i!==o&&this.editor.selectMarkup(o));e.firstEdit||this.editor.beginActionGroup();var n=this.editor.positionFromClientToMarkups(e.newPos.x,e.newPos.y),r=this.editor.sizeFromClientToMarkups(e.width,e.height);new ft(this.editor,i,n,r.x,r.y).execute(),new jt(this.editor,i,i.position,i.size,e.newText).execute(),new F(this.editor,i,s).execute(),this.editor.closeActionGroup(),this.editor.selectMarkup(o)},Kt.onHistoryChange=function(t){this.textInputHelper&&this.textInputHelper.isActive()&&(this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded),this.textInputHelper.setInactive())},Kt.onSave=function(){if(j.prototype.onSave.call(this),this.textInputHelper&&this.textInputHelper.isActive()){var t=this.textInputHelper.firstEdit;this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded),this.textInputHelper.setInactive(),t&&this.editor.cancelActionGroup(),this.editor.selectMarkup(null),this.selectedMarkup=null}},Kt.updateTextBoxStyle=function(){this.isTextInputHelperActive()&&this.textInputHelper.onCameraChanged()};var Yt=100;function Xt(t,e,i){O.call(this,t,e,["font-size","stroke-color","stroke-opacity","fill-color","fill-opacity","font-family","font-style","font-weight"]),this.createSvgElement=Li.bind(this),this.addMarkupMetadata=Ki.bind(this),this.type=a,this.shape=_i(),this.constraintRotation=!0,this.constraintHeight=!0,this.constraintWidth=!1,this.size.x=i.x,this.size.y=i.y,this.currentText="",this.currentTextLines=[""],this.textDirty=!0,this.textSize={x:0,y:0},this.prevHighlight=!1,this.isHelperTextActive=!1,this.lineHeight=130,this.minWidth=6*this.getClientFontSize(),this.bindDomEvents()}Xt.prototype=Object.create(O.prototype),Xt.prototype.constructor=Xt;var qt=Xt.prototype;function $t(t,e,i,s,o,n){x.call(this,t,"CREATE-TEXT",e),this.text=o,this.position={x:i.x,y:i.y},this.size={x:s.x,y:s.y},this.style=w(n)}qt.getEditMode=function(){return new Wt(this.editor)},qt.set=function(t,e,i){this.position.x=t.x,this.position.y=t.y,this.size.x=e.x,this.size.y=e.y,this.setText(i)},qt.setSize=function(t,e,i){this.position.x=t.x,this.position.y=t.y,this.size.x=e,this.size.y=i;this.isHelperTextActive?this.updateTextBoxStyle():this.updateStyle(!0)},qt.setPosition=function(t,e){this.position.x=t,this.position.y=e,this.isHelperTextActive?this.updateTextBoxStyle():this.updateStyle()},qt.setStyle=function(t){var e=k(t,this.style);e||M(t,this.style),this.updateStyle(!e)},qt.setText=function(t){this.currentText=t},qt.getText=function(){return this.currentText},qt.getTextLines=function(){return this.currentTextLines.concat()},qt.highlightChanged=function(){if(this.highlighted&&this.highlighted!==this.prevHighlight){var t=this.shape,e=this.highlightColor;return Vi(t,"fill",e),this.prevHighlight=!0,!1}return!0},qt.updateTextBoxStyle=function(){var t=this.editor.duringEditMode&&this.editor.editMode;t&&t.type===this.type||(t=this.getEditMode()),t.updateTextBoxStyle()},qt.setIsHelperTextActive=function(t){this.isHelperTextActive=t},qt.updateStyle=function(t){if(this.highlightChanged()){this.prevHighlight=!1;var e=this.style,i=this.shape,s=this.style["font-size"],o=this.style["font-family"],n=this.style["font-weight"],r=this.style["font-style"],a=this.highlighted?this.highlightColor:xs(e["stroke-color"],e["stroke-opacity"]),h=xs(e["fill-color"],e["fill-opacity"]);Yt=s>1?1:100,this.rebuildTextSvg(t),Vi(i,"font-family",o),Vi(i,"font-size",s*Yt),Vi(i,"fill",a),Vi(i,"font-weight",n),Vi(i,"font-style",r);var l=this.editor,u=this.getTransform(),d=this.getTextTransform();Fi(i,u,d),ji(i,this.size.x,this.size.y,h),Gi(i,this.size.x,this.size.y),Ui(i,this.size.x,this.size.y,l)}},qt.rebuildTextSvg=function(t){var e=this.editor.duringEditMode&&this.editor.editMode;if(e&&e.type===this.type||((e=this.getEditMode()).textInputHelper.textArea.value=this.currentText,e.textInputHelper.setStyle(this.style)),!e.textInputHelper.textMarkup||e.textInputHelper.textMarkup===this){var i=w(e.textInputHelper.style),s=e.textInputHelper.textArea.value,o=e.textInputHelper.getTextValuesForMarkup(this,t);if(this.currentTextLines=o.textValues.lines,o.newPos){var n=this.editor.positionFromClientToMarkups(o.newPos.x,o.newPos.y),r=this.editor.sizeFromClientToMarkups(o.width,o.height);this.position.x=n.x,this.position.y=n.y,this.size.x=r.x,this.size.y=r.y}e.selectedMarkup===this||e.textInputHelper.firstEdit||(e.textInputHelper.textArea.value=s,e.textInputHelper.setStyle(i));var a=this.createSvgElement("text");a.setAttribute("id","markup"),a.setAttribute("alignment-baseline","middle"),this.shape.childNodes[0].removeChild(this.shape.markup),this.shape.childNodes[0].appendChild(a),this.shape.markup=a;var h=this.getLineHeight()*Yt*(this.lineHeight/100),l=this.getLineHeight()*Yt/2,u=l,d=l;this.currentTextLines.forEach(function(t){var e=this.createSvgElement("tspan");e.setAttribute("x",u),e.setAttribute("y",d),e.textContent=t,a.appendChild(e),d+=h}.bind(this))}},qt.setIsShapeVisible=function(t){this.shape.style.display=t?"block":"none"},qt.setMetadata=function(){var t=w(this.style);return t.type=this.type,t.position=[this.position.x,this.position.y].join(" "),t.size=[this.size.x,this.size.y].join(" "),t.text=String(this.currentText),this.addMarkupMetadata(this.shape,t)},qt.getClientFontSize=function(){return this.editor.sizeFromMarkupsToClient(0,this.style["font-size"]).y},qt.getLineHeight=function(){return this.style["font-size"]},qt.getTransform=function(){return["translate(",this.position.x-.5*this.size.x,",",this.position.y+.5*this.size.y,")","rotate(",rs(-this.rotation),")","scale(1,-1)"].join(" ")},qt.getTextTransform=function(){var t=this.getLineHeight();return["translate(",this.position.x-.5*this.size.x,",",this.position.y+.5*this.size.y-t,")","rotate(",rs(-this.rotation),")","scale("+1/Yt+","+-1/Yt+")"].join(" ")},qt.cloneShape=function(t){t.shape=_i(),t.bindDomEvents()},qt.getBoundingRect=function(){var t=this.getClientPosition(),e=this.getClientSize();return{x:t.x-e.x/2,y:t.y-e.y/2,width:e.x,height:e.y}},$t.prototype=Object.create(x.prototype),$t.prototype.constructor=$t;var Zt=$t.prototype;function Qt(t,e){x.call(this,t,"DELETE-CIRCLE",e.id),this.createCircle=new re(t,e.id,e.position,e.size,e.rotation,e.getStyle())}Zt.redo=function(){var t=this.editor,e=this.position,i=this.size,s=new Xt(this.targetId,t,i);t.addMarkup(s),s.set(e,i,this.text),s.setStyle(this.style)},Zt.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&(this.editor.removeMarkup(t),t.destroy())},Qt.prototype=Object.create(x.prototype),Qt.prototype.constructor=Qt;var Jt=Qt.prototype;function te(t,e,i,s){x.call(this,t,"SET-CIRCLE",e.id),this.newPosition={x:i.x,y:i.y},this.newSize={x:s.x,y:s.y},this.oldPosition={x:e.position.x,y:e.position.y},this.oldSize={x:e.size.x,y:e.size.y}}Jt.redo=function(){this.createCircle.undo()},Jt.undo=function(){this.createCircle.redo()},te.prototype=Object.create(x.prototype),te.prototype.constructor=te;var ee=te.prototype;function ie(t){j.call(this,t,l,["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity"])}ee.redo=function(){this.applyState(this.targetId,this.newPosition,this.newSize)},ee.undo=function(){this.applyState(this.targetId,this.oldPosition,this.oldSize)},ee.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.newPosition=t.newPosition,this.newSize=t.newSize,!0)},ee.applyState=function(t,e,i){var s=this.editor.getMarkup(t);if(s){var o=1e-4;(Math.abs(s.position.x-e.x)>o||Math.abs(s.size.y-i.y)>o||Math.abs(s.position.y-e.y)>o||Math.abs(s.size.y-i.y)>o)&&s.set(e,i)}},ee.isIdentity=function(){return this.newPosition.x===this.oldPosition.x&&this.newPosition.y===this.oldPosition.y&&this.newSize.x===this.oldSize.x&&this.newSize.y===this.oldSize.y},ie.prototype=Object.create(j.prototype),ie.prototype.constructor=ie;var se=ie.prototype;function oe(t,e){O.call(this,t,e,["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity"]),this.addMarkupMetadata=Ki.bind(this),this.type=l,this.shape=Bi(),this.bindDomEvents()}se.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type==this.type){var i=new Qt(this.editor,t);return i.addToHistory=!e,i.execute(),!0}return!1},se.onMouseMove=function(t){if(!j.prototype.onMouseMove.call(this,t))return!1;var e=this.selectedMarkup,i=this.editor,s=this.getFinalMouseDraggingPosition();s=i.clientToMarkups(s.x,s.y);var o=Math.abs(this.firstPosition.x-s.x),n=Math.abs(this.firstPosition.y-s.y);return new te(i,e,{x:.5*(this.firstPosition.x+s.x),y:.5*(this.firstPosition.y+s.y)},this.size={x:o,y:n}).execute(),!0},se.onMouseDown=function(){if(j.prototype.onMouseDown.call(this),!this.selectedMarkup){var t=this.editor,e=t.getMousePosition();this.initialX=e.x,this.initialY=e.y;var i=this.firstPosition=t.clientToMarkups(this.initialX,this.initialY),s=this.size=t.sizeFromClientToMarkups(1,1);t.beginActionGroup();var o=t.getId();new re(t,o,i,s,0,this.style).execute(),this.selectedMarkup=t.getMarkup(o),this.creationBegin()}},oe.prototype=Object.create(O.prototype),oe.prototype.constructor=oe;var ne=oe.prototype;function re(t,e,i,s,o,n){x.call(this,t,"CREATE-CIRCLE",e),this.selectOnExecution=!1,this.position={x:i.x,y:i.y},this.size={x:s.x,y:s.y},this.rotation=o,this.style=w(n)}ne.getEditMode=function(){return new ie(this.editor)},ne.set=function(t,e){this.setSize(t,e.x,e.y)},ne.updateStyle=function(){var t=this.style,e=this.shape,i=this.getPath().join(" "),s=this.style["stroke-width"],o=this.highlighted?this.highlightColor:xs(t["stroke-color"],t["stroke-opacity"]),n=xs(t["fill-color"],t["fill-opacity"]),r=this.getTransform();Vi(e,"d",i),Vi(e,"stroke-width",s),Vi(e,"stroke",o),Vi(e,"fill",n),Vi(e,"transform",r),Oi(e,this.editor)},ne.setMetadata=function(){var t=w(this.style);return t.type=this.type,t.position=[this.position.x,this.position.y].join(" "),t.size=[this.size.x,this.size.y].join(" "),t.rotation=String(this.rotation),this.addMarkupMetadata(this.shape,t)},ne.getPath=function(){var t=this.size;if(1===t.x||1===t.y)return[""];var e=this.style["stroke-width"],i=t.x-e,s=t.y-e,o=[];return bs(-.5*i,0,i,s,!1,o),o},re.prototype=Object.create(x.prototype),re.prototype.constructor=re;var ae=re.prototype;function he(t,e){x.call(this,t,"DELETE-CLOUD",e.id),this.createCloud=new ve(t,e.id,e.position,e.size,e.rotation,e.getStyle())}ae.redo=function(){var t=this.editor,e=new oe(this.targetId,t);t.addMarkup(e),e.setSize(this.position,this.size.x,this.size.y),e.setRotation(this.rotation),e.setStyle(this.style)},ae.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)},he.prototype=Object.create(x.prototype),he.prototype.constructor=he;var le=he.prototype;function ue(t,e,i,s){x.call(this,t,"SET-CLOUD",e.id),this.newPosition={x:i.x,y:i.y},this.newSize={x:s.x,y:s.y},this.oldPosition={x:e.position.x,y:e.position.y},this.oldSize={x:e.size.x,y:e.size.y}}le.redo=function(){this.createCloud.undo()},le.undo=function(){this.createCloud.redo()},ue.prototype=Object.create(x.prototype),ue.prototype.constructor=ue;var de=ue.prototype;function ce(t){j.call(this,t,u,["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity"])}de.redo=function(){this.applyState(this.targetId,this.newPosition,this.newSize,this.newStrokeWidth,this.newColor)},de.undo=function(){this.applyState(this.targetId,this.oldPosition,this.oldSize,this.oldStrokeWidth,this.oldColor)},de.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.newPosition=t.newPosition,this.newSize=t.newSize,!0)},de.applyState=function(t,e,i){var s=this.editor.getMarkup(t);if(s){var o=1e-4;(Math.abs(s.position.x-e.x)>o||Math.abs(s.size.y-i.y)>o||Math.abs(s.position.y-e.y)>o||Math.abs(s.size.y-i.y)>o)&&s.set(e,i)}},de.isIdentity=function(){return this.newPosition.x===this.oldPosition.x&&this.newPosition.y===this.oldPosition.y&&this.newSize.x===this.oldSize.x&&this.newSize.y===this.oldSize.y},ce.prototype=Object.create(j.prototype),ce.prototype.constructor=ce;var pe=ce.prototype;function ye(t,e){O.call(this,t,e,["stroke-width","stroke-linejoin","stroke-color","stroke-opacity","fill-color","fill-opacity"]),this.addMarkupMetadata=Ki.bind(this),this.type=u,this.shape=Bi(),this.bindDomEvents()}pe.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type==this.type){var i=new he(this.editor,t);return i.addToHistory=!e,i.execute(),!0}return!1},pe.onMouseMove=function(t){if(!j.prototype.onMouseMove.call(this,t))return!1;var e=this.selectedMarkup,i=this.editor,s=this.getFinalMouseDraggingPosition(),o=i.clientToMarkups(s.x,s.y);return new ue(i,e,{x:(this.firstPosition.x+o.x)/2,y:(this.firstPosition.y+o.y)/2},this.size={x:Math.abs(o.x-this.firstPosition.x),y:Math.abs(o.y-this.firstPosition.y)}).execute(),!0},pe.onMouseDown=function(){if(j.prototype.onMouseDown.call(this),!this.selectedMarkup){var t=this.editor,e=t.getMousePosition();this.initialX=e.x,this.initialY=e.y;var i=this.firstPosition=t.clientToMarkups(this.initialX,this.initialY),s=this.size=t.sizeFromClientToMarkups(1,1);t.beginActionGroup();var o=t.getId();new ve(t,o,i,s,0,this.style).execute(),this.selectedMarkup=t.getMarkup(o),this.creationBegin()}},ye.prototype=Object.create(O.prototype),ye.prototype.constructor=ye;var ge=ye.prototype;function ve(t,e,i,s,o,n){x.call(this,t,"CREATE-CLOUD",e),this.selectOnExecution=!1,this.position={x:i.x,y:i.y},this.size={x:s.x,y:s.y},this.rotation=o,this.style=w(n)}ge.getEditMode=function(){return new ce(this.editor)},ge.set=function(t,e){this.setSize(t,e.x,e.y)},ge.updateStyle=function(){var t=this.style,e=this.shape,i=this.getPath().join(" "),s=this.style["stroke-width"],o=this.highlighted?this.highlightColor:xs(t["stroke-color"],t["stroke-opacity"]),n=xs(t["fill-color"],t["fill-opacity"]),r=this.getTransform();Vi(e,"d",i),Vi(e,"stroke-width",s),Vi(e,"stroke",o),Vi(e,"fill",n),Vi(e,"transform",r),Oi(e,this.editor)},ge.setMetadata=function(){var t=w(this.style);return t.type=this.type,t.position=[this.position.x,this.position.y].join(" "),t.size=[this.size.x,this.size.y].join(" "),t.rotation=String(this.rotation),this.addMarkupMetadata(this.shape,t)},ge.getPath=function(){var t=this.position,e=this.size,i=this.style["stroke-width"],s=2*i;function o(t,e,i,s,o){return o.push("a"),o.push(i),o.push(s),o.push(0),o.push(1),o.push(1),o.push(t),o.push(e),o}function n(t,e,i,s,n){switch(t){case"LT":return o(e,-i,e,i,n);case"RT":return o(e,i,e,i,n);case"RB":return o(-e,i,e,i,n);case"LB":return o(-e,-i,e,i,n)}}function r(t,e,i,s){var o=2*i,n=Math.abs(e-t-s),r=Math.round(n/o),a=.05*(o+=(n-o*r)/r),h=3.5*(i=.5*o)/3;return{count:r,radius:i,diameter:o,p1:{x:a,y:-h},p2:{x:o-a,y:-h},p3:{x:o,y:0}}}var a=t.x,h=t.y,l=t.x+e.x,u=t.y+e.y,d=5*s,c=[];if(e.x<d||e.y<d){var p=e.x-i,y=e.y-i;bs(.5*-p,0,p,y,!1,c)}else{var g=r(a,l,s,i),v=r(h,u,s,i),f=g.diameter,x=v.diameter,m=g.radius,M=v.radius;g=r(a+f,l-f,s,i),v=r(h+x,u-x,s,i);var k=.5*i;let t=.5*-e.x+k+m,o=.5*-e.y+k+2*M;c.push("M"),c.push(t),c.push(o),n("LT",m,M,0,c),function(t,e){for(var i=t,s=0;s<i.count;++s)e.push("c"),e.push(i.p1.x),e.push(i.p1.y),e.push(i.p2.x),e.push(i.p2.y),e.push(i.p3.x),e.push(i.p3.y)}(g,c),n("RT",m,M,0,c),function(t,e){for(var i=t,s=0;s<i.count;++s)e.push("c"),e.push(-i.p1.y),e.push(i.p1.x),e.push(-i.p2.y),e.push(i.p2.x),e.push(-i.p3.y),e.push(i.p3.x)}(v,c),n("RB",m,M,0,c),function(t,e){for(var i=t,s=0;s<i.count;++s)e.push("c"),e.push(-i.p1.x),e.push(-i.p1.y),e.push(-i.p2.x),e.push(-i.p2.y),e.push(-i.p3.x),e.push(-i.p3.y)}(g,c),n("LB",m,M,0,c),function(t,e){for(var i=t,s=0;s<i.count;++s)e.push("c"),e.push(i.p1.y),e.push(-i.p1.x),e.push(i.p2.y),e.push(-i.p2.x),e.push(i.p3.y),e.push(-i.p3.x)}(v,c)}return c.push("z"),c},ve.prototype=Object.create(x.prototype),ve.prototype.constructor=ve;var fe=ve.prototype;function xe(t,e){O.call(this,t,e,["stroke-width","stroke-color","stroke-opacity"]),this.addMarkupMetadata=Ki.bind(this),this.shape=Bi(),this.bindDomEvents()}fe.redo=function(){var t=this.editor,e=new ye(this.targetId,t);t.addMarkup(e),e.set(this.position,this.size),e.setRotation(this.rotation),e.setStyle(this.style)},fe.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)},xe.prototype=Object.create(O.prototype),xe.prototype.constructor=xe;var me=xe.prototype;function Me(t,e,i){j.call(this,t,e,i),this.smoothen=!0,this.bufferSize=8}me.set=function(t,e,i,s){this.rotation=0,this.isAbsoluteCoords=s,this.isAbsoluteCoords?this.updatePath(i):(this.locations=i.slice(0),this.size.x=0===e.x?1:e.x,this.size.y=0===e.y?1:e.y,this.setSize(t,e.x,e.y),this.updateStyle())},me.setPosition=function(t,e){this.position.x=t,this.position.y=e;var i=this.shape,s=this.getTransform();Vi(i,"transform",s),Oi(i,this.editor)},me.updateStyle=function(){var t=this.style,e=this.shape,i=this.getPath().join(" "),s=this.style["stroke-width"],o=this.highlighted?this.highlightColor:xs(t["stroke-color"],t["stroke-opacity"]);Vi(e,"stroke-width",s),Vi(e,"stroke-linejoin","round"),Vi(e,"stroke-linecap","round"),Vi(e,"stroke",o),Vi(e,"fill","none"),this.updatePath(i),Oi(e,this.editor)},me.updatePath=function(t){var e=this.shape,i=this.isAbsoluteCoords?"scale(1)":this.getTransform();Vi(e,"transform",i),Vi(e,"d",t)},me.setSize=function(t,e,i){e=0===e?1:e,i=0===i?1:i;for(var s=this.locations,o=s.length,n=e/this.size.x,r=i/this.size.y,a=0;a<o;++a){var h=s[a];h.x*=n,h.y*=r}this.position.x=t.x,this.position.y=t.y,this.size.x=e,this.size.y=i,this.updateStyle()},me.setMetadata=function(){var t=w(this.style);return t.type=this.type,t.position=[this.position.x,this.position.y].join(" "),t.size=[this.size.x,this.size.y].join(" "),t.rotation=String(this.rotation),t.locations=this.locations.map((function(t){return[t.x,t.y].join(" ")})).join(" "),this.addMarkupMetadata(this.shape,t)},me.getPath=function(){var t=[],e=this.locations,i=e.length;if(i>1){t.push("M"),t.push(+e[0].x.toFixed(6)),t.push(+e[0].y.toFixed(6));for(var s=1;s<i;++s){var o=e[s-1],n=e[s];t.push("l"),t.push(+(n.x-o.x).toFixed(6)),t.push(+(n.y-o.y).toFixed(6))}}return t},Me.prototype=Object.create(j.prototype);var ke=Me.prototype;function we(t,e){x.call(this,t,"DELETE-FREEHAND",e.id),this.createFreehand=new Ie(t,e.id,e.position,e.size,e.rotation,e.locations,e.getStyle())}ke.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type===this.type){var i=this.deletePen(t);return i.addToHistory=!e,i.execute(),!0}return!1},ke.onMouseMove=function(t){if(!j.prototype.onMouseMove.call(this,t))return!1;var e=this.editor,i=e.getMousePosition(),s=this.movements,o=e.clientToMarkups(i.x,i.y);if(this.smoothen)this.appendToBuffer(o),this.amendPath();else{var n=this.lastX-i.x,r=this.lastY-i.y;s.length>1&&n*n+r*r<25?(s[s.length-1]=o,this.removeFromAbsolutePath(1)):(s.push(o),this.lastX=i.x,this.lastY=i.y),this.addToAbsolutePath([o])}return this.setPen(this.position,this.size,this.absolutePath,!0).execute(),!0},ke.onMouseDown=function(){if(j.prototype.onMouseDown.call(this),!this.selectedMarkup){var t=this.editor;t.snapper&&t.snapper.clearSnapped();var e=t.getMousePosition();this.lastX=this.initialX=e.x,this.lastY=this.initialY=e.y;var i=this.position=t.clientToMarkups(this.initialX,this.initialY);this.movements=[i],this.smoothen&&(this.buffer=[],this.movementsLastIndex=null,this.appendToBuffer(i));var s=this.size=t.sizeFromClientToMarkups(1,1);t.beginActionGroup();var o=t.getId();this.createPen(o,i,s,0,[{x:0,y:0}]).execute(),this.createAbsolutePath(i),this.selectedMarkup=t.getMarkup(o),this.creationBegin()}},ke.onMouseUp=function(){if(this.creating){var t=this.movements,e=this.viewer.impl.camera.right-this.viewer.impl.camera.left,i=this.viewer.impl.camera.top-this.viewer.impl.camera.bottom,s=(t=Ss(t,1e-8*(e*e+i*i),!0)).map((function(t){return t.x})),o=t.map((function(t){return t.y})),n=Math.min.apply(null,s),r=Math.min.apply(null,o),a=Math.max.apply(null,s)-n,h=Math.max.apply(null,o)-r,l={x:n+.5*a,y:r+.5*h},u=this.size={x:a,y:h},d=t.map((function(t){return{x:t.x-l.x,y:t.y-l.y}}));this.setPen(l,u,d,!1).execute(),j.prototype.onMouseUp.call(this)}else j.prototype.onMouseUp.call(this)},ke.createPen=function(){console.error("createPen not implemented")},ke.deletePen=function(){console.error("deletePen not implemented")},ke.setPen=function(){console.error("setPen not implemented")},ke.useWithSnapping=function(){return!1},ke.createAbsolutePath=function(t){this.absolutePath="M"+ +t.x.toFixed(6)+" "+ +t.y.toFixed(6),this.absolutePathIndexes=[0]},ke.removeFromAbsolutePath=function(t){(t=Math.min(t,this.absolutePathIndexes.length))>0&&(this.absolutePath=this.absolutePath.slice(0,this.absolutePathIndexes[this.absolutePathIndexes.length-t]),this.absolutePathIndexes.splice(this.absolutePathIndexes.length-t))},ke.addToAbsolutePath=function(t){for(var e=0;e<t.length;e++)this.absolutePathIndexes.push(this.absolutePath.length),this.absolutePath+=" L"+ +t[e].x.toFixed(6)+" "+ +t[e].y.toFixed(6)},ke.appendToBuffer=function(t){for(this.buffer.push(t);this.buffer.length>this.bufferSize;)this.buffer.shift()},ke.amendPath=function(){var t=this.getAveragePoint(0);if(t){this.movementsLastIndex&&(this.removeFromAbsolutePath(this.movements.length-this.movementsLastIndex),this.movements.splice(this.movementsLastIndex));var e=[t];this.movementsLastIndex=this.movements.length+1;for(var i=2;i<this.buffer.length;i+=2){var s=this.getAveragePoint(i);e.push(s)}this.addToAbsolutePath(e),this.movements.push.apply(this.movements,e)}},ke.getAveragePoint=function(t){var e=this.buffer.length;if(e%2==1||e>=this.bufferSize){for(var i,s=0,o=0,n=0,r=t;r<e;r++)n++,s+=(i=this.buffer[r]).x,o+=i.y;return{x:s/n,y:o/n}}return null},we.prototype=Object.create(x.prototype),we.prototype.constructor=we;var Ee=we.prototype;function Ae(t,e,i,s,o,n){x.call(this,t,"SET-FREEHAND",e.id),this.position=i,this.size=s,this.locations=n?o:o.slice(0),this.isAbsoluteCoords=n}Ee.redo=function(){this.createFreehand.undo()},Ee.undo=function(){this.createFreehand.redo()},Ae.prototype=Object.create(x.prototype),Ae.prototype.constructor=Ae;var be=Ae.prototype;function Te(t){Me.call(this,t,d,["stroke-width","stroke-color","stroke-opacity"])}be.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.set(this.position,this.size,this.locations,this.isAbsoluteCoords)},be.undo=function(){},be.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.locations=t.isAbsoluteCoords?t.locations:t.locations.slice(0),this.position=t.position,this.size=t.size,this.isAbsoluteCoords=t.isAbsoluteCoords,!0)},be.isIdentity=function(){return!1},Te.prototype=Object.create(Me.prototype),Te.prototype.constructor=Te;var Ce=Te.prototype;function Se(t,e){xe.call(this,t,e),this.type=d}function Ie(t,e,i,s,o,n,r){x.call(this,t,"CREATE-FREEHAND",e),this.selectOnExecution=!1,this.position=i,this.size=s,this.rotation=o,this.movements=n.slice(0),this.style=w(r)}Ce.createPen=function(t,e,i,s,o){return new Ie(this.editor,t,e,i,s,o,this.style)},Ce.deletePen=function(t){return new we(this.editor,t)},Ce.setPen=function(t,e,i,s){return new Ae(this.editor,this.selectedMarkup,t,e,i,s)},Se.prototype=Object.create(xe.prototype),Se.prototype.constructor=Se,Se.prototype.getEditMode=function(){return new Te(this.editor)},Ie.prototype=Object.create(x.prototype),Ie.prototype.constructor=Ie;var ze=Ie.prototype;function Pe(t,e){x.call(this,t,"DELETE-POLYLINE",e.id),this.createPolyline=new _e(t,e.id,e.position,e.size,e.rotation,e.locations,e.getStyle(),e.closed)}ze.redo=function(){var t=this.editor,e=new Se(this.targetId,t);t.addMarkup(e),e.set(this.position,this.size,this.movements,!1),e.setRotation(this.rotation),e.setStyle(this.style)},ze.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)},Pe.prototype=Object.create(x.prototype),Pe.prototype.constructor=Pe;var De=Pe.prototype;function He(t,e,i,s,o,n){x.call(this,t,"SET-POLYLINE",e.id),this.position=i,this.size=s,this.locations=o.concat(),this.closed=n}De.redo=function(){this.createPolyline.undo()},De.undo=function(){this.createPolyline.redo()},He.prototype=Object.create(x.prototype),He.prototype.constructor=He;var Le=He.prototype;Le.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.set(this.position,this.size,this.locations,this.closed)},Le.undo=function(){},Le.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.locations=t.locations.concat(),this.position=t.position,this.size=t.size,this.closed=t.closed,!0)},Le.isIdentity=function(){return!1};function Ne(t){j.call(this,t,p,["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity"]),this.creationMethod=this.CREATION_METHOD_CLICKS,this.movements=[]}Ne.prototype=Object.create(j.prototype),Ne.prototype.constructor=Ne;var Re=Ne.prototype;function Be(t,e){var i=function(t,e){var i=t.map((function(t){return t[e]}));return Math.min.apply(null,i)},s=function(t,e){var i=t.map((function(t){return t[e]}));return Math.max.apply(null,i)},o=i(t,"x"),n=i(t,"y"),r=s(t,"x")-o,a=s(t,"y")-n;e.size={x:r,y:a},e.position={x:o+.5*r,y:n+.5*a};var h=e.position;return t.map((function(t){return{x:t.x-h.x,y:t.y-h.y}}))}function Ve(t,e){O.call(this,t,e,["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity"]),this.addMarkupMetadata=Ki.bind(this),this.type=p,this.shape=Bi("path"),this.bindDomEvents()}Re.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type==this.type){var i=this.movements;if(!(this.creating&&i.length>=2)){var s=new Pe(this.editor,t);return s.addToHistory=!e,s.execute(),this.creationEnd(),!0}i.pop(),i.pop();var o=i.length-1;if(o>=0){var n=i[o];i.push(n);var r=Be(i,this);new He(this.editor,t,this.position,this.size,r).execute()}}return!1},Re.onMouseMove=function(t){if(!j.prototype.onMouseMove.call(this,t))return!1;var e=this.selectedMarkup,i=this.editor;this.dragging=!0;var s=this.movements;s.splice(s.length-1,1);var o=i.getMousePosition();o=i.clientToMarkups(o.x,o.y),s.length>=2&&ls(s[0],o,25,this.editor)&&(o=s[0]),s.push(o);var n=Be(s,this);return new He(i,e,this.position,this.size,n).execute(),!0},Re.onMouseDown=function(t){if(j.prototype.onMouseDown.call(this),(!this.selectedMarkup||this.creating)&&!this.creating){var e=this.editor,i=e.getMousePosition();i=e.clientToMarkups(i.x,i.y);var s=this.size=e.sizeFromClientToMarkups(1,1);this.movements=[i,i],e.beginActionGroup();var o=e.getId();new _e(e,o,i,s,0,[{x:0,y:0}],this.style).execute(),this.selectedMarkup=e.getMarkup(o),this.creationBegin()}},Re.onMouseUp=function(){if(j.prototype.onMouseUp.call(this),this.creating){this.dragging=!1;var t=this.editor,e=t.getMousePosition(),i=this.movements,s=!1;if(e=t.clientToMarkups(e.x,e.y),!(i.length>1&&ls(i[i.length-2],e,25,this.editor))){i.length>2&&ls(i[0],e,25,this.editor)&&(e=i[0],s=!0),i.splice(i.length-1,1),s||(i.push(e),i.push(e));var o=this.selectedMarkup,n=Be(i,o);new He(t,o,o.position,o.size,n,s).execute(),s&&this.creationEnd()}}},Re.destroy=function(){this.onMouseDoubleClick(),j.prototype.creationEnd.call(this),j.prototype.destroy.call(this)},Re.creationEnd=function(){this.selectedMarkup&&(this.size.x=this.selectedMarkup.size.x,this.size.y=this.selectedMarkup.size.y),j.prototype.creationEnd.call(this),this.closed=!1,this.movements=[],this.dragging=!1,this.creating=!1},Re.creationCancel=function(){j.prototype.creationCancel.call(this),this.closed=!1,this.movements=[],this.dragging=!1,this.creating=!1},Re.onMouseDoubleClick=function(t){if(this.creating){var e=this.movements;if(e.splice(Math.max(0,e.length-1)),e.length<2)this.creationCancel();else{var i=this.selectedMarkup,s=Be(e,i);new He(this.editor,i,i.position,i.size,s,this.closed).execute(),this.creationEnd()}}},Ve.prototype=Object.create(O.prototype),Ve.prototype.constructor=Ve;var Oe=Ve.prototype;function _e(t,e,i,s,o,n,r,a){x.call(this,t,"CREATE-POLYLINE",e),this.selectOnExecution=!1,this.position=i,this.size=s,this.rotation=o,this.movements=n.concat(),this.closed=a,this.style=w(r)}Oe.getEditMode=function(){return new Ne(this.editor)},Oe.set=function(t,e,i,s){this.rotation=0,this.locations=i.concat(),this.size.x=0===e.x?1:e.x,this.size.y=0===e.y?1:e.y,this.closed=s,this.setSize(t,e.x,e.y),this.updateStyle()},Oe.updateStyle=function(){var t=this.style,e=this.shape,i=this.style["stroke-width"],s=this.highlighted?this.highlightColor:xs(t["stroke-color"],t["stroke-opacity"]),o=this.closed?xs(t["fill-color"],t["fill-opacity"]):"none",n=this.getTransform();Vi(e,"d",this.getPath().join(" ")),Vi(e,"stroke-width",i),Vi(e,"stroke",s),Vi(e,"fill",o),Vi(e,"transform",n),Oi(e,this.editor)},Oe.setSize=function(t,e,i){e=0===e?1:e,i=0===i?1:i;for(var s=this.locations,o=s.length,n=e/this.size.x,r=i/this.size.y,a=0;a<o;++a){var h=s[a];h.x*=n,h.y*=r}this.position.x=t.x,this.position.y=t.y,this.size.x=e,this.size.y=i,this.updateStyle()},Oe.setMetadata=function(){var t=w(this.style);return t.type=this.type,t.position=[this.position.x,this.position.y].join(" "),t.size=[this.size.x,this.size.y].join(" "),t.rotation=String(this.rotation),t.locations=this.locations.map((function(t){return[t.x,t.y].join(" ")})).join(" "),this.addMarkupMetadata(this.shape,t)},Oe.getPath=function(){var t=[],e=this.locations,i=e.length;if(0===i)return" ";t.push("M"),t.push(e[0].x),t.push(e[0].y);for(var s=1;s<i;++s){var o=e[s-1],n=e[s];t.push("l"),t.push(n.x-o.x),t.push(n.y-o.y)}return this.closed&&t.push("z"),t},_e.prototype=Object.create(x.prototype),_e.prototype.constructor=_e;var Fe=_e.prototype;function Ue(t,e){x.call(this,t,"DELETE-POLYCLOUD",e.id),this.createPolycloud=new Ze(t,e.id,e.position,e.size,e.rotation,e.locations,e.getStyle(),e.closed)}Fe.redo=function(){var t=this.editor,e=new Ve(this.targetId,t);t.addMarkup(e),e.set(this.position,this.size,this.movements,this.closed),e.setRotation(this.rotation),e.setStyle(this.style)},Fe.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)},Ue.prototype=Object.create(x.prototype),Ue.prototype.constructor=Ue;var je=Ue.prototype;function Ge(t,e,i,s,o,n){x.call(this,t,"SET-POLYCLOUD",e.id),this.position=i,this.size=s,this.locations=o.concat(),this.closed=n}je.redo=function(){this.createPolycloud.undo()},je.undo=function(){this.createPolycloud.redo()},Ge.prototype=Object.create(x.prototype),Ge.prototype.constructor=Ge;var We=Ge.prototype;We.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.set(this.position,this.size,this.locations,this.closed)},We.undo=function(){},We.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.locations=t.locations.concat(),this.position=t.position,this.size=t.size,this.closed=t.closed,!0)},We.isIdentity=function(){return!1};function Ke(t){j.call(this,t,y,["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity"]),this.creationMethod=this.CREATION_METHOD_CLICKS,this.movements=[]}Ke.prototype=Object.create(j.prototype),Ke.prototype.constructor=Ke;var Ye=Ke.prototype;function Xe(t,e){var i=function(t,e){var i=t.map((function(t){return t[e]}));return Math.min.apply(null,i)},s=function(t,e){var i=t.map((function(t){return t[e]}));return Math.max.apply(null,i)},o=e.style["stroke-width"],n=2*o+.5*o,r=i(t,"x")-n,a=i(t,"y")-n,h=s(t,"x")+n-r,l=s(t,"y")+n-a;e.size={x:h,y:l},e.position={x:r+.5*h,y:a+.5*l};var u=e.position;return t.map((function(t){return{x:t.x-u.x,y:t.y-u.y}}))}function qe(t,e){O.call(this,t,e,["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity"]),this.addMarkupMetadata=Ki.bind(this),this.type=y,this.locations=[],this.shape=Bi(),this.bindDomEvents()}Ye.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type==this.type){var i=this.movements;if(!(this.creating&&i.length>=2)){var s=new Ue(this.editor,t);return s.addToHistory=!e,s.execute(),this.creationEnd(),!0}i.pop(),i.pop();var o=i.length-1;if(o>=0){var n=i[o];i.push(n);var r=Xe(i,this);new Ge(this.editor,t,this.position,this.size,r).execute()}}return!1},Ye.onMouseMove=function(t){if(!j.prototype.onMouseMove.call(this,t))return!1;var e=this.selectedMarkup,i=this.editor;this.dragging=!0;var s=this.movements;s.splice(s.length-1,1);var o=i.getMousePosition();o=i.clientToMarkups(o.x,o.y),s.length>=2&&ls(s[0],o,25,this.editor)&&(o=s[0]),s.push(o);var n=Xe(s,this);return new Ge(i,e,this.position,this.size,n).execute(),!0},Ye.onMouseDown=function(){if(j.prototype.onMouseDown.call(this),(!this.selectedMarkup||this.creating)&&!this.creating){var t=this.editor,e=t.getMousePosition();e=t.clientToMarkups(e.x,e.y);var i=this.size=t.sizeFromClientToMarkups(1,1);this.movements=[e,e],t.beginActionGroup();var s=t.getId();new Ze(t,s,e,i,0,[{x:0,y:0}],this.style).execute(),this.selectedMarkup=t.getMarkup(s),this.creationBegin()}},Ye.onMouseUp=function(t){if(j.prototype.onMouseUp.call(this),this.creating){this.dragging=!1;var e=this.editor,i=e.getMousePosition(),s=this.movements,o=!1;if(i=e.clientToMarkups(i.x,i.y),!(s.length>1&&ls(s[s.length-2],i,25,this.editor))){s.length>2&&ls(s[0],i,25,this.editor)&&(i=s[0],o=!0),s.splice(s.length-1,1),o||(s.push(i),s.push(i));var n=this.selectedMarkup,r=Xe(s,n);new Ge(e,n,n.position,n.size,r,o).execute(),o&&this.creationEnd()}}},Ye.onMouseDoubleClick=function(t){if(this.creating){var e=this.movements;if(e.splice(Math.max(0,e.length-1)),e.length<2)this.creationCancel();else{var i=this.selectedMarkup,s=Xe(e,i);new Ge(this.editor,i,i.position,i.size,s,!0).execute(),this.creationEnd()}}},Ye.destroy=function(){this.onMouseDoubleClick(),j.prototype.creationEnd.call(this),j.prototype.destroy.call(this)},Ye.creationEnd=function(){this.selectedMarkup&&(this.size.x=this.selectedMarkup.size.x,this.size.y=this.selectedMarkup.size.y),j.prototype.creationEnd.call(this),this.closed=!1,this.movements=[],this.dragging=!1,this.creating=!1},Ye.creationCancel=function(){j.prototype.creationCancel.call(this),this.closed=!1,this.movements=[],this.dragging=!1,this.creating=!1},qe.prototype=Object.create(O.prototype),qe.prototype.constructor=qe;var $e=qe.prototype;function Ze(t,e,i,s,o,n,r,a){x.call(this,t,"CREATE-POLYCLOUD",e),this.selectOnExecution=!1,this.position=i,this.size=s,this.rotation=o,this.movements=n.concat(),this.style=w(r),this.closed=a}$e.getEditMode=function(){return new Ke(this.editor)},$e.set=function(t,e,i,s){this.rotation=0,this.locations=i.concat(),this.size.x=0===e.x?1:e.x,this.size.y=0===e.y?1:e.y,this.closed=s,this.setSize(t,e.x,e.y),this.updateStyle()},$e.updateStyle=function(){var t=this.style,e=this.shape,i=this.getPath().join(" "),s=this.style["stroke-width"],o=this.highlighted?this.highlightColor:xs(t["stroke-color"],t["stroke-opacity"]),n=this.closed?xs(t["fill-color"],t["fill-opacity"]):"none",r=this.getTransform();Vi(e,"d",i),Vi(e,"stroke-width",s),Vi(e,"stroke",o),Vi(e,"fill",n),Vi(e,"transform",r),Oi(e,this.editor)},$e.setSize=function(t,e,i){e=0===e?1:e,i=0===i?1:i;for(var s=this.locations,o=s.length,n=e/this.size.x,r=i/this.size.y,a=0;a<o;++a){var h=s[a];h.x*=n,h.y*=r}this.position.x=t.x,this.position.y=t.y,this.size.x=e,this.size.y=i,this.updateStyle()},$e.setMetadata=function(){var t=w(this.style);return t.type=this.type,t.position=[this.position.x,this.position.y].join(" "),t.size=[this.size.x,this.size.y].join(" "),t.rotation=String(this.rotation),t.locations=this.locations.map((function(t){return[t.x,t.y].join(" ")})).join(" "),this.addMarkupMetadata(this.shape,t)},$e.getPath=function(){function t(t,e,i,s){var o=e.radius,n=i.radius,r=t.length;if(o>0&&n>0&&o+n>r&&Math.abs(o-n)<r){var a=t.pointA.x,h=t.pointA.y,l=t.pointB.x,u=t.pointB.y,d=.25*Math.sqrt((r+o+n)*(r+o-n)*(r-o+n)*(-r+o+n)),c=(a+l)/2+(l-a)*(o*o-n*n)/(2*r*r),p=2*(h-u)/(r*r)*d,y=(h+u)/2+(u-h)*(o*o-n*n)/(2*r*r),g=2*(a-l)/(r*r)*d,v=c+p,f=c-p,x=y-g,m=y+g;if(Math.abs((v-a)*(v-a)+(x-h)*(x-h)-o*o)>1e-7){var M=x;x=m,m=M}var k=new THREE.Vector3(v,x,0);return Math.sign(k.clone().sub(t.pointA).cross(t.vecAB).z)!==s&&k.set(f,m,0),e.pointB=k.clone(),i.pointA=k.clone(),!0}return!1}function e(t,e,i){var s=t.bodyCount;if(0!==s){var o=t.bodyRadius,n=t.bodyDiameter,r=.05*n,a=3.5*o/3,h=new THREE.Vector3(r,e*-a),l=new THREE.Vector3(n-r,e*-a),u=new THREE.Vector3(n,0),d=Math.acos(t.vecAB.x)*(t.vecAB.y<0?-1:1),c=(new THREE.Matrix4).makeRotationZ(d);h.applyMatrix4(c),l.applyMatrix4(c),u.applyMatrix4(c);for(var p=0;p<s;++p)i.push("c"),i.push(h.x),i.push(h.y),i.push(l.x),i.push(l.y),i.push(u.x),i.push(u.y)}}function i(t,e,i,s){e&&(s.push("M"),s.push(t.pointA.x),s.push(t.pointA.y));var o=1===i?t.large:!t.large;return 0!==t.radius&&(s.push("a"),s.push(t.radius),s.push(t.radius),s.push(0),s.push(o?1:0),s.push(1===i?1:0),s.push(t.pointB.x-t.pointA.x),s.push(t.pointB.y-t.pointA.y)),s}var s=2*this.style["stroke-width"],o=function(t){switch(t.length){case 0:case 1:return 1;case 2:var e=t[0],i=t[1];return e.y>i.y?1:-1;default:var s=t[0],o=t[1],n=t[2];return(o.x-s.x)*(o.y+s.y)+(n.x-o.x)*(n.y+o.y)<0?1:-1}}(this.locations),n=this.closed,r=[],a=function(t,e){for(var i=t.length,s=[],o=i-(e?0:1),n=0;n<o;++n){var r=t[n],a=t[(n+1)%i],h=a.x-r.x,l=a.y-r.y,u=Math.sqrt(h*h+l*l);s.push({index:n,pointA:new THREE.Vector3(r.x,r.y,0),pointB:new THREE.Vector3(a.x,a.y,0),vecAB:new THREE.Vector3(h/u,l/u,0),vecBA:new THREE.Vector3(-h/u,-l/u,0),length:u})}return s}(this.locations,n),h=function(t,e,i){for(var s=[],o=t.length,n=0;n<o;++n){var r=t[0!==n?n-1:o-1],a=t[n],h=r.vecBA.clone().cross(a.vecAB).z<0;r.length<e||a.length<e||0===n&&!i?s.push({pointA:a.pointA.clone(),pointB:a.pointA.clone(),radius:0,large:!1}):s.push({pointA:a.pointA.clone().add(r.vecBA.clone().multiplyScalar(e)),pointB:a.pointA.clone().add(a.vecAB.clone().multiplyScalar(e)),radius:e,large:h})}return s}(a,s,n),l=h.length;!function(e,i,s,o){for(var n=2*s,r=e.length,a=0;a<r;++a){var h=e[a],l=i[a],u=i[(a+1)%r];h.bodyA=h.vecAB.clone().multiplyScalar(l.radius).add(h.pointA),h.bodyB=h.vecBA.clone().multiplyScalar(u.radius).add(h.pointB),t(h,l,u,o)?(h.body=0,h.bodyDiameter=h.bodyCount=0):(h.body=h.bodyB.clone().sub(h.bodyA).length(),h.bodyCount=Math.round(h.body/n),0===h.bodyCount&&h.body>.5*s&&(h.bodyCount=1),h.bodyDiameter=n+(h.body-n*h.bodyCount)/h.bodyCount),h.bodyRadius=.5*h.bodyDiameter}}(a,h,s,o);for(var u=0;u<l;++u)i(h[u],0===u,o,r),e(a[u],o,r);return n&&r.push("z"),r},Ze.prototype=Object.create(x.prototype),Ze.prototype.constructor=Ze;var Qe=Ze.prototype;function Je(t,e){x.call(this,t,"DELETE-HIGHLIGHT",e.id),this.createHighlight=new ri(t,e.id,e.position,e.size,e.rotation,e.locations,e.getStyle())}Qe.redo=function(){var t=this.editor,e=new qe(this.targetId,t);t.addMarkup(e),e.set(this.position,this.size,this.movements,this.closed),e.setRotation(this.rotation),e.setStyle(this.style)},Qe.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)},Je.prototype=Object.create(x.prototype),Je.prototype.constructor=Je;var ti=Je.prototype;function ei(t,e,i,s,o,n){x.call(this,t,"SET-HIGHLIGHT",e.id),this.position=i,this.size=s,this.locations=n?o:o.slice(0),this.isAbsoluteCoords=n}ti.redo=function(){this.createHighlight.undo()},ti.undo=function(){this.createHighlight.redo()},ei.prototype=Object.create(x.prototype),ei.prototype.constructor=ei;var ii=ei.prototype;function si(t){Me.call(this,t,c,["stroke-width","stroke-color","stroke-opacity"]);var e=t.getStrokeWidth();this.style["stroke-opacity"]=.5,this.style["stroke-color"]="#ffff00",this.style["stroke-width"]=4*e}ii.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.set(this.position,this.size,this.locations,this.isAbsoluteCoords)},ii.undo=function(){},ii.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.locations=t.isAbsoluteCoords?t.locations:t.locations.slice(0),this.position=t.position,this.size=t.size,this.isAbsoluteCoords=t.isAbsoluteCoords,!0)},ii.isIdentity=function(){return!1},si.prototype=Object.create(Me.prototype),si.prototype.constructor=si;var oi=si.prototype;function ni(t,e){xe.call(this,t,e),this.type=c}function ri(t,e,i,s,o,n,r){x.call(this,t,"CREATE-HIGHLIGHT",e),this.selectOnExecution=!1,this.position=i,this.size=s,this.rotation=o,this.movements=n.slice(0),this.style=w(r)}oi.createPen=function(t,e,i,s,o){return new ri(this.editor,t,e,i,s,o,this.style)},oi.deletePen=function(t){return new Je(this.editor,t)},oi.setPen=function(t,e,i,s){return new ei(this.editor,this.selectedMarkup,t,e,i,s)},ni.prototype=Object.create(xe.prototype),ni.prototype.constructor=ni,ni.prototype.getEditMode=function(){return new si(this.editor)},ri.prototype=Object.create(x.prototype),ri.prototype.constructor=ri;var ai=ri.prototype;function hi(t,e){x.call(this,t,"DELETE-DIMENSION",e.id),this.createDimension=new xi(t,e.id,e.secondAnchor,e.firstAnchor,e.currentText,e.getStyle())}ai.redo=function(){var t=this.editor,e=new ni(this.targetId,t);t.addMarkup(e),e.set(this.position,this.size,this.movements,!1),e.setRotation(this.rotation),e.setStyle(this.style)},ai.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)},hi.prototype=Object.create(x.prototype),hi.prototype.constructor=hi;var li=hi.prototype;function ui(t,e,i,s,o){x.call(this,t,"SET-DIMENSION",e.id),this.newFirstAnchor={x:i.x,y:i.y},this.newSecondAnchor={x:s.x,y:s.y},this.oldFirstAnchor={x:e.firstAnchor.x,y:e.firstAnchor.y},this.oldSecondAnchor={x:e.secondAnchor.x,y:e.secondAnchor.y},this.newText=o,this.oldText=e.currentText}li.redo=function(){this.createDimension.undo()},li.undo=function(){this.createDimension.redo()},ui.prototype=Object.create(x.prototype),ui.prototype.constructor=ui;var di=ui.prototype;di.redo=function(){this.applyState(this.newFirstAnchor,this.newSecondAnchor,this.newText)},di.undo=function(){this.applyState(this.oldFirstAnchor,this.oldSecondAnchor,this.oldText)},di.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.newFirstAnchor=t.newFirstAnchor,this.newSecondAnchor=t.newSecondAnchor,this.newText=t.newText,!0)},di.applyState=function(t,e,i){var s=this.editor.getMarkup(this.targetId);s&&s.set(t.x,t.y,e.x,e.y,i)},di.isIdentity=function(){return this.newText===this.oldText&&(!this.newFirstAnchor||!this.newSecondAnchor||this.newFirstAnchor.x===this.oldFirstAnchor.x&&this.newFirstAnchor.y===this.oldFirstAnchor.y&&this.newSecondAnchor.x===this.oldSecondAnchor.x&&this.newSecondAnchor.y===this.oldSecondAnchor.y)};var ci,pi=Autodesk.Viewing.MeasureCommon;function yi(t){var e=this;j.call(this,t,v,["stroke-width","stroke-color","stroke-opacity","font-size","font-family","font-style","font-weight"]),this.onHistoryChangeBinded=this.onHistoryChange.bind(this),this.measurement=new pi.Measurement(pi.MeasurementTypes.MEASUREMENT_DISTANCE);var i=this.viewer,s=i.getExtension("Autodesk.Measure");function o(){e.cancelEditModeChange=!0,t.enterEditMode()}s||(console.error("Demension markup cant work without measure extension. Please load measure extension first"),o()),this.sharedMeasureConfig=s.sharedMeasureConfig,(s.forceCalibrate||i.model.isLeaflet()||i.model.isPdf(!0))&&!s.calibrationTool.isCalibrated()&&(s.openCalibrationRequiredDialog("dimension"),o())}yi.prototype=Object.create(j.prototype),yi.prototype.constructor=yi;var gi=yi.prototype;gi.deleteMarkup=function(t,e){if((t=t||this.selectedMarkup)&&t.type==this.type){var i=new hi(this.editor,t);return i.addToHistory=!e,i.execute(),this.creating=!1,this.dragging=!1,!0}return!1},gi.updateTextBoxStyle=function(t){this.isTextInputHelperActive()&&(t||(t=this.textInputHelper.textMarkup.getStyle()),this.textInputHelper.setStyle(t),this.updateTextBox(this.textInputHelper.textMarkup))},gi.setStyle=function(t){j.prototype.setStyle.call(this,t),this.updateTextBoxStyle(t)},gi.notifyAllowNavigation=function(t){t&&this.isTextInputHelperActive()&&this.textInputHelper.acceptAndExit()},gi.creationBegin=function(){j.prototype.creationBegin.call(this)},gi.creationEnd=function(){this.dragging=!1,j.prototype.creationEnd.call(this)},gi.isMinSizeValid=function(){if(0!==this.minSize){var t=this.editor.sizeFromMarkupsToClient(this.selectedMarkup.size.x,this.selectedMarkup.size.y);return t.x*t.x>=this.minSize*this.minSize}return!0},gi.creationCancel=function(){j.prototype.creationCancel.call(this),this.creating=!1,this.dragging=!1},gi.destroy=function(){this.textInputHelper&&(this.textInputHelper.isActive()&&this.textInputHelper.acceptAndExit(),this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded),this.textInputHelper.destroy(),this.textInputHelper=null),this.updateViewportId(),j.prototype.destroy.call(this)},gi.getDistance=function(){if(this.measurement.computeResult(this.measurement.picks,this.viewer),this.viewer.model&&this.measurement.distanceXYZ){var t=Autodesk.Viewing.Private.convertUnits(this.viewer.model.getUnitString(),this.sharedMeasureConfig.units,this.sharedMeasureConfig.calibrationFactor,this.measurement.distanceXYZ);return Autodesk.Viewing.Private.formatValueWithUnits(t,this.sharedMeasureConfig.units,3,this.sharedMeasureConfig.precision)}return null},gi.updateMeasurement=function(t){var e=this.editor,i=this.measurement.getPick(t);return ci?(i.geomType=pi.SnapType.SNAP_VERTEX,i.geomVertex=ci,i.intersectPoint=ci):e.snapper.copyResults(i),i},gi.updateViewportId=function(t){this.viewer.model&&this.viewer.model.is2d()&&(t?(this.viewer.impl.updateViewportId(t),this.editor.snapper.setViewportId(t)):(this.viewer.impl.updateViewportId(0),this.editor.snapper.setViewportId(null)))},gi.pickFirstAnchor=function(){var t=this.editor;this.measurement.clearAllPicks();var e=t.getMousePosition();this.initialX=e.x,this.initialY=e.y,this.firstAnchor=t.positionFromClientToMarkups(this.initialX,this.initialY),t.beginActionGroup();var i=t.getId();new xi(t,i,this.firstAnchor,null,this.currentText,this.style).execute(),this.selectedMarkup=t.getMarkup(i),this.creationBegin();var s=this.updateMeasurement(1);this.updateViewportId(s.viewportIndex2d)},gi.pickSecondAnchor=function(t){var e=this.editor,i=this.selectedMarkup;if(this.secondAnchor=this.getFinalMouseDraggingPosition(),this.updateMeasurement(2),pi.correctPerpendicularPicks(this.measurement.getPick(1),this.measurement.getPick(2),this.viewer,e.snapper)){var s=pi.getSnapResultPosition(this.measurement.getPick(2),this.viewer);this.secondAnchor=e.project(s),e.snapper.indicator.render()}var o=e.positionFromClientToMarkups(this.secondAnchor.x,this.secondAnchor.y);this.size.x=i.size.x,this.size.y=i.size.y,i.currentText=this.getDistance(),new ui(e,i,this.firstAnchor,o,i.currentText).execute(),new F(e,i,this.style).execute(),t&&!i.currentText&&this.isMinSizeValid()&&(i.currentText="",this.editor.selectMarkup(null),this.updateTextBox(i))},gi.onMouseDown=function(t){if(!Autodesk.Viewing.Private.isRightClick(t,this.viewer.navigation))if(ci=null,this.isTextInputHelperActive())this.textInputHelper.acceptAndExit();else if(j.prototype.onMouseDown.call(this),!this.selectedMarkup||this.creating){var e=this.editor.snapper.isSnapped();this.selectedMarkup||this.creating||!e?this.selectedMarkup&&this.creating&&(e?this.pickSecondAnchor(!0):(this.deleteMarkup(this.selectedMarkup,!0),this.creating=!0),this.updateViewportId(),this.creationEnd()):this.pickFirstAnchor()}},gi.onMouseUp=function(t){this.dragging&&(this.onMouseDown(t),this.dragging=!1)},gi.onMouseMove=function(t){ci=null,this.selectedMarkup&&this.creating&&(this.dragging=!0,this.pickSecondAnchor(!1))},gi.getFinalMouseDraggingPosition=function(){var t=this.editor,e=t.getBounds(),i=t.getMousePosition();t.snapper.isSnapped()||t.viewer.model&&t.viewer.model.is2d()&&(ci=pi.inverseProject(i,t.viewer));var s=this.initialX,o=this.initialY,n=Math.min(Math.max(e.x,i.x),e.x+e.width),r=Math.min(Math.max(e.y,i.y),e.y+e.height);(n==s&&r==o&&(n++,r++),t.input.constrainAxis&&t.viewer.model.is2d())&&(Math.abs(n-s)>Math.abs(r-o)?r=o:n=s,t.snapper.onMouseMove({x:n,y:r}),t.snapper.isSnapped()?(t.snapper.copyResults(this.measurement.getPick(2)),ci=null):ci=pi.inverseProject({x:n,y:r},t.viewer));return{x:n,y:r}},gi.isVisibleChar=function(t){return t>47&&t<58||32==t||t>64&&t<91||t>95&&t<112||t>185&&t<193||t>218&&t<223},gi.measureTextLine=function(t,e,i){return t=0===(t=t.replace(new RegExp(" ","g"),"")).length?e.initialText:t,Es([t+"|"],this.style,i)[0]},gi.handleKeyDown=function(t){var e=this.textInputHelper;if(t.keyCode!==Autodesk.Viewing.KeyCode.ENTER){var i=e.textMarkup,s=e.textArea.value;t.keyCode===Autodesk.Viewing.KeyCode.BACKSPACE&&(s=s.substring(0,s.length-1)),s.length<15&&this.isVisibleChar(t.keyCode)&&(s+=t.key);var o=this.measureTextLine(s,i,this.editor);this.updateTextBox(i,o)}},gi.updateTextBox=function(t,e){this.textInputHelper||(this.textInputHelper=new zt(this.viewer.container,this.editor,!0,t.initialText,15),this.textInputHelper.addEventListener(this.textInputHelper.EVENT_TEXT_CHANGE,this.onHelperTextChange.bind(this),!1),this.handleKeyDownBinded=this.handleKeyDown.bind(this)),t.text.style.display="none",e||(e=this.measureTextLine(this.textInputHelper.textArea.value,t,this.editor));var i=this.getTextAreaTransform(t,e);this.textInputHelper.styleTextArea.setAttribute("text-align","center"),this.textInputHelper.setActive(t,!1),this.textInputHelper.textArea.style.position="static",this.textInputHelper.textArea.style.padding="0",this.textInputHelper.textArea.style.width=e.width+"px",this.textInputHelper.textArea.style.height=e.height+"px",this.textInputHelper.textArea.style.transform=i,this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded),this.editor.actionManager.addEventListener(D,this.onHistoryChangeBinded),this.textInputHelper.textArea.removeEventListener("keydown",this.handleKeyDownBinded),this.textInputHelper.textArea.addEventListener("keydown",this.handleKeyDownBinded)},gi.getTextAreaTransform=function(t,e){var i=t.getClientPosition(),s=rs(t.rotation)%360;return s>90&&s<=270&&t.shouldFlip()&&(s=180+s),["translate(",i.x-e.width/2+"px,",i.y-this.viewer.container.clientHeight-e.height+"px)","rotate(",s+"deg)","translate(0px,",e.height+"px)"].join(" ")},gi.onMouseDoubleClick=function(t){t===this.selectedMarkup&&(this.editor.selectMarkup(null),this.updateTextBox(t))},gi.onHelperTextChange=function(t){var e=t.data,i=e.markup,s=e.style,o=this.editor;i.text.style.display="block",""===e.newText&&(e.newText=i.initialText),e.firstEdit||o.beginActionGroup(),new F(o,i,s).execute(),new ui(o,i,i.firstAnchor,i.secondAnchor,e.newText).execute(),o.closeActionGroup(),o.selectMarkup(null)},gi.onHistoryChange=function(t){this.isTextInputHelperActive()&&(this.textInputHelper.textMarkup.text.style.display="block",this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded),this.textInputHelper.setInactive())},gi.onSave=function(){if(j.prototype.onSave.call(this),this.isTextInputHelperActive()){this.editor.actionManager.removeEventListener(D,this.onHistoryChangeBinded);var t=this.textInputHelper.textMarkup;this.textInputHelper.acceptAndExit(),t.text.style.display="block"}},gi.useWithSnapping=function(){return!0};function vi(t,e){O.call(this,t,e,["stroke-width","stroke-color","stroke-opacity","font-size","font-family","font-style","font-weight"]),this.type=v,this.constraintHeight=!0,this.constraintWidth=!0,this.addMarkupMetadata=Ki.bind(this),this.createSvgElement=Li.bind(this),this.checkLineSegment=ms.bind(this),this.measureTextLines=Es.bind(this),this.firstAnchor=new THREE.Vector3,this.secondAnchor=new THREE.Vector3,this.shape=Bi(),this.text=_i(),this.shape.appendChild(this.text),this.textSize={x:0,y:0},this.initialText="Add Length",this.currentText=" ",this.viewer.model.is2d()||(this.preventReposition=!0,this.constraintRotation=!0),this.bindDomEvents()}vi.prototype=Object.create(O.prototype),vi.prototype.constructor=vi;var fi=vi.prototype;function xi(t,e,i,s,o,n){x.call(this,t,"CREATE-DIMENSION",e),this.selectOnExecution=!1,this.secondAnchor=s,this.firstAnchor=i,this.text=o,this.style=w(n)}fi.getEditMode=function(){return new yi(this.editor)},fi.set=function(t,e,i,s,o){var n=new THREE.Vector2(t,e),r=new THREE.Vector2(i,s),a=r.clone().sub(n).normalize();this.size.x=n.distanceTo(r),this.rotation=Math.acos(a.dot(new THREE.Vector2(1,0))),this.rotation=s>e?2*Math.PI-this.rotation:this.rotation;var h=this.firstAnchor,l=this.secondAnchor;h.set(i,s,0),l.set(t,e,0),this.position.x=l.x+.5*(h.x-l.x),this.position.y=l.y+.5*(h.y-l.y),this.currentText=o,this.updateStyle()},fi.setRotation=function(t){90===rs(t)&&(t=as(-90)),this.rotation=t;var e=Math.cos(-t),i=Math.sin(-t),s=new THREE.Vector2(e,i);s.multiplyScalar(.5*this.size.x);var o=new THREE.Vector2(this.position.x,this.position.y),n=o.clone().sub(s),r=o.clone().add(s);this.firstAnchor.set(r.x,r.y,0),this.secondAnchor.set(n.x,n.y,0),this.updateStyle()},fi.setSize=function(t,e,i){var s=Math.cos(-this.rotation),o=Math.sin(-this.rotation),n=new THREE.Vector2(s,o);n.multiplyScalar(.5*e);var r=new THREE.Vector2(t.x,t.y),a=r.clone().sub(n),h=r.clone().add(n);this.firstAnchor.set(h.x,h.y,0),this.secondAnchor.set(a.x,a.y,0),this.position.x=t.x,this.position.y=t.y,this.size.x=e,this.updateStyle()},fi.getClientFontSize=function(){return this.editor.sizeFromMarkupsToClient(0,this.style["font-size"]).y},fi.updateStyle=function(){var t=this.style,e=this.shape,i=t["stroke-width"],s=this.highlighted?this.highlightColor:xs(t["stroke-color"],t["stroke-opacity"]),o=this.getTransform();this.rebuildTextSvg(this.currentText),Vi(e,"d",this.getPath().join(" ")),Vi(e,"stroke-width",i/2),Vi(e,"stroke",s),Vi(e,"fill",s),Vi(e,"transform",o),Oi(e,this.editor)},fi.rebuildTextSvg=function(t){var e=this.style,i=this.highlighted?this.highlightColor:xs(e["stroke-color"],e["stroke-opacity"]),s=e["stroke-width"],o=this.createSvgElement("text");o.setAttribute("id","markup"),o.setAttribute("alignment-baseline","middle");var n=this.text,r=this.editor;n.childNodes[0].removeChild(n.markup),n.childNodes[0].appendChild(o),n.markup=o;var a=this.createSvgElement("tspan");a.textContent=t,o.appendChild(a);var h=this.measureTextLines([t],e,r)[0],l=this.textSize=r.sizeFromClientToMarkups(h.width,h.height),u=10*s/2,d=2*s/2,c=l.x+2*s>=this.size.x?d+u/2:d;this.size.y=u+l.y+c;var p=this.getTextTransform(.8*l.y+c,!0),y=this.getTextTransform(l.y+c,!1);Vi(n,"font-family",e["font-family"]),Vi(n,"font-size",e["font-size"]),Vi(n,"font-weight",e["font-weight"]),Vi(n,"font-style",e["font-style"]),Vi(n,"text-rendering","auto"),Vi(n,"fill",i),Fi(n,y,p),ji(n,l.x,l.y,"none"),Gi(n,l.x,l.y),Ui(n,l.x,l.y,r)},fi.shouldFlip=function(){return this.firstAnchor.x<this.secondAnchor.x},fi.getTextTransform=function(t,e){var i=this.shouldFlip()?-1:1;return e=e?-1:1,90===rs(this.rotation)&&(this.rotation=as(-90)),["translate(",this.position.x,",",this.position.y,")","rotate(",rs(-this.rotation),")","translate(",-i*this.textSize.x/2,",",-i*t,")","scale("+i+","+i*e+")"].join(" ")},fi.setPosition=function(t,e){var i=this.firstAnchor,s=this.secondAnchor,o=i.x-s.x,n=i.y-s.y,r=t+.5*o,a=e+.5*n;i.x=r,i.y=a,s.x=r-o,s.y=a-n,this.position.x=s.x+.5*(i.x-s.x),this.position.y=s.y+.5*(i.y-s.y),this.updateStyle()},fi.generatePoint3d=function(t){var e=this.editor.positionFromMarkupsToClient(this.firstAnchor.x,this.firstAnchor.y),i=this.editor.positionFromMarkupsToClient(this.secondAnchor.x,this.secondAnchor.y),s=e.clone().sub(i).normalize(),o=this.checkLineSegment(e.x,e.y,e.x+200*s.x,e.y+200*s.y,t),n=o&&this.viewer.clientToWorld(o.x,o.y);return n&&n.point},fi.setMetadata=function(){this.text.setAttribute("pointer-events","none");var t=w(this.style);return t.type=this.type,t.firstAnchor=[this.firstAnchor.x,this.firstAnchor.y].join(" "),t.secondAnchor=[this.secondAnchor.x,this.secondAnchor.y].join(" "),t.text=String(this.currentText),this.addMarkupMetadata(this.shape,t)},fi.getText=function(){return this.currentText===this.initialText?"":this.currentText},fi.getPath=function(){var t=this.style["stroke-width"],e=this.size.x-t/2,i=10*t/2;return["M",.5*-e,0,"l",0,i/2,"l",0,-i/2,"l",e,0,"l",0,i/2,"l",0,-i,"l",0,i/2,"l",-e,0,"l",0,-i/2,"z"]},fi.cloneShape=function(t){t.shape=Bi(),t.text=_i(),t.shape.appendChild(t.text),t.bindDomEvents()},fi.getBoundingRect=function(){var t=this.getClientPosition(),e=this.getClientSize();return{x:t.x-e.x/2,y:t.y-e.y/2,width:e.x,height:e.y}},xi.prototype=Object.create(x.prototype),xi.prototype.constructor=xi;var mi=xi.prototype;mi.redo=function(){var t=this.editor,e=new vi(this.targetId,t);t.addMarkup(e),this.secondAnchor&&(e.set(this.firstAnchor.x,this.firstAnchor.y,this.secondAnchor.x,this.secondAnchor.y,this.text),e.setStyle(this.style))},mi.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)};class Mi extends x{constructor(t,e){super(t,"DELETE-STAMP",e.id),this.createStamp=new Ai(t,e.id,e.position,e.size,e.rotation,e.getStyle())}redo(){this.createStamp.undo()}undo(){this.createStamp.redo()}}class ki extends x{constructor(t,e,i,s){super(t,"SET-STAMP",e.id),this.newPosition={x:i.x,y:i.y},this.newSize={x:s.x,y:s.y},this.oldPosition={x:e.position.x,y:e.position.y},this.oldSize={x:e.size.x,y:e.size.y}}redo(){this.applyState(this.targetId,this.newPosition,this.newSize)}undo(){this.applyState(this.targetId,this.oldPosition,this.oldSize)}merge(t){return this.targetId===t.targetId&&this.type===t.type&&(this.newPosition=t.newPosition,this.newSize=t.newSize,!0)}applyState(t,e,i){const s=this.editor.getMarkup(t);if(!s)return;const o=1e-4;(Math.abs(s.position.x-e.x)>o||Math.abs(s.position.y-e.y)>o||Math.abs(s.size.x-i.x)>o||Math.abs(s.size.y-i.y)>o)&&s.set(e,i)}isIdentity(){return this.newPosition.x===this.oldPosition.x&&this.newPosition.y===this.oldPosition.y&&this.newSize.x===this.oldSize.x&&this.newSize.y==this.newSize.y}}class wi extends j{constructor(t,e){super(t,f,["text-data"]),this.svgData=e}deleteMarkup(t,e){if((t=t||this.selectedMarkup)&&t.type==this.type){var i=new Mi(this.editor,t);return i.addToHistory=!e,i.execute(),!0}return!1}onMouseMove(t){if(!j.prototype.onMouseMove.call(this,t))return!1;const{selectedMarkup:e,editor:i}=this;let s=this.getFinalMouseDraggingPosition();s=i.clientToMarkups(s.x,s.y);let o={x:(this.firstPosition.x+s.x)/2,y:(this.firstPosition.y+s.y)/2},n=this.size={x:Math.abs(s.x-this.firstPosition.x),y:Math.abs(s.y-this.firstPosition.y)};return new ki(i,e,o,n).execute(),!0}onMouseDown(){if(j.prototype.onMouseDown.call(this),this.selectedMarkup)return;const t=this.editor;let e=t.getMousePosition();this.initialX=e.x,this.initialY=e.y,this.firstPosition=t.clientToMarkups(this.initialX,this.initialY),this.size=t.sizeFromClientToMarkups(1,1),t.beginActionGroup();const i=t.getId();new Ai(t,i,this.firstPosition,this.size,0,this.style,this.svgData).execute(),this.selectedMarkup=t.getMarkup(i),this.creationBegin()}}class Ei extends O{constructor(t,e,i){super(t,e,["text-data"]),this.type=f,this.addMarkupMetadata=Ki.bind(this),this.createShapeGroup(),this.scriptSvgData=i,this.loadSvgData(),this.bindDomEvents()}createShapeGroup(){this.shape=Li("g"),this.shape.group=Li("g"),this.shape.appendChild(this.shape.group);let t=Li("path");t.setAttribute("id","hitarea"),t.setAttribute("fill","none"),this.shape.appendChild(t),this.shape.hitarea=t,this.shape.markup=t}loadSvgData(){let t=this.scriptSvgData||this.style["text-data"],e=Zi(t);if(null===e)return void console.warn("SVG data "+t+" is invalid, skipping shape update");let[i,s]=this.getDimensions(e),o=`M 0 0 l ${i} 0 l 0 ${s} l ${-i} 0 z`;this.shape.hitarea.setAttribute("d",o),this.shape.group.innerHTML=e.innerHTML,this.shape.group.setAttribute("transform",`translate( -0.5 , 0.5 ) scale( ${1/i} , ${-1/s} )`),this.shape.hitarea.setAttribute("transform",this.shape.group.getAttribute("transform"))}getEditMode(){return new wi(this.editor)}set(t,e){this.setSize(t,e.x,e.y),this.updateStyle()}updateStyle(t){const e=this.highlighted?this.highlightColor:xs(this.style["stroke-color"],this.style["stroke-opacity"]);this.shape.hitarea.setAttribute("stroke",e);const i=this.getTransform()+` scale( ${this.size.x} , ${this.size.y} )`;this.shape.setAttribute("transform",i),t&&this.loadSvgData()}getDimensions(t){let e=t.getAttribute("viewBox");if(!e){return[t.getAttribute("width")||100,t.getAttribute("height")||100]}let i=e.split(" ");return[parseInt(i[2]),parseInt(i[3])]}setMetadata(){var t=w(this.style);return t.type=this.type,t.position=[this.position.x,this.position.y].join(" "),t.size=[this.size.x,this.size.y].join(" "),t.rotation=String(this.rotation),this.addMarkupMetadata(this.shape,t)}setStyle(t){let e=k(t,this.style);e||M(t,this.style),this.updateStyle(!e)}}class Ai extends x{constructor(t,e,i,s,o,n,r){super(t,"CREATE-STAMP",e),this.selectOnExecution=!1,this.position={x:i.x,y:i.y},this.size={x:s.x,y:s.y},this.rotation=o,this.style=w(n),this.svgData=r}redo(){const t=new Ei(this.targetId,this.editor,this.svgData);this.editor.addMarkup(t),t.setSize(this.position,this.size.x,this.size.y),t.setRotation(this.rotation),t.setStyle(this.style)}undo(){const t=this.editor.getMarkup(this.targetId);this.editor.removeMarkup(t)}}var bi=Autodesk.Viewing,Ti=Autodesk.Viewing.Private;const Ci=bi.getGlobal(),Si=Ci.document;var Ii=1,zi=10,Pi=15,Di=7,Hi=function(){return!(!bi.isTouchDevice||"function"!=typeof Hammer)&&bi.isTouchDevice()},Li=function(t){return(this&&this.getDocument&&this.getDocument()||Si).createElementNS("http://www.w3.org/2000/svg",t)},Ni=function(t){return t.setAttribute("version","1.1"),t.setAttribute("baseProfile","full"),t.setAttribute("layer-order-id","markups-svg"),t},Ri=function(t){t=t||[];var e=Li("g");e.setAttribute("cursor","default"),e.setAttribute("pointer-events","none");for(var i=0;i<t.length;i++)e.appendChild(t[i]);return e},Bi=function(){var t=Li("g");t.setAttribute("cursor","inherit"),t.setAttribute("pointer-events","none");var e=Li("path");e.setAttribute("id","markup");var i=Li("path");return i.setAttribute("id","hitarea"),i.setAttribute("fill","transparent"),i.setAttribute("stroke","transparent"),t.markup=e,t.hitarea=i,t.appendChild(e),t.appendChild(i),t},Vi=function(t,e,i){t.markup.setAttribute(e,i)},Oi=function(t,e){var i=t.markup,s=t.hitarea,o=e.sizeFromClientToMarkups(0,Pi).y;o+=parseFloat(i.getAttribute("stroke-width"))+o;var n=i.getAttribute("fill"),r=i.getAttribute("stroke"),a=""!==r&&"none"!==r,h=""!==n&&"none"!==n;if(s.setAttribute("d",i.getAttribute("d")),s.setAttribute("stroke-width",o),s.setAttribute("transform",i.getAttribute("transform")),e.duringEditMode&&!e.navigating){if(a&&h)return void t.setAttribute("pointer-events","painted");if(a)return void t.setAttribute("pointer-events","stroke");if(h)return void t.setAttribute("pointer-events","fill")}t.setAttribute("pointer-events","none")},_i=function(){var t=Li("g");t.setAttribute("cursor","default");var e="markup-clipper-"+qi(),i="url(#"+e+")",s=Li("clipPath");s.setAttribute("id",e),s.removeAttribute("pointer-events"),s.rect=Li("rect"),s.appendChild(s.rect);var o=Li("rect");o.setAttribute("id","markup-background"),o.removeAttribute("pointer-events");var n=Li("text");n.setAttribute("id","markup");var r=Li("rect");r.setAttribute("id","hitarea"),r.setAttribute("fill","transparent"),r.setAttribute("stroke","none"),r.setAttribute("stroke-width","0");var a=Li("g");return a.setAttribute("clip-path",i),a.appendChild(s),a.appendChild(o),a.appendChild(n),t.appendChild(a),t.appendChild(r),t.clipper=s,t.background=o,t.markup=n,t.hitarea=r,t},Fi=function(t,e,i){t.clipper.rect.setAttribute("transform",e),t.background.setAttribute("transform",e),t.markup.setAttribute("transform",i),t.hitarea.setAttribute("transform",e)},Ui=function(t,e,i,s){var o=t.hitarea,n=s.sizeFromClientToMarkups(0,Pi).y;o.setAttribute("x",-n),o.setAttribute("y",-n),o.setAttribute("width",e+2*n),o.setAttribute("height",i+2*n),t.setAttribute("pointer-events",s.navigating?"none":"painted")},ji=function(t,e,i,s){var o=t.background;o.setAttribute("x",0),o.setAttribute("y",0),o.setAttribute("width",e),o.setAttribute("height",i),o.setAttribute("fill",s)},Gi=function(t,e,i){var s=t.clipper;s.rect.setAttribute("x",0),s.rect.setAttribute("y",0),s.rect.setAttribute("width",e),s.rect.setAttribute("height",i)},Wi=function(t,e){const i=this&&this.getDocument&&this.getDocument()||Si;var s=i.createElementNS("http://www.w3.org/2000/svg","metadata"),o=i.createElement("markup_document");return s.appendChild(o),o.setAttribute("data-model-version",e["data-model-version"]),t.insertBefore(s,t.firstChild),s},Ki=function(t,e){const i=this&&this.getDocument&&this.getDocument()||Si;var s=i.createElementNS("http://www.w3.org/2000/svg","metadata"),o=i.createElement("markup_element");for(var n in s.appendChild(o),e)Object.prototype.hasOwnProperty.call(e,n)&&o.setAttribute(n,e[n]);return t.insertBefore(s,t.firstChild),s},Yi=function(t){if(t.getElementsByTagName)for(var e=t.getElementsByTagName("metadata"),i=0;i<e.length;++i){var s=e[i];s.parentNode&&s.parentNode.removeChild(s)}var o=t.children||t.childNodes;if(o)for(i=0;i<o.length;++i)Yi(o[i])},Xi=function(t,e){for(var i=t.children||t.childNodes,s=[],o=0;o<i.length;++o)s.push(i[o]);s.forEach((function(t){e.appendChild(t)}))},qi=function(){return THREE.Math.generateUUID()},$i=function(t){var e;try{var i=[];!function t(e,i){var s=e.hitarea,o=s&&s.parentNode;o&&(i.push({hitarea:s,parent:o}),o.removeChild(s));for(var n=e.childNodes,r=n.length,a=0;a<r;++a)t(n.item(a),i)}(t,i),e=(new XMLSerializer).serializeToString(t),function(t){for(var e=t.length,i=0;i<e;++i){var s=t[i];s.parent.appendChild(s.hitarea)}}(i)}catch(t){e="",console.warn("svgNodeToString failed to generate string representation of domNode.")}return e},Zi=function(t){var e=null;try{e=(new DOMParser).parseFromString(t,"text/xml").firstChild}catch(t){e=null,console.warn("stringToSvgNode failed to generate an HTMLElement from its string representation.")}return e},Qi=function(t){t.listeners={},t.addEventListener=function(t,e){void 0===this.listeners[t]&&(this.listeners[t]=[]),this.listeners[t].push(e)},t.hasEventListener=function(t,e){if(void 0===this.listeners)return!1;var i=this.listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},t.removeEventListener=function(t,e){if(this.listeners[t]instanceof Array)for(var i=this.listeners[t],s=0,o=i.length;s<o;s++)if(i[s]===e){i.splice(s,1);break}},t.dispatchEvent=function(t){if("string"==typeof t&&(t={type:t}),t.target||(t.target=this),!t.type)throw new Error("event type unknown.");if(this.listeners[t.type]instanceof Array)for(var e=this.listeners[t.type].slice(),i=0;i<e.length;i++)e[i].call(this,t)}},Ji=function(t){try{delete t.listeners,delete t.addEventListener,delete t.hasEventListener,delete t.removeEventListener,delete t.dispatchEvent}catch(t){}},ts=function(t,e,i){var s=os(t,e),o=ss(s.x,s.y,e);return o.z=0,i&&(o.x=Math.floor(o.x)+.5,o.y=Math.floor(o.y)+.5),o},es=function(t,e,i,s){var o=is(t,e,s);return o.z=i,o.unproject(s.impl.camera),o},is=function(t,e,i){return i.impl.clientToViewport(t,e)},ss=function(t,e,i){return i.impl.viewportToClient(t,e)},os=function(t,e){var i=new THREE.Vector3;return i.x=t.x,i.y=t.y,i.z=t.z,i.project(e.impl.camera),i},ns=function(t,e){return 1/e.model.getUnitScale()*t},rs=function(t){return t*(180/Math.PI)},as=function(t){return t*(Math.PI/180)},hs=function(t){return t>=0?1:-1},ls=function(t,e,i,s){i=s.sizeFromClientToMarkups(0,i).y;var o=t.x-e.x,n=t.y-e.y;return i*i>=o*o+n*n},us=function(t){t.toolbar&&(t.setActiveNavigationTool(),gs(),cs(!0,t),ys(t))},ds=function(t){t.toolbar&&(gs(),cs(!1,t),ps(t))},cs=function(t,e){var i=e.dockingPanels;if(i)for(var s=0;s<i.length;++s){var o=i[s],n=o.container;n.classList.contains("dockingPanelVisible")&&(n.style.display=t?"none":"block",o.visibilityChanged())}},ps=function(t){t&&t.model&&!t.model.is2d()&&t.getExtension("Autodesk.ViewCubeUi",(function(t){t.displayViewCube(!0,!1),t.displayHomeButton(!0)}));var e=t.getDocument().getElementsByClassName("toolbar-animation-subtoolbar");if(e.length>0&&(e[0].style.display=""),t.toolbar)for(var i=t.toolbar.container,s=i.children.length,o=0;o<s;++o)i.children[o].style.display=""},ys=function(t){t&&t.model&&!t.model.is2d()&&t.getExtension("Autodesk.ViewCubeUi",(function(t){t.displayViewCube(!1,!1),t.displayHomeButton(!1)}));var e=t.getDocument().getElementsByClassName("toolbar-animation-subtoolbar");if(e.length>0){e[0].style.display="none";var i=t.impl.keyFrameAnimator;if(i&&!i.isPaused){i.pauseCameraAnimations(),i.pause();var s=t.modelTools.getControl("toolbar-animationPlay");s&&(s.setIcon("toolbar-animation-pause-icon"),s.setToolTip("Pause"))}}if(t.toolbar)for(var o=t.toolbar.container,n=o.children.length,r=0;r<n;++r)o.children[r].style.display="none"},gs=function(){try{for(var t=!0;t;)t=Autodesk.Viewing.Private.HudMessage.dismiss()}catch(t){console.warn("[CO2]Failed to dismiss LMV HudMessage")}},vs=function(t,e){return e.sizeFromClientToMarkups(0,t).y},fs=function(t,e){if(!t.childNodes[0])return null;var i=t.childNodes[0].childNodes[0]||"",s=function(){var e=t.childNodes[1]||"",i=!1;if("string"!=typeof e){var s=e.getAttribute("d").split(" ");"z"===s[s.length-1].toLowerCase()&&(i=!0)}return i},o=function(){for(var t=[],e=i.getAttribute("locations").split(" ")||"",s=0;s<e.length;s+=2){var o={x:parseFloat(e[s]),y:parseFloat(e[s+1])};t.push(o)}return t},n=function(t){var e=new THREE.Vector3,s=(i.getAttribute(t)||i.getAttribute(t.toLowerCase())).split(" ");return e.x=parseFloat(s[0]),e.y=parseFloat(s[1]),e},x=function(){return n("position")},m=function(){return n("size")},M=function(){var t=i.getAttribute("rotation")||"";return parseFloat(t)},k=function(){return i.getAttribute("text")||""};if("string"!=typeof i){var w,E,A,b,T=e.getId(),C=function(t,e){for(var i=["stroke-width","stroke-color","stroke-opacity","fill-color","fill-opacity","font-family","font-size","font-style","font-weight","stroke-linejoin"],s={},o=0;o<i.length;o++){var n=e.getAttribute(i[o]);if(null!=n)switch(i[o]){case"font-size":case"stroke-width":case"stroke-opacity":case"fill-opacity":s[i[o]]=parseFloat(n);break;case"stroke-linejoin":break;case"font-family":case"font-style":case"font-weight":case"stroke-color":case"text-data":case"fill-color":s[i[o]]=n;break;default:Ti.logger.warn("Style not recognized.")}}return s}(0,i);switch(i.getAttribute("type")||""){case r:b=new tt(e,T,n("tail"),n("head"),C);break;case h:b=new dt(e,T,w=x(),E=m(),A=M(),C);break;case a:b=new $t(e,T,w=x(),E=m(),k(),C);break;case g:b=new Ot(e,T,w=x(),E=m(),k(),C,!!parseInt(i.getAttribute("isframeused")));break;case l:b=new re(e,T,w=x(),E=m(),A=M(),C);break;case u:b=new ve(e,T,w=x(),E=m(),A=M(),C);break;case d:b=new Ie(e,T,w=x(),E=m(),A=M(),o(),C);break;case p:b=new _e(e,T,w=x(),E=m(),A=M(),o(),C,s());break;case y:b=new Ze(e,T,w=x(),E=m(),A=M(),o(),C,s());break;case c:b=new ri(e,T,w=x(),E=m(),A=M(),o(),C);break;case v:b=new xi(e,T,n("firstAnchor"),n("secondAnchor"),k(),C);break;case f:w=x(),E=m(),A=M(),b=new Ai(e,T,w,E,A,C,t);break;default:b=null}if(b){b.addToHistory=!1,b.execute();for(var S=e.svgLayersMap[e.activeLayer].markups,I=0;I<S.length;++I)if(S[I].id===T)return S[I]}return null}},xs=function(t,e){return!t||!e||e<=0?"none":["rgba("+parseInt("0x"+t.substr(1,2)),",",parseInt("0x"+t.substr(3,2)),",",parseInt("0x"+t.substr(5,2)),",",e,")"].join("")},ms=function(t,e,i,s,o){var n=(this&&this.getWindow&&this.getWindow()||Ci).devicePixelRatio||1;t*=n,e*=n,i*=n,s*=n;var r=o.width,a=o.height,h=o.buffer;function l(t,e){t=Math.round(t),e=Math.round(e);for(var i=0,s=0,o=-n;o<=n;o+=2*n)s+=u(t,e+o)?o:0;for(var r=-n;r<=n;r+=2*n)i+=u(t+r,e)?r:0;return{x:Math.round(t/n+i),y:Math.round((a-e)/n-s)}}function u(t,e){if(t<0||t>=r||e<0||e>=a)return!1;var i=4*(e*r+t);return 255!==h[i]||255!==h[i+1]||255!==h[i+2]}t=Math.round(t),i=Math.round(i),e=Math.round(a-e),s=Math.round(a-s);var d=i-t,c=0!==d?(s-e)/d:1,p=t,y=e;if(0!==d&&Math.abs(c)<=1){if(t<=i){for(;p<=i;++p,y+=c)if(u(p,Math.round(y)))return l(p,y)}else for(;p>=i;--p,y-=c)if(u(p,Math.round(y)))return l(p,y)}else if(c=0!==d?1/c:0,e<=s){for(;y<=s;++y,p+=c)if(u(Math.round(p),y))return l(p,y)}else for(;y>=s;--y,p-=c)if(u(Math.round(p),y))return l(p,y)},Ms=function(t,e){if(!t||t.verxtexCount<3||!e)return null;var i=(this&&this.getWindow&&this.getWindow()||Ci).devicePixelRatio||1,s=e.width,o=e.height,n=e.buffer,r=t.vertexCount,a=Float32Array.from(t.xVertices),h=Float32Array.from(t.yVertices);function l(t,e){for(var s=0,n=0,r=-i;r<=i;r+=2*i)n+=u(t,e+r)?r:0;for(var a=-i;a<=i;a+=2*i)s+=u(t+a,e)?a:0;return{x:Math.round(t/i)+s,y:Math.round((o-e)/i-n)}}function u(e,i){if(e<0||e>=s||i<0||i>=o)return!1;var r=4*(i*s+e);return(255!==n[r]||255!==n[r+1]||255!==n[r+2])&&function(e,i){for(var s=!1,o=t.vertexCount,n=0,r=o-1;n<o;r=n++)h[n]>i!=h[r]>i&&e<(a[r]-a[n])*(i-h[n])/(h[r]-h[n])+a[n]&&(s=!s);return s}(e,i)}for(var d=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,y=Number.NEGATIVE_INFINITY,g=0;g<r;++g){var v=a[g]=a[g]*i,f=h[g]=o-h[g]*i;d=Math.min(d,v),c=Math.min(c,f),p=Math.max(p,v),y=Math.max(y,f)}if(p<0||d>s||y<0||c>o)return null;var x=Math.round(p-d),m=Math.round(y-c),M=Math.round(.5*(d+p)),k=Math.round(.5*(c+y)),w=1,E=1;do{for(var A=M+w,b=k+E;M<A;++M)if(u(M,k))return l(M,k);for(;k<b;++k)if(u(M,k))return l(M,k);for(w<x?(A=M-++w,++w):A=M-w,E<m?(b=k-++E,++E):b=k-E;M>A;--M)if(u(M,k))return l(M,k);for(;k>b;--k)if(u(M,k))return l(M,k)}while(w<x||E<m)},ks=function(){const t=this&&this.getDocument&&this.getDocument()||Si;var e=t.createElement("style");return e.appendChild(t.createTextNode("")),t.head.appendChild(e),e.sheet},ws=function(t,e,i,s){"insertRule"in t?t.insertRule(e+"{"+i+"}",s):"addRule"in t&&t.addRule(e,i,s)},Es=function(t,e,i){var s=i.sizeFromMarkupsToClient(0,e["font-size"]).y,o=(new Ct).setAttribute("font-family",e["font-family"]).setAttribute("font-size",s+"px").setAttribute("font-weight",e["font-weight"]?"bold":"").setAttribute("font-style",e["font-style"]?"italic":"").removeAttribute(["top","left","width","height","overflow-y"]).setAttribute("position","absolute").setAttribute("white-space","nowrap").setAttribute("float","left").setAttribute("visibility","hidden").getStyleString();var n=(this&&this.getDocument&&this.getDocument()||Si).createElement("div");n.setAttribute("style",o),i.viewer.container.appendChild(n);for(var r=[],a=t.length,h=0;h<a;++h)n.innerText=t[h],r.push({line:t[h],width:n.clientWidth,height:n.clientHeight});return i.viewer.container.removeChild(n),r},As=function(t,e,i,s,o,n){return n.push(o?"a":"A"),n.push(i),n.push(s),n.push(0),n.push(1),n.push(1),n.push(t),n.push(e),n},bs=function(t,e,i,s,o,n){var r=.5*i,a=.5*s;n.push(o?"m":"M"),n.push(t),n.push(e),As(i,0,r,a,!0,n),As(-i,0,r,a,!0,n),n.push("z")},Ts=function(t,e,i,s,o,n){n.push(o?"m":"M"),n.push(t),n.push(e),n.push("l"),n.push(i),n.push(0),n.push("l"),n.push(0),n.push(s),n.push("l"),n.push(-i),n.push(0),n.push("z")},Cs=function(t,e,i,s,o,n){const r=t.outerHTML,a=new Blob([`\n        <svg xmlns="http://www.w3.org/2000/svg" width="${i}" height="${s}" viewBox="${e}" style="transform: scale(1, -1); transform-origin: center center">\n          ${r}\n        </svg>\n        `],{type:"image/svg+xml"}),h=URL.createObjectURL(a),l=new Image;l.onload=function(){o.drawImage(l,0,0),n()},l.src=h},Ss=function(t,e,i){if(t.length<=2)return t;function s(t,e,i){var s=e.x,o=e.y,n=i.x-s,r=i.y-o;if(0!==n||0!==r){var a=((t.x-s)*n+(t.y-o)*r)/(n*n+r*r);a>1?(s=i.x,o=i.y):a>0&&(s+=n*a,o+=r*a)}return(n=t.x-s)*n+(r=t.y-o)*r}function o(t,e,i,n,r){for(var a,h=n,l=e+1;l<i;l++){var u=s(t[l],t[e],t[i]);u>h&&(a=l,h=u)}h>n&&(a-e>1&&o(t,e,a,n,r),r.push(t[a]),i-a>1&&o(t,a,i,n,r))}var n=void 0!==e?e*e:1;return t=i?t:function(t,e){for(var i,s,o,n,r,a=t[0],h=[a],l=1,u=t.length;l<u;l++)i=t[l],o=a,n=void 0,r=void 0,n=(s=i).x-o.x,r=s.y-o.y,n*n+r*r>e&&(h.push(i),a=i);return a!==i&&h.push(i),h}(t,n),t=function(t,e){var i=t.length-1,s=[t[0]];return o(t,0,i,e,s),s.push(t[i]),s}(t,n),t};function Is(){this.actions=[],this.closed=!0}var zs=Is.prototype;function Ps(t){this.historySize=t,this.undoStack=[],this.redoStack=[],Qi(this)}zs.open=function(){return!!this.closed&&(this.closed=!1,!0)},zs.close=function(){return!this.closed&&(this.closed=!0,!0)},zs.undo=function(){for(var t=this.actions,e=-1,i=t.length-1;i>=0;--i){var s=t[i];s.undo(),-1!==s.targetId&&(e=s.targetId)}return e},zs.redo=function(){for(var t=this.actions,e=t.length,i=-1,s=0;s<e;++s){var o=t[s];o.redo(),-1!==o.targetId&&(i=o.targetId)}return i},zs.isOpen=function(){return!this.closed},zs.isClosed=function(){return this.closed},zs.isEmpty=function(){return 0===this.actions.length},zs.addAction=function(t){return!this.closed&&(this.actions.push(t),this.compact(),!0)},zs.compact=function(){for(var t=this.actions,e=t.length,i=0;i<e;++i){var s=t[i];if(s.isIdentity())t.splice(i,1),--e,--i;else for(var o=i+1;o<e;++o){var n=t[o];if(s.type===n.type&&s.merge(n)){t.splice(o,1),--e,--i;break}}}},zs.getTargetId=function(){for(var t=this.actions,e=t.length,i=-1,s=0;s<e;++s){var o=t[s];-1!==o.targetId&&(i=o.targetId)}return i};var Ds=Ps.prototype;function Hs(t,e,i,s){x.call(this,t,"CLONE-MARKUP",e),this.clone=i.clone(),this.clone.id=e,this.position={x:s.x,y:s.y}}Ds.execute=function(t){var e=this.redoStack,i=this.undoStack;e.splice(0,e.length),t.redo();var s=this.getEditActionGroup();s.isOpen()?s.addAction(t):(s.open(),s.addAction(t),s.close()),i.length>this.historySize&&i.splice(0,1);var o=t.selectOnExecution?t.targetId:-1;this.dispatchEvent({type:D,data:{action:"execute",targetId:o}})},Ds.beginActionGroup=function(){var t=this.undoStack,e=t.length;0===e||t[e-1].isClosed()?this.getEditActionGroup().open():console.warn("Markups - Undo/Redo - Action edit group already open.")},Ds.closeActionGroup=function(){var t=this.undoStack,e=t.length;if(0!==e){var i=t[e-1];i.close()||console.warn("Markups - Undo/Redo - Action edit group already closed."),i.isEmpty()&&t.pop()}else console.warn("Markups - Undo/Redo - There is no action edit group to close.")},Ds.cancelActionGroup=function(){var t=this.undoStack,e=t.length;if(0!==e){var i=t[e-1];i.close()?(i.undo(),t.pop(),this.dispatchEvent({type:D,data:{action:"cancel",targetId:-1}})):console.warn("Markups - Undo/Redo - Action edit group already closed.")}else console.warn("Markups - Undo/Redo - There is no action edit group to close.")},Ds.undo=function(){var t=this.undoStack,e=this.redoStack;if(0!==t.length){var i=t.pop(),s=i.undo();e.push(i),this.dispatchEvent({type:D,data:{action:"undo",targetId:s}})}},Ds.redo=function(){var t=this.undoStack,e=this.redoStack;if(0!==e.length){var i=e.pop(),s=i.redo();t.push(i),this.dispatchEvent({type:D,data:{action:"redo",targetId:s}})}},Ds.clear=function(){this.undoStack.splice(0,this.undoStack.length),this.redoStack.splice(0,this.redoStack.length),this.dispatchEvent({type:D,data:{action:"clear",targetId:-1}})},Ds.isUndoStackEmpty=function(){return 0===this.undoStack.length},Ds.isRedoStackEmpty=function(){return 0===this.redoStack.length},Ds.getLastElementInUndoStack=function(){var t=this.undoStack;return t[t.length-1]},Ds.getEditActionGroup=function(){var t=this.undoStack,e=this.undoStack.length,i=null;return 0===e||t[e-1].isClosed()?(i=new Is,t.push(i)):i=t[e-1],i},Hs.prototype=Object.create(x.prototype),Hs.prototype.constructor=Hs;var Ls=Hs.prototype;function Ns(t){this.editor=t,this.content=null,this.pastePosition={x:0,y:0},Qi(this)}Ls.redo=function(){var t=this.editor,e=this.clone,i=this.position;if(!t.getMarkup(this.targetId)){var s=e.clone();s.setPosition(i.x,i.y),t.addMarkup(s)}},Ls.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&this.editor.removeMarkup(t)};var Rs=Ns.prototype;Rs.copy=function(){var t=this.editor.getSelection();t&&(this.content=t.clone(),this.pastePosition.x=t.position.x,this.pastePosition.y=t.position.y)},Rs.cut=function(){var t=this.editor.getSelection();t&&(this.copy(),this.editor.deleteMarkup(t))},Rs.paste=function(){var t=this.content;if(t){var e=this.editor,i=this.pastePosition,s=e.sizeFromClientToMarkups(20,20);i.x+=s.x,i.y-=s.y,new Hs(e,e.getId(),t,i).execute()}};var Bs=Autodesk.Viewing,Vs=Bs.Private,Os=!1,_s=!1,Fs=!1;function Us(){this.editor=null,this.mousePosition={x:0,y:0},this.makeSameXY=!1,this.snapRotations=!1,this.keepAspectRatio=!1,this.constrainAxis=!1,this.duringEditMode=!1,this.onWheelBinded=this.onWheel.bind(this),this.onTouchDragBinded=this.onTouchDrag.bind(this),this.onTouchPanBinded=this.onTouchPan.bind(this),this.onTouchPinchBinded=this.onTouchPinch.bind(this),this.onSingleTapBinded=this.onSingleTap.bind(this),this.onDoubleTapBinded=this.onDoubleTap.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseDoubleClickBinded=this.onMouseDoubleClick.bind(this),this.onHammerInputBinded=this.onHammerInput.bind(this),this.isMouseDown=!1}Bs.GlobalManagerMixin.call(Us.prototype);var js=Us.prototype;function Gs(t,e){var i=t.editor.svg.getBoundingClientRect();t.makeSameXY=e.shiftKey,t.snapRotations=e.shiftKey,t.keepAspectRatio=e.shiftKey,t.constrainAxis=e.shiftKey,t.mousePosition.x=e.clientX-i.left,t.mousePosition.y=e.clientY-i.top}function Ws(t){t.shiftKey=!1,t.clientX=t.pointers[0].clientX,t.clientY=t.pointers[0].clientY}function Ks(t,e,i){x.call(this,t,"SET-POSITION",e.id),this.newPosition={x:i.x,y:i.y},this.oldPosition={x:e.position.x,y:e.position.y}}js.attachTo=function(t){this.editor&&this.detachFrom(this.editor),this.editor=t,Hi()&&(this.hammer=new Bs.Hammer.Manager(t.svg,{recognizers:[Bs.GestureRecognizers.drag,Bs.GestureRecognizers.doubletap,Bs.GestureRecognizers.doubletap2,Bs.GestureRecognizers.singletap,Bs.GestureRecognizers.singletap2,Bs.GestureRecognizers.press,Bs.GestureRecognizers.pan,Bs.GestureRecognizers.pinch],handlePointerEventMouse:!1,inputClass:Bs.Hammer.TouchInput}),this.hammer.get("doubletap2").recognizeWith("doubletap"),this.hammer.get("singletap2").recognizeWith("singletap"),this.hammer.get("singletap").requireFailure("doubletap"))},js.onHammerInput=function(t){this.setMouseDisabledWhenTouching(t)},js.setMouseDisabledWhenTouching=function(t){if(t.isFirst&&!Fs)this.enableMouseButtons(!1),Fs=!0;else if(t.isFinal){var e=this;setTimeout((function(){e.enableMouseButtons(_s),Fs=!1}),10)}},js.enableMouseButtons=function(t){t&&!Os?(this.editor.svg.addEventListener("mousedown",this.onMouseDownBinded),this.editor.svg.addEventListener("dblclick",this.onMouseDoubleClickBinded),this.editor.svg.addEventListener("wheel",this.onWheelBinded),this.editor.svg.addEventListener("DOMMouseScroll",this.onWheelBinded),this.addDocumentEventListener("mousemove",this.onMouseMoveBinded),this.addDocumentEventListener("mouseup",this.onMouseUpBinded)):!t&&Os&&(this.editor.svg.removeEventListener("mousedown",this.onMouseDownBinded),this.editor.svg.removeEventListener("dblclick",this.onMouseDoubleClickBinded),this.editor.svg.removeEventListener("wheel",this.onWheelBinded),this.editor.svg.removeEventListener("DOMMouseScroll",this.onWheelBinded),this.removeDocumentEventListener("mousemove",this.onMouseMoveBinded),this.removeDocumentEventListener("mouseup",this.onMouseUpBinded)),_s=Os,Os=t},js.detachFrom=function(t){this.hammer&&this.hammer.destroy(),this.removeDocumentEventListener("mousemove",this.onMouseMoveBinded),this.removeDocumentEventListener("mouseup",this.onMouseUpBinded),this.editor&&(this.editor.svg.removeEventListener("mousedown",this.onMouseDownBinded),this.editor.svg.removeEventListener("dblclick",this.onMouseDoubleClickBinded)),this.editor=t},js.enterEditMode=function(){this.duringEditMode||(this.hammer&&(this.hammer.on("dragstart dragmove dragend",this.onTouchDragBinded),this.hammer.on("panstart panmove panend",this.onTouchPanBinded),this.hammer.on("pinchstart pinchmove pinchend",this.onTouchPinchBinded),this.hammer.on("singletap",this.onSingleTapBinded),this.hammer.on("singletap2",this.onSingleTapBinded),this.hammer.on("doubletap",this.onDoubleTapBinded),this.hammer.on("doubletap2",this.onDoubleTapBinded),this.hammer.on("hammer.input",this.onHammerInputBinded),this.hammer.get("drag").requireFailure("pinch"),this.hammer.get("drag").requireFailure("pan")),Bs.isMobileDevice()||this.enableMouseButtons(!0),this.duringEditMode=!0)},js.leaveEditMode=function(){this.duringEditMode&&(this.hammer&&(this.hammer.off("dragstart dragmove dragend",this.onTouchDragBinded),this.hammer.off("panstart panmove panend",this.onTouchPanBinded),this.hammer.off("pinchstart pinchmove pinchend",this.onTouchPinchBinded),this.hammer.off("singletap",this.onSingleTapBinded),this.hammer.off("singletap2",this.onSingleTapBinded),this.hammer.off("doubletap",this.onDoubleTapBinded),this.hammer.off("doubletap2",this.onDoubleTapBinded),this.hammer.off("hammer.input",this.onHammerInputBinded)),Bs.isMobileDevice()||this.enableMouseButtons(!1),this.duringEditMode=!1)},js.enterViewMode=function(){},js.leaveViewMode=function(){},js.getMousePosition=function(){return{x:this.mousePosition.x,y:this.mousePosition.y}},js.onWheel=function(t){Bs.isMobileDevice()||this.editor.viewer.toolController.mousewheel(t),t.preventDefault()},js.onMouseMove=function(t){Gs(this,t),!Bs.isMobileDevice()&&this.editor.viewer.container.contains(t.target)&&this.editor.viewer.toolController.mousemove(t),this.editor.onMouseMove(t)&&t.preventDefault()},js.onMouseDownRightClick=function(t){const e=this.getDocument();e.activeElement&&e.activeElement.blur&&e.activeElement.blur(),this.editor.viewer.toolController.__clientToCanvasCoords(t),this.editor.markupTool.handleButtonDown(t,2)},js.onMouseUpRightClick=function(t){this.editor.viewer.toolController.__clientToCanvasCoords(t),this.editor.markupTool.handleButtonUp(t,2)},js.onMouseDown=function(t){Gs(this,t),Bs.isMobileDevice()||!Vs.isRightClick(t,this.editor.viewer.navigation)&&!Vs.isMiddleClick(t)?(this.isMouseDown=!0,this.editor.onMouseDown(t),t.preventDefault()):this.onMouseDownRightClick(t)},js.onMouseUp=function(t){Gs(this,t),Bs.isMobileDevice()||!this.editor.viewer.container.contains(t.target)||!Vs.isRightClick(t,this.editor.viewer.navigation)&&!Vs.isMiddleClick(t)?(this.isMouseDown=!1,this.editor.onMouseUp(t)&&t.preventDefault()):this.onMouseUpRightClick(t)},js.onMouseDoubleClick=function(t){Gs(this,t),this.editor.onMouseDoubleClick(t),t.preventDefault()},js.onTouchDrag=function(t){switch(Ws(t),t.type){case"dragstart":this.onMouseDown(t);break;case"dragmove":this.onMouseMove(t);break;case"dragend":this.onMouseUp(t)}t.preventDefault()},js.onTouchPan=function(t){this.editor.viewer.toolController.getTool("gestures").distributeGesture(t),t.preventDefault()},js.onTouchPinch=function(t){Gs(this,t),this.editor.viewer.toolController.getTool("gestures").distributeGesture(t),this.mousePosition.x=this.mousePosition.y=null,this.editor.callSnapperMouseMove(),t.preventDefault()},js.onSingleTap=function(t){Ws(t),this.onMouseDown(t),this.onMouseUp(t),t.preventDefault()},js.onDoubleTap=function(t){Ws(t),this.onMouseDoubleClick(t),t.preventDefault()},Ks.prototype=Object.create(x.prototype),Ks.prototype.constructor=Ks;var Ys=Ks.prototype;function Xs(t,e,i){x.call(this,t,"SET-ROTATION",e.id);var s=e.getRotation();this.newRotation={angle:i},this.oldRotation={angle:s}}Ys.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.setPosition(this.newPosition.x,this.newPosition.y)},Ys.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.setPosition(this.oldPosition.x,this.oldPosition.y)},Ys.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.newPosition=t.newPosition,!0)},Ys.isIdentity=function(){var t=this.newPosition,e=this.oldPosition;return t.x===e.x&&t.y===e.y},Xs.prototype=Object.create(x.prototype),Xs.prototype.constructor=Xs;var qs=Xs.prototype;qs.redo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.setRotation(this.newRotation.angle)},qs.undo=function(){var t=this.editor.getMarkup(this.targetId);t&&t.setRotation(this.oldRotation.angle)},qs.merge=function(t){return this.targetId===t.targetId&&this.type===t.type&&(this.newRotation=t.newRotation,!0)},qs.isIdentity=function(){return this.newRotation.angle===this.oldRotation.angle};var $s=Autodesk.Viewing,Zs=Autodesk.Viewing.Private;function Qs(t,e){this.containingDiv=t,this.editor=e,this.setGlobalManager(this.editor.viewer.globalManager),this.selectionLayer=eo.bind(this)(),this.frameMargin=Di,this.selection={x:0,y:0,width:0,height:0,rotation:0,element:null,active:!1,dragging:!1,resizing:!1,handle:{}},lo.bind(this)(),Hi()&&(this.hammer=new $s.Hammer.Manager(this.selectionLayer,{recognizers:[$s.GestureRecognizers.drag,$s.GestureRecognizers.doubletap,$s.GestureRecognizers.doubletap2,$s.GestureRecognizers.pan,$s.GestureRecognizers.pinch],handlePointerEventMouse:!1,inputClass:$s.Hammer.TouchInput}),this.onHammerDragBinded=this.onHammerDrag.bind(this),this.onHammerDoubleTapBinded=this.onHammerDoubleTap.bind(this),this.onTouchPanBinded=this.onTouchPan.bind(this),this.onTouchPinchBinded=this.onTouchPinch.bind(this),this.hammer.on("dragstart dragmove dragend",this.onHammerDragBinded),this.hammer.on("doubletap",this.onHammerDoubleTapBinded),this.hammer.on("doubletap2",this.onHammerDoubleTapBinded),this.hammer.on("panstart panmove panend",this.onTouchPanBinded),this.hammer.on("pinchstart pinchmove pinchend",this.onTouchPinchBinded),this.hammer.get("drag").requireFailure("pinch"),this.hammer.get("drag").requireFailure("pan")),yo.bind(this)(),mo.bind(this)(),ko.bind(this)(),Mo.bind(this)(),this.containingDiv.appendChild(this.selectionLayer),Qi(this)}$s.GlobalManagerMixin.call(Qs.prototype);var Js=Qs.prototype;function to(t){t.pageX=t.pointers[0].clientX,t.pageY=t.pointers[0].clientY}function eo(){var t=this.getDocument().createElement("div");return t.style.position="absolute",t.style.top=0,t.style.bottom=0,t.style.left=0,t.style.right=0,t.style.overflow="hidden",t.style.visibility="hidden",wo(t,!1),t}function io(t){var e=this.getDocument().createElement("div");return no(e,t),e.className="selector-drag-point autodesk-markups-extension-core-make-me-bigger sdp-handle-"+t,e.classList.add("adsk-viewing-viewer"),e.setAttribute("data-sdp-handle",t),e}function so(){var t=this.getDocument().createElement("div");return t.classList.add("adsk-viewing-viewer"),t.classList.add("selector-rotate-point"),t.classList.add("autodesk-markups-extension-core-make-me-bigger"),no(t,"w"),t}function oo(){var t=this.getDocument().createElement("div");return t.classList.add("adsk-viewing-viewer"),t.classList.add("selector-rotate-point"),t.classList.add("autodesk-markups-extension-core-make-me-bigger"),t.classList.add("rotation-bridge"),no(t,"w"),t}function no(t,e){var i;switch(e){case"n":case"s":i="ns-resize";break;case"w":case"e":i="ew-resize";break;case"ne":case"sw":i="nesw-resize";break;case"nw":case"se":i="nwse-resize"}t.style.cursor=i}function ro(t){["n","s","w","e","nw","ne","sw","se"].forEach(function(e){this.selection.handle[e]=io.call(this,e),t.appendChild(this.selection.handle[e])}.bind(this))}function ao(t){return Ao(t,".selector-drag-point")}function ho(t){return Ao(t,".selector-rotate-point")}function lo(){var t=this.getDocument().createElement("div");return wo(t,!0),t.classList.add("selector-box"),this.selection.rotationBridge=oo.bind(this)(),t.appendChild(this.selection.rotationBridge),this.selection.rotationHandle=so.bind(this)(),t.appendChild(this.selection.rotationHandle),ro.bind(this)(t),this.selection.element=t,$s.isMobileDevice()||(this.onWheelBinded=this.onWheel.bind(this),this.selection.element.addEventListener("wheel",this.onWheelBinded),this.selection.element.addEventListener("DOMMouseScroll",this.onWheelBinded)),this.selectionLayer.appendChild(this.selection.element),uo.bind(this)(!1),t}function uo(t){this.selection.active=t,this.selection.element.style.display=t?"block":"none"}function co(t,e,i){this.selection.x=t,this.selection.y=e,this.selection.rotation=i;var s=this.markup.getBoundingRect();s.width+=2*this.frameMargin,s.height+=2*this.frameMargin;var o=function(t,e){return"translate3d("+t+"px,"+e+"px,0)"}(t,e)+" rotate("+i+"rad)",n=s.width/2+"px "+s.height/2+"px";this.selection.element.style.msTransform=this.selection.element.style.webkitTransform=this.selection.element.style.transform=o,this.selection.element.style.msTransformOrigin=this.selection.element.style.webkitTransformOrigin=this.selection.element.style.transformOrigin=n}function po(t,e){this.selection.width=t,this.selection.height=e,this.selection.element.style.width=t+"px",this.selection.element.style.height=e+"px"}function yo(){this.selection.element.addEventListener("mousedown",this._onRepositionMouseDown.bind(this))}Js.unload=function(){this.containingDiv.removeChild(this.selectionLayer),this.selectionLayer=null},Js.setSelection=function(t,e,i,s,o){var n=this.frameMargin,r=2*n;po.bind(this)(i+r,s+r),co.bind(this)(t-n,e-n,o),uo.bind(this)(!0),this.selectionLayer.style.visibility="visible"},Js.setMarkup=function(t){if(this.hammer&&this.hammer.set({enable:null!==t}),this.markup=t,uo.bind(this)(!1),t){var e=t.getBoundingRect(),i=t.getRotation();this.frameMargin=void 0!==e.margin?e.margin:Di,this.setSelection(e.x,e.y,e.width,e.height,i),this.enableResizeHandles(),this.enableRotationHandle(),t.preventReposition?this.selectionLayer.firstChild.style.cursor="":this.selectionLayer.firstChild.style.cursor="move"}},Js.startDrag=function(t){this.markup&&this.markup.preventReposition||(this.onMouseMove=this._onRepositionMouseMove.bind(this),this.onMouseUp=this._onRepositionMouseUp.bind(this),this._onRepositionMouseDown(t,this.editor.getMousePosition()))},Js.isActive=function(){return this.selection.active},Js.isDragging=function(){return this.selection.dragging},Js.isResizing=function(){return this.selection.resizing},Js.isRotating=function(){return this.selection.rotating},Js.onMouseMove=function(t){},Js.onMouseUp=function(t){},Js.onWheel=function(t){this.editor.viewer.toolController.mousewheel(t)},Js.onTouchPan=function(t){this.editor.viewer.toolController.getTool("gestures").distributeGesture(t),t.preventDefault()},Js.onTouchPinch=function(t){this.editor.viewer.toolController.getTool("gestures").distributeGesture(t),t.preventDefault()},Js.onHammerDrag=function(t){function e(t,e,i){var s=e.getBoundingClientRect();t.mousePosition.x=i.pageX-s.left,t.mousePosition.y=i.pageY-s.top}switch(to(t),t.type){case"dragstart":e(this.editor.input,this.editor.svg,t),this.editor.callSnapperMouseDown(),ho(t.target)?this._onRotationMouseDown(t):ao(t.target)?this._onResizeMouseDown(t):this.startDrag(t),t.preventDefault();break;case"dragmove":e(this.editor.input,this.editor.svg,t),this.editor.callSnapperMouseMove(),this.onMouseMove(t),t.preventDefault();break;case"dragend":e(this.editor.input,this.editor.svg,t),this.onMouseUp(t),t.preventDefault()}},Js.onHammerDoubleTap=function(t){to(t),function(t,e,i){var s=e.getBoundingClientRect();t.mousePosition.x=i.pageX-s.left,t.mousePosition.y=i.pageY-s.top}(this.editor.input,this.editor.svg,t),this.selection.dragging=!1,this.editor.editMode&&this.editor.editMode.onMouseDoubleClick(this.markup)},Js.enableResizeHandles=function(){var t,e=this.markup;if(e.isHeightConstrained()||e.isWidthConstrained()){for(var i in this.selection.handle)(t=this.selection.handle[i])&&(t.style.display="none");e.isHeightConstrained()||(this.selection.handle.n.style.display="block",this.selection.handle.s.style.display="block"),e.isWidthConstrained()||(this.selection.handle.w.style.display="block",this.selection.handle.e.style.display="block")}else for(let e in this.selection.handle)(t=this.selection.handle[e])&&(t.style.display="block")},Js.enableRotationHandle=function(){var t=this.markup.isRotationConstrained()?"none":"block";this.selection.rotationHandle.style.display=t,this.selection.rotationBridge.style.display=t},Js._handleRightClickDown=function(t){return!($s.isMobileDevice()||!Zs.isRightClick(t,this.editor.viewer.navigation)&&!Zs.isMiddleClick(t))&&(this.editor.input.onMouseDownRightClick(t),!0)};var go,vo,fo=!1;function xo(t,e){e?t.classList.add("selected"):t.classList.remove("selected")}function mo(){this.selectionLayer.addEventListener("mousedown",this._onResizeMouseDown.bind(this))}function Mo(){this.selection.element.addEventListener("mousedown",this._onRotationMouseDown.bind(this))}function ko(){var t=function(t){if(!t.defaultPrevented){this.selection.dragging=!1;var e=this.editor.editMode;e&&e.onMouseDoubleClick(this.markup)}}.bind(this);this.selectionLayer.addEventListener("dblclick",t)}function wo(t,e){t.style.pointerEvents=e?"auto":"none"}function Eo(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}function Ao(t,e){return t.matches?t.matches(e):t.msMatchesSelector?t.msMatchesSelector(e):t.mozMatchesSelector?t.mozMatchesSelector(e):!!t.webkitMatchesSelector&&t.webkitMatchesSelector(e)}Js._onRepositionMouseDown=function(t,e){if(this._handleRightClickDown(t))return;if(this.markup&&this.markup.preventReposition)return;fo=!$s.isMobileDevice()&&$s.isTouchDevice();var i=!(t instanceof this.getWindow().MouseEvent);if((i||!ao(t.target)&&!ho(t.target))&&(e=i?e:this.editor.getMousePosition(),this.initialCursor=e,this.initialPosition=this.markup.getClientPosition(),this.areAxisConstrained=!1,this.axisConstrains=new THREE.Vector2(1,1),this.onMouseMove=this._onRepositionMouseMove.bind(this),this.onMouseUp=this._onRepositionMouseUp.bind(this),!this.selection.dragging)){if(this.selection.dragging=!0,this.editor.beginActionGroup(),t&&t.altKey){var s=this.editor;new Hs(s,s.getId(),this.markup,this.markup.position).execute()}this.dispatchEvent({type:R})}},Js._onRepositionMouseMove=function(t){if(fo)return fo=!1,!1;if(!this.selection.dragging||!this.markup||this.markup.preventReposition)return!1;var e=this.editor.getMousePosition(),i=this.editor.input.constrainAxis;this.areAxisConstrained!==i&&(this.areAxisConstrained=i,this.axisConstrains=i?new THREE.Vector2(0,0):new THREE.Vector2(1,1),this.initialPosition.x+=e.x-this.initialCursor.x,this.initialPosition.y+=e.y-this.initialCursor.y,this.initialCursor.x=e.x,this.initialCursor.y=e.y);var s={x:e.x-this.initialCursor.x,y:e.y-this.initialCursor.y},o=15;0===this.axisConstrains.x&&0===this.axisConstrains.y&&(Math.abs(s.x)>o?(this.axisConstrains.x=1,s.x+=s.x<0?o:-15):Math.abs(s.y)>o&&(this.axisConstrains.y=1,s.y+=s.y<0?o:-15));var n=this.initialPosition.x+s.x*this.axisConstrains.x,r=this.initialPosition.y+s.y*this.axisConstrains.y;co.bind(this)(n,r,this.selection.rotation);var a=this.editor.positionFromClientToMarkups(n,r);return new Ks(this.editor,this.markup,a).execute(),!0},Js._onRepositionMouseUp=function(){this.markup&&this.markup.preventReposition||(this.last=null,this.onMouseMove=function(){},this.onMouseUp=function(){},this.selection.dragging&&(this.editor.closeActionGroup(),this.selection.dragging=!1,this.dispatchEvent({type:B})))},Js._onResizeMouseDown=function(t){if(!this._handleRightClickDown(t)){var e=t.target;if(ao(e)){this.selection.handle.resizing=e;var i=this.selection.handle.resizing.getAttribute("data-sdp-handle");this.containingDiv.style.cursor=i+"-resize";var s=this.editor.getMousePosition(),o=this.markup.getClientPosition(),n=this.markup.getBoundingRect();this.initial={x:o.x,y:o.y,width:n.width,height:n.height,mouseX:s.x,mouseY:s.y},this.onMouseMove=this._onResizeMouseMove.bind(this),this.onMouseUp=this._onResizeMouseUp.bind(this),this.selection.resizing||(this.selection.resizing=!0,this.editor.beginActionGroup(),xo(t.target,!0),this.dispatchEvent({type:R}))}}},Js._onResizeMouseMove=function(t){if(!this.selection.resizing)return!1;var e=this.editor.getMousePosition(),i=this.initial,s={x:e.x-i.mouseX,y:e.y-i.mouseY};if(0!==s.x||0!==s.y){var o=new THREE.Vector3(s.x,s.y,0),n=(new THREE.Matrix4).makeRotationZ(-this.selection.rotation);s=o.applyMatrix4(n);var r=i.x,a=i.y,h=i.width,l=i.height,u=new THREE.Vector3,d=this.selection.handle.resizing.getAttribute("data-sdp-handle");if(this.editor.input.keepAspectRatio&&-1!==["nw","ne","sw","se"].indexOf(d)){var c=new THREE.Vector3(s.x,s.y,0);switch(d){case"nw":s.set(-i.width,-i.height,0);break;case"ne":case"sw":s.set(i.width,-i.height,0);break;case"se":s.set(i.width,i.height,0)}s.normalize(),s=c.projectOnVector(s)}if({n:function(){l-=s.y,u.y=s.y},s:function(){l+=s.y,u.y=s.y},w:function(){h-=s.x,u.x=s.x},e:function(){h+=s.x,u.x=s.x},nw:function(){this.n(),this.w()},ne:function(){this.n(),this.e()},sw:function(){this.s(),this.w()},se:function(){this.s(),this.e()}}[d](),!(h<=this.markup.getMinWidth()||l<=this.markup.getMinHeight())){var p=(new THREE.Matrix4).makeRotationZ(this.selection.rotation),y=u.applyMatrix4(p),g=this.editor.positionFromClientToMarkups(r+.5*y.x,a+.5*y.y),v=this.editor.sizeFromClientToMarkups(h,l);return new ft(this.editor,this.markup,g,v.x,v.y).execute(),!0}}},Js._onResizeMouseUp=function(t){for(var e in this.selection.resizing=!1,this.selection.handle.resizing=null,this.containingDiv.style.cursor="",this.selection.handle)this.selection.handle[e]&&xo(this.selection.handle[e],!1);this.editor.closeActionGroup(),this.dispatchEvent({type:B}),this.onMouseMove=function(){},this.onMouseUp=function(){}},Js._onRotationMouseDown=function(t){this._handleRightClickDown(t)||ho(t.target)&&(this.editor.beginActionGroup(),this.selection.rotating=!0,vo=this.editor.getMousePosition(),go=this.selection.rotation||0,this.onMouseMove=this._onRotationMouseMove.bind(this),this.onMouseUp=this._onRotationMouseUp.bind(this),xo(t.target,!0),this.dispatchEvent({type:R}))},Js._onRotationMouseMove=function(t){if(!this.selection.rotating)return!1;var e=this.editor.getMousePosition(),i=this.markup.getClientPosition(),s=Eo(i,e)-Eo(i,vo)+go;if(this.editor.input.snapRotations){var o=as(22.5);s=Math.ceil(s/o)*o}return co.bind(this)(this.selection.x,this.selection.y,s),new Xs(this.editor,this.markup,s).execute(),!0},Js._onRotationMouseUp=function(t){this.selection.rotating=!1,go=null,vo=null,xo(this.selection.rotationHandle,!1),this.editor.closeActionGroup(),this.dispatchEvent({type:B})};var bo=Autodesk.Viewing.Private;function To(){Autodesk.Viewing.ToolInterface.call(this),this.names=["markups.core"],this.panTool=null,this.allowNav=!1,this.is2d=!1,this.coreExt=null,this.hotkeysEnabled=!0;var t=!1,e=!1;this.allowNavigation=function(t){this.allowNav=t},this.setCoreExtension=function(t){this.coreExt=t},this.setHotkeysEnabled=function(t){this.hotkeysEnabled=t},this.activate=function(t,e){this.panTool=e.toolController.getTool("pan"),this.panTool&&this.panTool.activate("pan"),this.is2d=e.model.is2d(),this.viewer=e},this.deactivate=function(t){this.panTool&&this.panTool.deactivate("pan")},this.handleKeyDown=function(i,s){if(!this.coreExt.editMode)return!1;if(!this.hotkeysEnabled)return!0;switch(s){case Autodesk.Viewing.KeyCode.CONTROL:t=!0;break;case Autodesk.Viewing.KeyCode.SHIFT:e=!0;break;case Autodesk.Viewing.KeyCode.x:t&&!this.allowNav&&this.coreExt.cut();break;case Autodesk.Viewing.KeyCode.c:t&&!this.allowNav&&this.coreExt.copy();break;case Autodesk.Viewing.KeyCode.v:t&&!this.allowNav&&this.coreExt.paste();break;case Autodesk.Viewing.KeyCode.d:t&&!this.allowNav&&(this.coreExt.copy(),this.coreExt.paste());break;case Autodesk.Viewing.KeyCode.z:!t||e||this.allowNav?t&&e&&!this.allowNav&&this.coreExt.redo():this.coreExt.undo();break;case Autodesk.Viewing.KeyCode.y:t&&!this.allowNav&&this.coreExt.redo();break;case Autodesk.Viewing.KeyCode.ESCAPE:this.coreExt.onUserCancel();break;case Autodesk.Viewing.KeyCode.BACKSPACE:case Autodesk.Viewing.KeyCode.DELETE:var o=this.coreExt.getSelection();o&&this.coreExt.deleteMarkup(o);break;case Autodesk.Viewing.KeyCode.F12:return!1}return!0},this.handleKeyUp=function(i,s){if(!this.coreExt.editMode)return!1;if(!this.hotkeysEnabled)return!0;switch(s){case Autodesk.Viewing.KeyCode.CONTROL:t=!1;break;case Autodesk.Viewing.KeyCode.SHIFT:e=!1}return!0},this.update=function(){return!!(this.allowNav&&this.panTool&&this.panTool.update)&&this.panTool.update()},this.handleSingleClick=function(t,e){return!this.allowNav||!(!this.panTool||!this.panTool.handleSingleClick)&&this.panTool.handleSingleClick(t,e)},this.handleDoubleClick=function(t,e){return!this.allowNav||!(!this.panTool||!this.panTool.handleDoubleClick)&&this.panTool.handleDoubleClick(t,e)},this.handleSingleTap=function(t){return!this.allowNav||!(!this.panTool||!this.panTool.handleSingleTap)&&this.panTool.handleSingleTap(t)},this.handleDoubleTap=function(t){return!this.allowNav||!(!this.panTool||!this.panTool.handleDoubleTap)&&this.panTool.handleDoubleTap(t)},this.handleWheelInput=function(t,e){return!this.allowNav&&!this.is2d||!(!this.panTool||!this.panTool.handleWheelInput)&&(this.coreExt.callSnapperMouseMove(),this.panTool.handleWheelInput(t,e))},this.handleButtonDown=function(t,e){return!(this.allowNav||this.is2d&&(bo.isRightClick(t,this.viewer.navigation)||bo.isMiddleClick(t)))||!(!this.panTool||!this.panTool.handleButtonDown)&&this.panTool.handleButtonDown(t,e)},this.handleButtonUp=function(t,e){return!(this.allowNav||this.is2d&&(bo.isRightClick(t,this.viewer.navigation)||bo.isMiddleClick(t)))||!(!this.panTool||!this.panTool.handleButtonUp)&&this.panTool.handleButtonUp(t,e)},this.handleMouseMove=function(t){return!this.allowNav&&!this.is2d||!(!this.panTool||!this.panTool.handleMouseMove)&&this.panTool.handleMouseMove(t)},this.handleGesture=function(t){return!this.allowNav&&!this.is2d||!(!this.panTool||!this.panTool.handleGesture)&&this.panTool.handleGesture(t)},this.handleBlur=function(t){return!this.allowNav||!(!this.panTool||!this.panTool.handleBlur)&&this.panTool.handleBlur(t)}}var Co={};var So=new class{constructor(){}register(t,e){if(t in Co)throw new Error(`EditMode with id (${t}) already registered.`);Co[t]=e}unregister(t){t in Co&&delete Co[t]}getClass(t){return Co[t]||null}getRegistered(){var t={};for(var e in Co)Object.prototype.hasOwnProperty.call(Co,e)&&(t[e]=Co[e]);return t}};So.register(r,$),So.register(a,Wt),So.register(h,at),So.register(l,ie),So.register(u,ce),So.register(d,Te),So.register(c,si),So.register(p,Ne),So.register(y,Ke),So.register(g,Lt),So.register(v,yi),So.register(f,wi);var Io=i(5072),zo=i.n(Io),Po=i(7825),Do=i.n(Po),Ho=i(7659),Lo=i.n(Ho),No=i(5056),Ro=i.n(No),Bo=i(540),Vo=i.n(Bo),Oo=i(1113),_o=i.n(Oo),Fo=i(4461),Uo={};Uo.styleTagTransform=_o(),Uo.setAttributes=Ro(),Uo.insert=Lo().bind(null,"head"),Uo.domAPI=Do(),Uo.insertStyleElement=Vo();zo()(Fo.A,Uo);Fo.A&&Fo.A.locals&&Fo.A.locals;var jo=Autodesk.Viewing.MeasureCommon,Go=1e3;function Wo(t,e){Autodesk.Viewing.Extension.call(this,t,e),this.options=this.options||{},this.markups=[],this.styles={},this.activeLayer="",this.duringViewMode=!1,this.duringEditMode=!1,this.svgLayersMap={},this.actionManager=new Ps(50),this.actionManager.addEventListener(D,this.onEditActionHistoryChanged.bind(this)),this.nextId=0,this.clipboard=new Ns(this),this.input=new Us,this.input.setGlobalManager(this.globalManager),this.createSvgElement=Li.bind(this),this.addSvgMetadata=Wi.bind(this),this.checkPolygon=Ms.bind(this),Qi(this);const i=t=>{t.is2d()&&(this.getStrokeWidth(),this.getFontWidth())};t.model?i(t.model):t.addEventListener(Autodesk.Viewing.MODEL_ADDED_EVENT,(e=>{let{model:s}=e;t.addEventListener(Autodesk.Viewing.CAMERA_CHANGE_EVENT,(()=>{i(s)}),{once:!0})}),{once:!0}),this.onCameraChangeBinded=this.onCameraChange.bind(this),this.onViewerResizeBinded=function(t){var e=this;e.onViewerResize(t),requestAnimationFrame((function(){e.duringViewMode&&e.onViewerResize(t)}))}.bind(this),this.onMarkupSelectedBinded=this.onMarkupSelected.bind(this),this.onMarkupEnterEditionBinded=this.onMarkupEnterEdition.bind(this),this.onMarkupCancelEditionBinded=this.onMarkupCancelEdition.bind(this),this.onMarkupDeleteEditionBinded=this.onMarkupDeleteEdition.bind(this),this.onToolChangeBinded=this.onToolChange.bind(this),this.onUnitsCalibrationStartsBinded=this.onUnitsCalibrationStarts.bind(this),t.addEventListener(jo.Events.UNITS_CALIBRATION_STARTS_EVENT,this.onUnitsCalibrationStartsBinded)}Wo.prototype=Object.create(Autodesk.Viewing.Extension.prototype),Wo.prototype.constructor=Wo;var Ko=Wo.prototype;Ko.load=async function(){var t=this.svg=this.createSvgElement("svg");Ni(t);const e=t.style;e.position="absolute",e.left="0",e.top="0",e.transform="scale(1, -1)",e.transformOrigin="center center",this.bounds={x:0,y:0,width:0,height:0},this.input.attachTo(this),this.editFrame=new Qs(this.viewer.container,this),this.editFrame.addEventListener(R,function(){this.disableMarkupInteractions(!0)}.bind(this)),this.editFrame.addEventListener(B,function(){this.disableMarkupInteractions(!1)}.bind(this));var i=this.options.markupToolClass||To;return this.changeMarkupTool(i,!this.options.markupDisableHotkeys),await this.viewer.loadExtension("Autodesk.Snapping"),this.snapper=new Autodesk.Viewing.Extensions.Snapping.Snapper(this.viewer,{markupMode:!0}),this.viewer.toolController.registerTool(this.snapper),!0},Ko.changeMarkupTool=function(t,e){this.markupTool&&(this.viewer.toolController.deregisterTool(this.markupTool),this.markupTool=null),this.markupTool=new t,this.markupTool.setCoreExtension(this),this.markupTool.setHotkeysEnabled(e),this.viewer.toolController.registerTool(this.markupTool)},Ko.unload=function(){this.hide(),this.input.detachFrom(this),this.editFrame.unload(),this.markupTool&&(this.viewer.toolController.deregisterTool(this.markupTool),this.markupTool=null),this.snapper&&(this.viewer.toolController.deregisterTool(this.snapper),this.snapper=null);var t=this.svg;return t&&this.onMouseDownBinded&&(t.removeEventListener("mousedown",this.onMouseDownBinded),this.onMouseDownBinded=null),t.parentNode&&t.parentNode.removeChild(t),this.editModeSvgLayerNode=null,this.svg=null,!0},Wo.prototype.getStrokeWidth=function(){return(!this.initialStrokeWidth||this.viewer.model&&!this.viewer.model.is2d())&&(this.initialStrokeWidth=this.sizeFromClientToMarkups(0,Ii).y),this.initialStrokeWidth},Wo.prototype.getFontWidth=function(){return(!this.initialFontWidth||this.viewer.model&&!this.viewer.model.is2d())&&(this.initialFontWidth=this.sizeFromClientToMarkups(0,zi).y),this.initialFontWidth},Wo.prototype.toggleEditMode=function(){this.duringEditMode?this.leaveEditMode():this.enterEditMode()},Wo.prototype.enterEditMode=function(t){function e(t,e){if(t)for(var i=t.markups,s=0;s<i.length;s++){i[s].disableInteractions(e)}}if(t&&!this.svgLayersMap[t])return console.warn("No such layer exists."),!1;if(!this.duringViewMode&&!this.show())return!1;if(!this.editModeSvgLayerNode){var i=this.createSvgElement("g");this.editModeSvgLayerNode={markups:[],svg:i},this.editModeSvgLayerNode.svg.setAttribute("cursor","default")}if(this.editModeSvgLayerNode.svg.parentNode==this.svg&&t||this.svg.appendChild(this.editModeSvgLayerNode.svg),this.svg.setAttribute("cursor","crosshair"),t){var s=this.svgLayersMap[t];if(s){var o=this.editModeSvgLayerNode.svg.parentNode;for(var n in o&&o.removeChild(this.editModeSvgLayerNode.svg),e(this.editModeSvgLayerNode,!0),this.svgLayersMap)for(var r=this.svgLayersMap[n].markups,a=0;a<r.length;a++){var h=r[a];n!==t.toString()?h.disableInteractions(!0):h.disableInteractions(!1)}this.activeLayer=t,this.editingLayer=t;var l=s.svg;l.parentNode&&this.svg.removeChild(l),this.markups=s.markups.slice(),this.svg.appendChild(l)}}else{if(this.editingLayer){for(var u=0;u<this.markups.length;u++){this.markups[u].disableInteractions(!0)}e(this.editModeSvgLayerNode,!1)}this.editingLayer="",this.editModeSvgLayerNode?this.markups=this.editModeSvgLayerNode.markups.slice():this.markups=[],this.activeLayer=""}return this.input.enterEditMode(),this.activateTool(!0),this.styles={},this.defaultStyle=null,this.duringEditMode=!0,this.changeEditMode(new $(this)),this.actionManager.clear(),this.dispatchEvent({type:b}),this.allowNavigation(!1),!0},Wo.prototype.leaveEditMode=function(){var t=!0;return this.duringEditMode&&this.duringViewMode?!!this.viewer&&(this.editMode.destroy(),this.editMode=null,this.duringEditMode=!1,this.snapper&&(this.snapper.indicator.clearOverlays(),this.snapper.clearSnapped()),this.editModeSvgLayerNode&&this.editModeSvgLayerNode.svg.parentNode&&this.svg.removeChild(this.editModeSvgLayerNode.svg),this.svg.setAttribute("cursor","default"),this.input.leaveEditMode(),this.editFrame.setMarkup(null),this.activateTool(!0),this.allowNavigation(!0),this.dispatchEvent({type:T}),t):t},Wo.prototype.toggle=function(){this.duringViewMode?this.hide():this.show()},Wo.prototype.show=function(){var t=this.viewer;if(!t||!t.model||!this.svg)return!1;if(this.duringViewMode||this.duringEditMode)return!0;t.addEventListener(Autodesk.Viewing.CAMERA_CHANGE_EVENT,this.onCameraChangeBinded),t.addEventListener(Autodesk.Viewing.VIEWER_RESIZE_EVENT,this.onViewerResizeBinded),t.container.appendChild(this.svg),t.reorderElements(this.svg),this.input.enterViewMode(),us(t),this.onViewerRolloverObject=t.impl.rolloverObject,t.impl.rolloverObject=function(){},this.activateTool(!0);var e=t.impl.camera;return this.onViewerResize({width:e.clientWidth,height:e.clientHeight}),this.svgLayersMap={},this.duringViewMode=!0,this.allowNavigation(!0),!0},Wo.prototype.hide=function(){var t=!0,e=this.viewer;if(!e||!this.duringViewMode)return t;if(this.duringEditMode&&!this.leaveEditMode())return!1;e.removeEventListener(Autodesk.Viewing.CAMERA_CHANGE_EVENT,this.onCameraChangeBinded),e.removeEventListener(Autodesk.Viewing.VIEWER_RESIZE_EVENT,this.onViewerResizeBinded);var i=this.svg;return i.parentNode&&i.parentNode.removeChild(i),this.unloadMarkupsAllLayers(),Yi(i),this.input.leaveViewMode(),ds(e),this.viewer.impl.rolloverObject=this.onViewerRolloverObject,this.activateTool(!1),this.duringViewMode=!1,t},Wo.prototype.clear=function(){if(this.duringEditMode){var t=this.editingLayer?this.svgLayersMap[this.editingLayer]:this.editModeSvgLayerNode;if(t){var e=t.markups,i=t.svg;if(i&&i.childNodes.length>0)for(;i.childNodes.length;)i.removeChild(i.childNodes[0]);for(;e.length>0;){var s=e[0];this.removeMarkup(s),s.destroy()}}}else console.warn("Clear only removes markups when in Edit Mode.")},Wo.prototype.generateData=function(){var t=this.editModeSvgLayerNode.svg;this.editMode&&this.editMode.onSave(),Yi(this.svg),this.activeLayer&&(t=this.svgLayersMap[this.activeLayer].svg);var e=this.createSvgElement("svg");Xi(this.svg,e),Xi(t,this.svg);var i=[this.addSvgMetadata(this.svg,{"data-model-version":"4"})];this.markups.forEach((function(t){var e=t.setMetadata();e&&i.push(e)}));var s=$i(this.svg);return i.forEach((function(t){t.parentNode.removeChild(t)})),Xi(this.svg,t),Xi(e,this.svg),e=null,s},Wo.prototype.generatePoints3d=function(){var t={markups:[],main:null},e=this.markups,i=e.length;if(0===i)return t;var s=this.viewer.impl.renderer().readbackTargetId();for(let r=0;r<i;++r){var o=e[r],n=o.generatePoint3d(s)||null;t.markups.push({id:o.id,type:o.type,point:n||null})}if(1===i){var a=t.markups[0].point;return t.main=a&&a.clone(),t}for(let e=0;e<i;++e){var h=t.markups[e];if(h.type===r&&null!==h.point)return t.main=h.point.clone(),t}var l=Number.POSITIVE_INFINITY,u=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY;for(let t=0;t<i;++t){var p=e[t].generateBoundingBox();l=Math.min(l,p.min.x),u=Math.min(u,p.min.y),d=Math.max(d,p.max.x),c=Math.max(c,p.max.y)}var y={vertexCount:4};y.xVertices=new Float32Array([l,d,d,l]),y.yVertices=new Float32Array([u,u,c,c]);var g=this.checkPolygon(y,s),v=g&&this.viewer.clientToWorld(g.x,g.y);return t.main=v&&v.point,t},Wo.prototype.renderToCanvas=function(t,e,i){var s,o=this.bounds.width,n=this.bounds.height,r=this.getSvgViewBox(o,n),a=0,h=[],l=function(){e&&++a===h.length&&e()}.bind(this);if(i)for(var u=Object.keys(this.svg.childNodes),d=Object.keys(this.svgLayersMap),c=0;c<u.length;c++)for(var p=0;p<d.length;p++)s=this.svgLayersMap[d[p]],this.svg.childNodes[u[c]]===s.svg&&(h=h.concat(s.markups));else s=this.svgLayersMap[this.activeLayer]||this.editModeSvgLayerNode,h=s.markups;0===h.length?e():h.forEach((function(e){e.renderToCanvas(t,r,o,n,l)}))},Wo.prototype.changeEditMode=function(t){var e=this.editMode;e&&e.destroy(),t.addEventListener(H,function(){this.disableMarkupInteractions(!0)}.bind(this)),t.addEventListener(L,function(){this.disableMarkupInteractions(!1)}.bind(this)),t.addEventListener(N,function(t){this.dispatchEvent(t)}.bind(this)),this.editMode=t,this.styles[t.type]=w(t.getStyle()),this.dispatchEvent({type:A,target:t})},Wo.prototype.isNavigationAllowed=function(){return!this.viewer.impl.camera.isPerspective},Wo.prototype.allowNavigation=function(t){var e=this.editMode;this.navigating=t,t?(this.svg.setAttribute("pointer-events","none"),e&&this.selectMarkup(null)):this.svg.setAttribute("pointer-events","painted");for(var i=this.markups,s=i.length,o=0;o<s;++o)i[o].updateStyle();if(e&&e.notifyAllowNavigation(t),t&&(this.duringEditMode||this.duringViewMode)&&!this.isNavigationAllowed())return!1;t&&this.snapper&&(this.snapper.indicator.clearOverlays(),this.snapper.clearSnapped()),this.markupTool.allowNavigation(t)},Wo.prototype.disableMarkupInteractions=function(t){this.editModeSvgLayerNode&&this.editModeSvgLayerNode.svg.setAttribute("cursor",t?"inherit":"default"),this.markups.forEach((function(e){e.disableInteractions(t)}))},Wo.prototype.activateTool=function(t){if(t)this.cachedNavigationTool||(this.cachedNavigationTool=this.viewer.getActiveNavigationTool(),this.viewer.addEventListener(Autodesk.Viewing.TOOL_CHANGE_EVENT,this.onToolChangeBinded)),this.viewer.setActiveNavigationTool(this.markupTool.getName());else{if(this.cachedNavigationTool)this.viewer.setActiveNavigationTool(this.cachedNavigationTool),this.cachedNavigationTool=null;else{var e=this.viewer.getDefaultNavigationToolName();this.viewer.setActiveNavigationTool(e)}this.viewer.removeEventListener(Autodesk.Viewing.TOOL_CHANGE_EVENT,this.onToolChangeBinded)}},Wo.prototype.onToolChange=function(t){if(t.toolName===this.markupTool.getName()){if(t.active){var e=this.isNavigationAllowed();this.viewer.setNavigationLockSettings({pan:e,zoom:e,orbit:!1,roll:!1,fov:!1,walk:!1,gotoview:!1})}this.viewer.setNavigationLock(t.active)}},Wo.prototype.onUnitsCalibrationStarts=function(){this.duringEditMode&&this.hide()},Ko.changeInputHandler=function(t){this.input.detachFrom(this),t.attachTo(this),this.input=t,this.duringEditMode&&t.enterEditMode(),this.duringViewMode&&t.enterViewMode()},Wo.prototype.copy=function(){this.clipboard.copy()},Wo.prototype.cut=function(){this.clipboard.cut()},Wo.prototype.paste=function(){this.clipboard.paste()},Wo.prototype.undo=function(){this.actionManager.undo()},Wo.prototype.redo=function(){this.actionManager.redo()},Wo.prototype.isUndoStackEmpty=function(){return this.actionManager.isUndoStackEmpty()},Wo.prototype.isRedoStackEmpty=function(){return this.actionManager.isRedoStackEmpty()},Ko.beginActionGroup=function(){this.actionManager.beginActionGroup()},Ko.closeActionGroup=function(){this.actionManager.closeActionGroup()},Ko.cancelActionGroup=function(){this.actionManager.cancelActionGroup()},Ko.getId=function(){return++this.nextId},Ko.onEditActionHistoryChanged=function(t){var e=t.data;if("undo"!==e.action&&-1!==e.targetId){let t=this.getMarkup(e.targetId);this.selectMarkup(t)}if("undo"===e.action&&!this.isUndoStackEmpty()){let t=this.getMarkup(this.actionManager.getLastElementInUndoStack().getTargetId());this.selectMarkup(t)}this.dispatchEvent(t)},Wo.prototype.getMarkup=function(t){for(var e=this.markups,i=e.length,s=0;s<i;++s)if(e[s].id==t)return e[s];return null},Wo.prototype.selectMarkup=function(t){if(t)if(this.editMode.type===t.type)this.editMode.setSelection(t);else{var e=t.getEditMode();e.setSelection(null),this.changeEditMode(e),this.setStyle(t.getStyle()),this.editMode.setSelection(t)}else this.editMode&&this.editMode.setSelection(null)},Wo.prototype.getSelection=function(){return this.editMode.getSelection()},Wo.prototype.deleteMarkup=function(t,e){(!this.editMode||this.editMode&&this.editMode.selectedMarkup.id!==t.id)&&(this.editMode=t.getEditMode()),this.editMode.deleteMarkup(t,e)},Ko.addMarkup=function(t){var e,i=this.activeLayer,s=this.svgLayersMap[i]||"";if(s){var o=s.svg;t.setParent(o),s.markups.push(t),e=s.markups.slice()}else t.setParent(this.editModeSvgLayerNode.svg),this.editModeSvgLayerNode.markups.push(t),e=this.editModeSvgLayerNode.markups.slice();t.addEventListener(C,this.onMarkupSelectedBinded),t.addEventListener(I,this.onMarkupEnterEditionBinded),t.addEventListener(z,this.onMarkupCancelEditionBinded),t.addEventListener(P,this.onMarkupDeleteEditionBinded),this.duringEditMode&&(this.markups=e)},Ko.removeMarkup=function(t){if(!t)return!1;var e=this;var i=function(t){var i,s=-1;if(e.editModeSvgLayerNode){var o=e.editModeSvgLayerNode.markups;if(-1!==(i=o.indexOf(t)))return o.splice(i,1),s=o.slice(),""===e.activeLayer&&(e.markups=s),s}if(e.svgLayersMap)for(var n in e.svgLayersMap){var r=e.svgLayersMap[n].markups;if(-1!==(i=r.indexOf(t)))return r.splice(i,1),s=r.slice(),e.activeLayer===n&&(e.markups=s),s}return s}(t);if(-1===i)return!1;t.setParent(null),t.removeEventListener(C,this.onMarkupSelectedBinded),t.removeEventListener(I,this.onMarkupEnterEditionBinded),t.removeEventListener(z,this.onMarkupCancelEditionBinded),t.removeEventListener(P,this.onMarkupDeleteEditionBinded);var s=this.editMode;s&&(s.getSelection()===t&&this.selectMarkup(null))},Wo.prototype.setStyle=function(t){var e=this.styles,i=this.editMode;M(t,e[i.type]),i.setStyle(e[i.type])},Wo.prototype.getStyle=function(){return w(this.styles[this.editMode.type])},Wo.prototype.getDefaultStyle=function(){return this.defaultStyle=this.defaultStyle||m(["stroke-width","font-size","font-family","font-style","font-weight","stroke-color","stroke-opacity","fill-color","text-data","fill-opacity"],this),this.defaultStyle},Ko.bringToFront=function(t){this.sendMarkupTo(t,this.markups.length-1)},Ko.sendToBack=function(t){this.sendMarkupTo(t,0)},Ko.bringForward=function(t){var e=this.markups.indexOf(t);this.sendMarkupTo(t,e+1)},Ko.bringBackward=function(t){var e=this.markups.indexOf(t);this.sendMarkupTo(t,e-1)},Ko.sendMarkupTo=function(t,e){var i=this.markups,s=i.indexOf(t);if(!(-1===s||e<0||e>=i.length))if(i.splice(s,1),e=s>e?e-1:e,i.splice(e,0,t),t.setParent(null),this.activeLayer){var o=this.svgLayersMap[this.activeLayer].svg;t.setParent(o)}else t.setParent(this.editModeSvgLayerNode.svg)},Wo.prototype.loadMarkups=function(t,e){if(this.duringEditMode)return console.warn("Markups will not be loaded during the edit mode"),!1;if(!this.duringViewMode)return!1;if(!e)return console.warn("loadMarkups failed; missing 2nd argument 'layerId'"),!1;var i=Zi(t);if(!i)return!1;if(e in this.svgLayersMap&&this.svg.childNodes.length>0)return console.warn("This layer is already loaded, will not load again."),!1;this.activeLayer=e;var s=this.svgLayersMap[e];s&&delete this.svgLayersMap[e],s={markups:[],svgString:t,svg:this.createLayerNode()},this.svgLayersMap[e]=s;for(var o=i.childNodes,n=0;n<o.length;n++){var r=o[n],a=fs(r,this);a&&this.duringEditMode&&this.editingLayer!==this.activeLayer&&a.disableInteractions(!0),a||"metadata"===r.localName||(s.svg.appendChild(r),n--,"function"==typeof r.setAttribute&&r.setAttribute("pointer-events","none"))}var h=this.svgLayersMap[this.activeLayer].svg;return this.svg.appendChild(h),this.duringEditMode&&this.editingLayer!==this.activeLayer&&(this.activeLayer=this.editingLayer,this.editingLayer&&(this.markups=this.svgLayersMap[this.activeLayer].markups.slice())),!0},Ko.createLayerNode=function(){var t=this.createSvgElement("g");return t.setAttribute("cursor","default"),t},Wo.prototype.revertLayer=function(t){if(!t)return console.warn("revertLayer failed because no layerId was supplied."),!1;var e=this.svgLayersMap[t];if(!e)return console.warn("The supplied layer does not exist."),!1;this.duringEditMode&&this.leaveEditMode();var i=this.markups.slice();this.markups=e.markups;var s=e.svgString;if(this.unloadMarkups(t),this.loadMarkups(s,t),this.editingLayer){if(this.editingLayer!==t){this.markups=i;var o=this.svgLayersMap[this.editingLayer];o&&(o.markups=i)}}else this.editModeSvgLayerNode&&(this.editModeSvgLayerNode.markups=i);if(this.editingLayer||0===this.editingLayer.length){var n=0===this.editingLayer.length?this.editModeSvgLayerNode.svg:this.svgLayersMap[this.editingLayer].svg;n.parentNode==this.svg&&(this.svg.removeChild(n),this.svg.appendChild(n))}return!0},Wo.prototype.unloadMarkups=function(t){if(!t)return console.warn("unloadMarkups failed; No layerId provided."),!1;var e=this.svgLayersMap[t];if(!e)return console.warn("No such layer exists to unload."),!1;for(var i=e.markups.slice(),s=i.length,o=0;o<s;o++){var n=i[o];this.removeMarkup(n),n.destroy()}return e.svg.parentNode===this.svg&&this.svg.removeChild(e.svg),delete this.svgLayersMap[t],this.activeLayer.toString()===t.toString()&&(this.activeLayer=""),this.editingLayer&&this.editingLayer.toString()===t.toString()&&(this.editingLayer="",this.duringEditMode&&this.leaveEditMode()),!0},Wo.prototype.unloadMarkupsAllLayers=function(){this.activeLayer="";var t,e=this;for(t in function(){if(e.editModeSvgLayerNode)for(var t=e.editModeSvgLayerNode.markups.slice(),i=t.length,s=0;s<i;s++){var o=t[s];e.removeMarkup(o),o.destroy()}}(),this.svgLayersMap)this.unloadMarkups(t)},Wo.prototype.hideMarkups=function(t){if(!t)return console.warn("hideMarkups failed; No layerId provided."),!1;var e=this.svgLayersMap[t];if(!e)return!1;var i=e.svg;return i.parentNode!=this.svg?(console.warn("Layer is already hidden."),!1):(this.svg.removeChild(i),!0)},Wo.prototype.showMarkups=function(t){if(!t)return console.warn("showMarkups failed; No layerId provided."),!1;var e=this.svgLayersMap[t];if(!e)return!1;var i=e.svg;this.svg.appendChild(i)},Ko.positionFromClientToMarkups=function(t,e){return this.clientToMarkups(t,e)},Ko.positionFromMarkupsToClient=function(t,e){return this.markupsToClient(t,e)},Ko.vectorFromClientToMarkups=function(t,e){var i=this.clientToMarkups(0,0),s=this.clientToMarkups(t,e);return{x:s.x-i.x,y:s.y-i.y}},Ko.vectorFromMarkupsToClient=function(t,e){var i=this.markupsToClient(0,0),s=this.markupsToClient(t,e);return{x:s.x-i.x,y:s.y-i.y}},Ko.sizeFromClientToMarkups=function(t,e){var i=this.clientToMarkups(0,0),s=this.clientToMarkups(t,e);return{x:Math.abs(s.x-i.x),y:Math.abs(s.y-i.y)}},Ko.sizeFromMarkupsToClient=function(t,e){var i=this.markupsToClient(0,0),s=this.markupsToClient(t,e);return{x:Math.abs(s.x-i.x),y:Math.abs(s.y-i.y)}},Ko.markupsToClient=function(t,e){var i=this.viewer.impl.camera,s=new THREE.Vector3(t,e,0);if(i.isPerspective){var o=this.viewer.impl.getCanvasBoundingClientRect();s.x=s.x/Go*(.5*o.height)+.5*o.width,s.y=-s.y/Go*(.5*o.height)+.5*o.height}else{s.applyMatrix4(i.matrixWorld),s.sub(i.position);var n=this.viewer.model&&this.viewer.model.getData().globalOffset;n&&s.sub(n),(s=ts(s,this.viewer,!1)).z=0}return s},Ko.clientToMarkups=function(t,e){var i=this.viewer.impl.camera,s=new THREE.Vector3(t,e,0);if(i.isPerspective){var o=this.viewer.impl.getCanvasBoundingClientRect();s.x=(s.x-.5*o.width)/(.5*o.height)*Go,s.y=-(s.y-.5*o.height)/(.5*o.height)*Go}else{s=es(s.x,s.y,0,this.viewer);var n=this.viewer.model&&this.viewer.model.getData().globalOffset;n&&s.add(n),s.add(i.position),s.applyMatrix4(i.matrixWorldInverse),s.z=0}return s},Ko.getSvgViewBox=function(t,e){var i=this.clientToMarkups(0,0),s=this.clientToMarkups(t,e),o=Math.min(i.x,s.x),n=Math.min(i.y,s.y);return[o,n,Math.max(i.x,s.x)-o,Math.max(i.y,s.y)-n].join(" ")},Ko.getBounds=function(){return this.bounds},Ko.getMousePosition=function(){return this.editMode.useWithSnapping()&&this.snapper&&this.snapper.isSnapped()?this.getSnapPosition():this.input.getMousePosition()},Ko.getSnapPosition=function(){var t=jo.getSnapResultPosition(this.snapper.getSnapResult(),this.viewer),e=this.project(t);return{x:e.x,y:e.y}},Ko.project=function(t){var e=this.viewer.navigation.getCamera(),i=this.viewer.navigation.getScreenViewport(),s=(new THREE.Vector3).copy(t);return s.project(e),new THREE.Vector3(Math.round((s.x+1)/2*i.width),Math.round((1-s.y)/2*i.height),s.z)},Ko.onCameraChange=function(){var t=this.getSvgViewBox(this.bounds.width,this.bounds.height);if("NaN NaN NaN NaN"!==t){this.svg&&this.svg.setAttribute("viewBox",t);var e=this.editMode;if(e){if(this.editFrame.isActive()){var i=e.getSelection();this.editFrame.setMarkup(i)}e.updateTextBoxStyle&&e.updateTextBoxStyle(),this.snapper&&e.useWithSnapping()&&this.snapper.indicator.render()}}},Ko.onViewerResize=function(t){this.bounds.x=0,this.bounds.y=0,this.bounds.width=t.width,this.bounds.height=t.height,this.svg&&(this.svg.setAttribute("width",this.bounds.width),this.svg.setAttribute("height",this.bounds.height)),this.onCameraChange()},Ko.callSnapperMouseDown=function(){if(this.editMode&&this.editMode.useWithSnapping()){var t=this.input.getMousePosition();this.snapper&&(this.snapper.onMouseDown(t),this.snapper.indicator.render())}else this.snapper&&(this.snapper.clearSnapped(),this.snapper.indicator.clearOverlays())},Ko.callSnapperMouseMove=function(){if(this.editMode&&this.editMode.useWithSnapping()){var t=this.input.getMousePosition();this.snapper&&(this.snapper.onMouseMove(t),this.snapper.indicator.render())}},Ko.onMouseMove=function(t){if(this.navigating)return!1;let e=!1;return this.editFrame.isActive()&&"mousemove"===t.type&&(e=this.editFrame.onMouseMove(t)),this.callSnapperMouseMove(),e=this.editMode&&this.editMode.onMouseMove(t)||e,e},Ko.onMouseDown=function(t){gs(),this.callSnapperMouseDown();var e=this.getBounds(),i=this.getMousePosition();i.x>=e.x&&i.x<=e.x+e.width&&i.y>=e.y&&i.y<=e.y+e.height&&this.editMode.onMouseDown(t),this.editMode.creating||t.target!==this.svg||this.selectMarkup(null),this.ignoreNextMouseUp=!1},Ko.onMouseUp=function(t){return!this.navigating&&(this.editFrame.isActive()?(this.editFrame.onMouseUp(t),!0):this.ignoreNextMouseUp?void 0:this.editMode.onMouseUp(t))},Ko.onMouseDoubleClick=function(t){this.navigating||this.editFrame.isActive()||this.editMode.onMouseDoubleClick(t)},Ko.onUserCancel=function(){this.editMode&&(this.editMode.creating?this.editMode.creationCancel():this.editMode.unselect())},Ko.onMarkupSelected=function(t){this.selectMarkup(t.markup),this.dispatchEvent(t)},Ko.onMarkupEnterEdition=function(){},Ko.onMarkupCancelEdition=function(){this.onUserCancel()},Ko.onMarkupDeleteEdition=function(t){this.removeMarkup(t.markup),this.editMode.deleteMarkup()},Autodesk.Viewing.theExtensionManager.registerExtension("Autodesk.Viewing.MarkupsCore",Wo);var Yo=i(4674),Xo={};Xo.styleTagTransform=_o(),Xo.setAttributes=Ro(),Xo.insert=Lo().bind(null,"head"),Xo.domAPI=Do(),Xo.insertStyleElement=Vo();zo()(Yo.A,Xo);Yo.A&&Yo.A.locals&&Yo.A.locals;function qo(t,e){Autodesk.Viewing.Extension.call(this,t,e),this.domEvents=[],this.name="markup",this.onEditModeEnter=this.onEditModeEnter.bind(this),this.onEditModeLeave=this.onEditModeLeave.bind(this),this.onEditModeChange=this.onEditModeChange.bind(this),this.onMarkupSelected=this.onMarkupSelected.bind(this)}qo.prototype=Object.create(Autodesk.Viewing.Extension.prototype),qo.prototype.constructor=qo;var $o=qo.prototype,Zo=Autodesk.Viewing.Private;$o.load=function(){return this.viewer.loadExtension("Autodesk.Viewing.MarkupsCore").then((t=>{this.core=t,this.core.addEventListener(b,this.onEditModeEnter),this.core.addEventListener(T,this.onEditModeLeave),this.core.addEventListener(A,this.onEditModeChange),this.core.addEventListener(C,this.onMarkupSelected)})),!0},$o.unload=function(){return this.deactivate(),this.unhookAllEvents(),this.core.removeEventListener(b,this.onEditModeEnter),this.core.removeEventListener(T,this.onEditModeLeave),this.core.removeEventListener(A,this.onEditModeChange),this.core.removeEventListener(C,this.onMarkupSelected),this.destroyToolUi(),this.destroyToolbarUI(),this.core=null,!0},$o.onToolbarCreated=function(t){var e=this;this.markupToolButton=new Autodesk.Viewing.UI.Button("toolbar-markupTool"),this.markupToolButton.setToolTip("Markup"),this.markupToolButton.setIcon("adsk-icon-markup"),this.markupToolButton.onClick=function(){e.activate()};var i=t.getControl(Autodesk.Viewing.TOOLBAR.MODELTOOLSID);i&&i.addControl(this.markupToolButton,{index:0})},$o.destroyToolbarUI=function(){this.markupToolButton&&(this.viewer.getToolbar()&&this.markupToolButton.removeFromParent(),this.markupToolButton=null)},$o.onEditModeEnter=function(){Zo.logger.log("ENTER edit mode"),this.showToolsUi()},$o.onEditModeLeave=function(){Zo.logger.log("LEAVE edit mode"),this.hideToolsUi()},$o.onEditModeChange=function(t){if(this.domToolSelect&&!this.ignoreChangeEvent)for(var e=this.core.editMode,i=this.domToolSelect.options,s=0,o=i.length;s<o;s++){if(i[s].value===e.type){this.domToolSelect.selectedIndex=s;break}}},$o.onMarkupSelected=function(t){var e=t.markup,i=this.core.editMode;this.setStylesUi(i,e)},$o.showToolsUi=function(){this.createToolsUi();var t=this.core.isNavigationAllowed();this.setControlVisibility(".lmv-markup-gui-enterNavMode",t,"inline-block"),this.exitNavigationMode(),this.domContent.style.display="block",this.viewer.container.appendChild(this.domRoot)},$o.hideToolsUi=function(){this.domRoot&&this.domRoot.parentNode&&this.domRoot.parentNode.removeChild(this.domRoot)},$o.createToolsUi=function(){if(this.domRoot)return;function t(t,e){return['<option value="',e,'">',t,"</option>"].join("")}var e=['<div class="lmv-markup-gui-toolbar-content">','<button class="lmv-markup-gui-collapse-btn">&lt;-&gt;</button>','<button class="lmv-markup-editmode-done">Exit</button>','<div class="lmv-markup-gui-collapse-content">','<div class="lmv-markup-gui-editMode">','<button class="lmv-markup-gui-enterNavMode">Navigate</button>','<button class="lmv-markup-gui-undo">&#8617;</button>','<button class="lmv-markup-gui-redo">&#8618;</button>',"<br>",'<button class="lmv-markup-gui-delete">Delete</button>','<button class="lmv-markup-gui-duplicate">Duplicate</button>',"<br>",'<button class="lmv-markup-gui-cut">Cut</button>','<button class="lmv-markup-gui-copy">Copy</button>','<button class="lmv-markup-gui-paste">Paste</button>',"<br>","<span>Markup:</span>",'<select class="lmv-markup-tool-select">',t("Arrow",r),t("Rectangle",h),t("Circle",l),t("Text",a),t("Callout",g),t("Cloud",u),t("PolyLine",p),t("Polycloud",y),t("Freehand",d),t("Highlight",c),t("Dimension",v),t("SVG Stamp",f),"</select>","<br>",'<div class="lmv-markup-gui-style-options"></div>',"</div>",'<div class="lmv-markup-gui-navMode" style="display:none;">','<button class="lmv-markup-gui-exitNavMode">Back to Markup</button>',"</div>","</div>","</div>"].join("");const i=this.getDocument();this.domRoot=i.createElement("div"),this.domRoot.className="lmv-markup-gui-toolbar",this.domRoot.innerHTML=e,this.domContent=this.domRoot.querySelector(".lmv-markup-gui-collapse-content"),this.domToolSelect=this.domRoot.querySelector(".lmv-markup-tool-select"),this.domStylesRoot=this.domRoot.querySelector(".lmv-markup-gui-style-options"),this.hookEvent("click",".lmv-markup-gui-collapse-btn",this.onToggleCollapse.bind(this)),this.hookEvent("click",".lmv-markup-editmode-done",this.onEditModeDone.bind(this)),this.hookEvent("click",".lmv-markup-gui-enterNavMode",this.enterNavigationMode.bind(this)),this.hookEvent("click",".lmv-markup-gui-exitNavMode",this.exitNavigationMode.bind(this)),this.hookEvent("click",".lmv-markup-gui-undo",this.onUndoClick.bind(this)),this.hookEvent("click",".lmv-markup-gui-redo",this.onRedoClick.bind(this)),this.hookEvent("click",".lmv-markup-gui-delete",this.onDeleteClick.bind(this)),this.hookEvent("click",".lmv-markup-gui-cut",this.onCutClick.bind(this)),this.hookEvent("click",".lmv-markup-gui-copy",this.onCopyClick.bind(this)),this.hookEvent("click",".lmv-markup-gui-paste",this.onPasteClick.bind(this)),this.hookEvent("click",".lmv-markup-gui-duplicate",this.onDuplicateClick.bind(this)),this.hookEvent("change",".lmv-markup-tool-select",this.onSelectEditMode.bind(this)),this.hookEvent("change",".lmv-markup-gui-style-select",this.onStyleChange.bind(this)),this.hookEvent("input",".lmv-markup-gui-style-textarea",this.onStyleChange.bind(this)),this.hookEvent("propertychange",".lmv-markup-gui-style-textarea",this.onStyleChange.bind(this)),this.setStylesUi(this.core.editMode)},$o.destroyToolUi=function(){this.domRoot&&(this.hideToolsUi(),this.domRoot=null)},$o.getEditMode=function(t){var e=So.getClass(t);return e?new e(this.core):null},$o.onToggleCollapse=function(){var t=this.domContent.style.display;this.domContent.style.display="none"===t?"block":"none"},$o.onEditModeDone=function(){this.deactivate()},$o.enterNavigationMode=function(){this.core.allowNavigation(!0),this.setControlVisibility(".lmv-markup-gui-editMode",!1),this.setControlVisibility(".lmv-markup-gui-navMode",!0)},$o.exitNavigationMode=function(){this.core.allowNavigation(!1),this.setControlVisibility(".lmv-markup-gui-editMode",!0),this.setControlVisibility(".lmv-markup-gui-navMode",!1)},$o.onUndoClick=function(){this.core.undo()},$o.onRedoClick=function(){this.core.redo()},$o.onDeleteClick=function(){var t=this.core.getSelection();t&&this.core.deleteMarkup(t)},$o.onCutClick=function(){this.core.cut()},$o.onCopyClick=function(){this.core.copy()},$o.onPasteClick=function(){this.core.paste()},$o.onDuplicateClick=function(){this.core.getSelection()&&(this.core.copy(),this.core.paste())},$o.onSelectEditMode=function(t){var e=t.target.value,i=this.getEditMode(e);i?i.cancelEditModeChange?Zo.logger.warn("There was a problem selecting current editMode"):(this.ignoreChangeEvent=!0,this.core.changeEditMode(i),this.ignoreChangeEvent=!1,this.setStylesUi(i),this.domToolSelect.blur()):Zo.logger.error("Markup editMode not found for type: "+e)},$o.onStyleChange=function(t){var e,i,s=t.target,o=s.getAttribute("style-key"),n=s.getAttribute("value-type"),r=this.core.getSelection(),a=r?r.getStyle():this.core.getStyle();if("string"===n)a[o]=s.value;else{var h=s.options[s.selectedIndex];a[o]=(e=h.value,"number"===(i=n)?Number(e):"boolean"===i?"true"===e:e),s.blur()}this.core.setStyle(a)},$o.setStylesUi=function(t,e){var i=e?e.style:t.style,s=E(i,this.core);for(var o in this.domStylesRoot.innerHTML="",s){var n=this.getUiForStyleKey(o,s[o],i[o]);this.domStylesRoot.appendChild(n)}},$o.getUiForStyleKey=function(t,e,i){for(var s=e.default,o=[],n=e.values,r=0,a=n.length;r<a;++r){var h=['<option value="',n[r].value,'">',n[r].name,"</option>"].join("");o.push(h),this.valueEquals(n[r].value,i)&&(s=r)}var l=typeof n[0].value;var u=this.getDocument().createElement("div"),d=[];let c=t.includes("text");(d=c?["<span>",t,"</span>","<br>",'<textarea class="lmv-markup-gui-style-textarea" style-key="',t,'" value-type="',l,'">',i||"","</textarea>"].join(""):["<span>",t,"</span>",'<select class="lmv-markup-gui-style-select" style-key="',t,'" value-type="',l,'">',o.join(""),"</select>"].join(""),u.innerHTML=d,c)||(u.querySelector("select").selectedIndex=s);return u},$o.valueEquals=function(t,e){return t===e},$o.setControlVisibility=function(t,e,i){i||(i="block"),this.domRoot.querySelector(t).style.display=e?i:"none"},$o.hookEvent=function(t,e,i){var s=function(t){this.matchesSelector(t.target,e)&&i(t)}.bind(this);this.domRoot.addEventListener(t,s),this.domEvents.push({str:t,handler:s})},$o.unhookAllEvents=function(){var t=this.domRoot;this.domEvents.forEach((function(e){t.removeEventListener(e.str,e.handler)})),this.domEvents=[]},$o.matchesSelector=function(t,e){return t.matches?t.matches(e):t.msMatchesSelector?t.msMatchesSelector(e):t.mozMatchesSelector?t.mozMatchesSelector(e):!!t.webkitMatchesSelector&&t.webkitMatchesSelector(e)},$o.getStyleOptions=function(t){var e=t.getStyle();return E(e,this.core)},$o.activate=function(){return this.activeStatus||(this.core.enterEditMode(),this.activeStatus=!0),!0},$o.deactivate=function(){return this.activeStatus&&(this.core.hide(),this.activeStatus=!1),!0},Autodesk.Viewing.theExtensionManager.registerExtension("Autodesk.Viewing.MarkupsGui",qo);const Qo={Clipboard:Ns,CloneMarkup:Hs,CreateArrow:tt,CreateCallout:Ot,CreateCircle:re,CreateCloud:ve,CreateDimension:xi,CreateFreehand:Ie,CreateHighlight:ri,CreatePolycloud:Ze,CreatePolyline:_e,CreateRectangle:dt,CreateText:$t,DeleteArrow:W,DeleteCallout:Ft,DeleteCircle:Qt,DeleteCloud:he,DeleteDimension:hi,DeleteFreehand:we,DeleteHighlight:Je,DeletePolycloud:Ue,DeletePolyline:Pe,DeleteRectangle:it,DeleteText:pt,DeleteStamp:Mi,EditAction:x,EditActionGroup:Is,EditActionManager:Ps,EditFrame:Qs,EditMode:j,EditModeArrow:$,EditModeCallout:Lt,EditModeCircle:ie,EditModeCloud:ce,EditModeDimension:yi,EditModeFreehand:Te,EditModeHighlight:si,EditModePen:Me,EditModePolycloud:Ke,EditModePolyline:Ne,EditModeRectangle:at,EditModeText:Wt,EditModeStamp:wi,EditorTextInput:zt,Markup:O,MarkupArrow:Q,MarkupCallout:Bt,MarkupCircle:oe,MarkupCloud:ye,MarkupDimension:vi,MarkupFreehand:Se,MarkupHighlight:ni,MarkupPen:xe,MarkupPolycloud:qe,MarkupPolyline:Ve,MarkupRectangle:lt,MarkupText:Xt,MarkupStamp:Ei,MarkupTool:To,MarkupsCore:Wo,SetArrow:Y,SetCallout:gt,SetCircle:te,SetCloud:ue,SetDimension:ui,SetFreehand:Ae,SetHighlight:ei,SetPolycloud:Ge,SetPolyline:He,SetPosition:Ks,SetRectangle:ot,SetRotation:Xs,SetSize:ft,SetStyle:F,SetText:jt,SetStamp:ki,MarkupEvents:o,MarkupTypes:t,theEditModeManager:So,Utils:n};for(var Jo in t)Qo[Jo]=t[Jo];for(var tn in o)Qo[tn]=o[tn];for(var en in e){if(en in Qo.Utils)throw new Error(`Property ${en} from StyleUtils already present in MarkupsCoreUtils.`);Qo.Utils[en]=e[en]}const sn={MarkupsGui:qo};Autodesk.Viewing.Extensions.Markups={Core:Qo}})(),Autodesk.Extensions.Markup=s})();
//# sourceMappingURL=Markup.min.js.map